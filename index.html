<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ai_dali_nadjib_emploi_cem â€” Ù†Ù‡Ø§Ø¦ÙŠ</title>

  <!-- Tailwind Play CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background: linear-gradient(180deg,#060617,#0b1220); color: #e6eef6; }
    /* Small overrides for table readability in dark */
    table { border-collapse: collapse; }
    th, td { border: 1px solid rgba(255,255,255,0.08); padding: 8px; text-align: center; }
    .editable:focus { outline: 2px dashed rgba(255,255,255,0.12); }
    .avatar { width:64px; height:64px; border-radius:9999px; object-fit:cover; border:3px solid #fff9; }
  </style>
</head>
<body class="antialiased">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between gap-6 mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-indigo-300">Ai_dali_nadjib_emploi_cem</h1>
        <p class="text-sm text-slate-300 mt-1">Ù…ÙˆÙ„Ø¯ Ù…ØªÙ‚Ø¯Ù… Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù† â€” Ø§Ø¶ØºØ· Â«Ù…Ø¤Ø³Ø³ØªÙŠÂ» Ø«Ù… Â«ØªÙˆÙ„ÙŠØ¯Â» â€” ÙƒÙ„ ØªÙˆÙ„ÙŠØ¯ ÙŠØ¹Ø·ÙŠ Ø§Ø­ØªÙ…Ø§Ù„Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.</p>
      </div>
      <div class="text-right flex items-center gap-4">
        <div class="text-sm">
          <div>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: <strong id="showInstitution">â€”</strong></div>
          <div>Ø§Ù„Ø£Ø³ØªØ§Ø° (Ù†Ù…ÙˆØ°Ø¬ÙŠ): <strong id="showTeacher">â€”</strong></div>
        </div>
        <div>
          <img id="avatar" src="" alt="avatar" class="avatar hidden">
          <div class="text-sm mt-2">
            <input id="imgFile" type="file" accept="image/*" class="hidden" />
            <button id="btnUpload" class="px-3 py-1 rounded bg-slate-600 hover:bg-slate-500 text-white text-sm">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
          </div>
        </div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left column: controls -->
      <section class="lg:col-span-1 space-y-4">
        <div class="bg-slate-800 p-4 rounded shadow">
          <h2 class="font-bold text-lg text-indigo-200">1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h2>
          <label class="block mt-2 text-sm text-slate-300">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <input id="institutionName" class="mt-1 w-full p-2 rounded bg-slate-700 text-white" placeholder="Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´" />

          <div class="grid grid-cols-2 gap-2 mt-3">
            <label class="text-sm">Ø³Ù†Ø© 1Ù… - Ø£Ù‚Ø³Ø§Ù…<input id="lvl1" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="5"></label>
            <label class="text-sm">Ø³Ù†Ø© 2Ù… - Ø£Ù‚Ø³Ø§Ù…<input id="lvl2" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="4"></label>
            <label class="text-sm">Ø³Ù†Ø© 3Ù… - Ø£Ù‚Ø³Ø§Ù…<input id="lvl3" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="3"></label>
            <label class="text-sm">Ø³Ù†Ø© 4Ù… - Ø£Ù‚Ø³Ø§Ù…<input id="lvl4" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="2"></label>
          </div>
          <div class="mt-2 text-sm text-slate-300">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: <strong id="totalClasses">14</strong></div>
        </div>

        <div class="bg-slate-800 p-4 rounded shadow">
          <h2 class="font-bold text-lg text-indigo-200">2. Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</h2>
          <p class="text-sm text-slate-300">Ø§Ø¶ØºØ· Â«Ù…Ø¤Ø³Ø³ØªÙŠÂ» Ù„Ù…Ù„Ø¡ Ø£Ù…Ø«Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„. (Ø§Ù„Ù†ØµØ§Ø¨ Ø§Ù„Ø£Ù‚ØµÙ‰: 20)</p>

          <div class="mt-3 max-h-56 overflow-auto">
            <table id="teachersTable" class="min-w-full text-sm">
              <thead><tr class="text-left text-slate-400"><th>Ø£Ø³ØªØ§Ø°</th><th>Ù…Ø§Ø¯Ø©</th><th>Ø£Ù‚Ø³Ø§Ù…</th><th>Ø³Ø§Ø¹Ø§Øª</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnMyInst" class="px-3 py-2 rounded bg-emerald-600">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ</button>
            <button id="btnReset" class="px-3 py-2 rounded bg-slate-600">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
            <button id="btnGenerate" class="px-3 py-2 rounded bg-indigo-600">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
            <button id="btnRegen" class="px-3 py-2 rounded bg-indigo-500">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯</button>
          </div>

          <div class="mt-3 text-xs text-slate-300 space-y-1">
            <div>Ø£Ù„ÙˆØ§Ù†: <span class="px-2 py-1 rounded bg-green-200 text-black">Ø±Ø³Ù…ÙŠØ©</span> <span class="px-2 py-1 rounded bg-yellow-200 text-black">Ø§Ø³ØªØ¯Ø±Ø§Ùƒ</span> <span class="px-2 py-1 rounded bg-violet-200 text-black">ÙØ±Ø§Øº</span> <span class="px-2 py-1 rounded bg-amber-200 text-black">Ø±Ø§Ø­Ø©</span></div>
            <div class="text-amber-200 font-semibold">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØ­Ø§ÙˆÙ„ Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø§Ø±Ø¶Ø§Øª ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ±Ø§ØºØ§Øª.</div>
          </div>
        </div>

        <div class="bg-slate-800 p-4 rounded shadow">
          <h2 class="font-bold text-lg text-indigo-200">3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠØ©</h2>
          <div class="grid grid-cols-2 gap-2 text-sm mt-2">
            <label>Ø±ÙŠØ§Ø¶ÙŠØ§Øª<select id="pdMath" class="p-2 rounded bg-slate-700"><option>Ø§Ù„Ø®Ù…ÙŠØ³</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option></select></label>
            <label>Ø¹Ø±Ø¨ÙŠØ©<select id="pdArabic" class="p-2 rounded bg-slate-700"><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option></select></label>
            <label>ÙØ±Ù†Ø³ÙŠØ©<select id="pdFrench" class="p-2 rounded bg-slate-700"><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option></select></label>
            <label>Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©<select id="pdEng" class="p-2 rounded bg-slate-700"><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option></select></label>
            <label>Ø¹Ù„ÙˆÙ…<select id="pdSci" class="p-2 rounded bg-slate-700"><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option></select></label>
            <label>ÙÙŠØ²ÙŠØ§Ø¡<select id="pdPhy" class="p-2 rounded bg-slate-700"><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option></select></label>
          </div>
        </div>

        <div class="bg-slate-800 p-4 rounded shadow text-sm">
          <h3 class="font-semibold text-indigo-200">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯</h3>
          <pre id="diagnostic" class="text-xs text-amber-200 min-h-[70px]">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯.</pre>
          <div class="mt-2 flex gap-2">
            <button id="btnCopy" class="px-3 py-2 rounded bg-sky-600">ğŸ“‹ Ù†Ø³Ø® HTML</button>
            <button id="btnCSV" class="px-3 py-2 rounded bg-sky-700">ğŸ“Š Excel (CSV)</button>
            <button id="btnWord" class="px-3 py-2 rounded bg-sky-500">ğŸ“ƒ Word</button>
            <button id="btnPDF" class="px-3 py-2 rounded bg-sky-400">ğŸ“„ PDF</button>
          </div>
        </div>
      </section>

      <!-- Middle: output -->
      <section class="lg:col-span-2 space-y-4">
        <div id="outputArea" class="bg-slate-900 p-4 rounded shadow min-h-[160px]">
          <p class="text-slate-400">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„Â».</p>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-400">
      ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø®Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ø§Ù†Ù‚Ø± ÙˆØ§ÙƒØªØ¨). Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©. Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†ØµØ§Ø¨ Ø£Ùˆ ØªÙƒØ±Ø§Ø± Ø³Ø§Ø¹ØªÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø§Ø¯Ø© ÙŠÙˆÙ…Ø§Ù‹ ÙØ³ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø©.
    </footer>
  </div>

  <!-- Libraries for PDF (dynamic load when needed) -->
  <script>
  /* ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ø§Ø¨ØªØ© ÙˆÙ‚ÙˆØ§Ø¹Ø¯ ==========
     - Ø³Ø§Ø¹Ø§Øª: 08:00-09:00 ... 15:00-16:00
     - Ø§Ø³ØªØ±Ø§Ø­Ø© 12:00-13:00
     - Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ Ù†ØµÙ ÙŠÙˆÙ… (Ø¨Ø¹Ø¯ 12:00 ÙØµÙˆÙ„ Ù‚ØµÙŠØ±Ø©)
     - Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…ÙØ¶Ù„Ø© ØµØ¨Ø§Ø­Ù‹Ø§
     - Ù†ØµØ§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ø£Ù‚ØµÙ‰ 20
     - Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©: Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© + backtracking Ù„Ø­Ù„ Ù‚ÙŠÙˆØ¯ÙŠ
  ========== */

  const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
  const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
  const BREAK = '12:00-13:00';
  const MAX_TEACHER = 20;

  // Ø³Ø§Ø¹Ø§Øª Ø±Ø³Ù…ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª: subjectHours[subject][level]
  const subjectHours = {
    'Ø±ÙŠØ§Ø¶ÙŠØ§Øª': {'1':4,'2':4,'3':5,'4':5},
    'Ø¹Ø±Ø¨ÙŠØ©': {'1':4,'2':4,'3':4,'4':4},
    'ÙØ±Ù†Ø³ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
    'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
    'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
    'ÙÙŠØ²ÙŠØ§Ø¡': {'1':2,'2':2,'3':2,'4':2},
    'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§': {'1':2,'2':2,'3':2,'4':2},
    'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©': {'1':1,'2':1,'3':1,'4':1},
    'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©': {'1':2,'2':2,'3':2,'4':2},
    'Ø±ÙŠØ§Ø¶Ø©': {'1':2,'2':2,'3':2,'4':2},
    'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ': {'1':1,'2':1,'3':1,'4':0},
    'Ø±Ø³Ù…': {'1':1,'2':1,'3':1,'4':1}
  };

  // pedagogical default
  let pedagogicalDays = {
    'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¹Ø±Ø¨ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','ÙØ±Ù†Ø³ÙŠØ©':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','ÙÙŠØ²ÙŠØ§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø±Ø³Ù…':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'
  };

  // current state
  let teachers = []; // array of {name,subject,sections:[],hours,totalAssigned}
  let institution = { name:'', levels: {1:5,2:4,3:3,4:2} };
  let lastSchedule = null;

  // Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
  function deepClone(v){ return JSON.parse(JSON.stringify(v)); }

  // UI wiring
  $('#btnUpload').addEventListener('click',()=> $('#imgFile').click());
  $('#imgFile').addEventListener('change',(e)=> {
    const f = e.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f); $('#avatar').src = url; $('#avatar').classList.remove('hidden');
  });

  $('#lvl1').addEventListener('change',updateTotal);
  $('#lvl2').addEventListener('change',updateTotal);
  $('#lvl3').addEventListener('change',updateTotal);
  $('#lvl4').addEventListener('change',updateTotal);

  $('#btnMyInst').addEventListener('click', loadMyInstitution);
  $('#btnReset').addEventListener('click', ()=> { if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† (ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„)ØŸ')) resetAll(); });
  $('#btnGenerate').addEventListener('click', ()=> generateAll());
  $('#btnRegen').addEventListener('click', ()=> regenerate());
  $('#btnCopy').addEventListener('click', copyHTML);
  $('#btnCSV').addEventListener('click', exportCSV);
  $('#btnWord').addEventListener('click', exportWord);
  $('#btnPDF').addEventListener('click', exportPDF);

  updateTotal();
  renderTeachersUI();

  // build sections list from levels
  function buildSections(){
    const arr = [];
    const l1 = parseInt($('#lvl1').value||0);
    const l2 = parseInt($('#lvl2').value||0);
    const l3 = parseInt($('#lvl3').value||0);
    const l4 = parseInt($('#lvl4').value||0);
    for(let i=1;i<=l1;i++) arr.push(`1Ù…${i}`);
    for(let i=1;i<=l2;i++) arr.push(`2Ù…${i}`);
    for(let i=1;i<=l3;i++) arr.push(`3Ù…${i}`);
    for(let i=1;i<=l4;i++) arr.push(`4Ù…${i}`);
    return arr;
  }

  function updateTotal(){
    const total = ['#lvl1','#lvl2','#lvl3','#lvl4'].reduce((acc,sel)=> acc + (parseInt($(sel).value||0)),0);
    $('#totalClasses').innerText = total;
  }

  // render teachers table
  function renderTeachersUI(){
    const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
    teachers.forEach((t,i)=>{
      const tr = document.createElement('tr');
      tr.className = 'align-top';
      const secs = (t.sections && t.sections.length) ? t.sections.join(',') : 'â€”';
      tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${secs}</td><td class="p-2">${t.hours}</td><td class="p-2"><button class="px-2 py-1 bg-red-600 rounded text-xs" onclick="deleteTeacher(${i})">Ø­Ø°Ù</button></td>`;
      tbody.appendChild(tr);
    });
  }

  window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); }

  // load your institution defaults
  function loadMyInstitution(){
    resetAll(false);
    institution.name = 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
    $('#institutionName').value = institution.name;
    $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2;
    updateTotal();

    teachers = [
      {name:'Ù†Ø¬ÙŠØ¨',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:20,totalAssigned:0},
      {name:'Ù…Ù†ÙŠØ±Ø©',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
      {name:'Ø±Ù…Ø²ÙŠ',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
      {name:'Ø£Ù…Ø§Ù„',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},

      {name:'ØµØ¨Ø±ÙŠÙ†Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
      {name:'Ù…Ø±ÙˆØ©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
      {name:'Ø³Ø§Ø±Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
      {name:'ÙˆØ­ÙŠØ¯',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},
      {name:'Ø¹Ø§Ù…Ø±',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},

      {name:'Ø§Ù„Ø¹ÙŠØ¯',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
      {name:'Ø³Ù„Ù…Ù‰',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
      {name:'Ø³Ø§Ø±Ø©_Ù',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},

      {name:'Ø¨ÙˆØ¨ÙƒØ±',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
      {name:'Ù‡Ø´Ø§Ù…',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
      {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ù†',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:14,totalAssigned:0},

      {name:'Ø¹Ø§Ø¦Ø´Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:12,totalAssigned:0},
      {name:'ÙØ§Ø·Ù…Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},
      {name:'Ø£Ù…Ø§Ù„_Øª',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},

      {name:'ÙˆØ³ÙŠÙ„Ø©',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},
      {name:'Ø·Ø§ÙˆØ³',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},

      {name:'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:12,totalAssigned:0},
      {name:'Ø£Ù…ÙŠÙ†Ø©_ÙÙŠ',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:10,totalAssigned:0},

      {name:'Ø¹Ù„Ø§Ø¡',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},
      {name:'Ø³Ù…ÙŠØ±',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},

      {name:'Ø³Ø¹ÙŠØ¯',subject:'Ø±Ø³Ù…',sections:[],hours:6,totalAssigned:0},
      {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ø¹Ù„Ø§Ù…',subject:'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ',sections:[],hours:6,totalAssigned:0},
      {name:'Ù…Ø¹Ù„Ù…_Ø§Ø³Ù„Ø§Ù…ÙŠ',subject:'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©',sections:[],hours:8,totalAssigned:0}
    ];

    $('#showInstitution').innerText = institution.name;
    $('#showTeacher').innerText = 'Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨ â€” Ø±ÙŠØ§Ø¶ÙŠØ§Øª';
    renderTeachersUI();
    $('#diagnostic').innerText = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙƒ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.';
  }

  // reset UI & data
  function resetAll(clearUI=true){
    teachers = [];
    institution = { name:'', levels:{1:0,2:0,3:0,4:0} };
    $('#institutionName').value = '';
    $('#lvl1').value='0'; $('#lvl2').value='0'; $('#lvl3').value='0'; $('#lvl4').value='0';
    updateTotal();
    $('#showInstitution').innerText = 'â€”';
    $('#showTeacher').innerText = 'â€”';
    $('#outputArea').innerHTML = '<p class="text-slate-400">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.</p>';
    $('#diagnostic').innerText = 'ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº.';
    if(clearUI) renderTeachersUI();
  }

  // core generator: randomized multi-trial + backtracking heuristic
  function generateAll(){
    // read settings
    institution.name = $('#institutionName').value || 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
    pedagogicalDays['Ø±ÙŠØ§Ø¶ÙŠØ§Øª'] = $('#pdMath').value || pedagogicalDays['Ø±ÙŠØ§Ø¶ÙŠØ§Øª'];
    pedagogicalDays['Ø¹Ø±Ø¨ÙŠØ©'] = $('#pdArabic').value || pedagogicalDays['Ø¹Ø±Ø¨ÙŠØ©'];
    pedagogicalDays['ÙØ±Ù†Ø³ÙŠØ©'] = $('#pdFrench').value || pedagogicalDays['ÙØ±Ù†Ø³ÙŠØ©'];
    pedagogicalDays['Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'] = $('#pdEng').value || pedagogicalDays['Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'];
    pedagogicalDays['Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©'] = $('#pdSci').value || pedagogicalDays['Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©'];
    pedagogicalDays['ÙÙŠØ²ÙŠØ§Ø¡'] = $('#pdPhy').value || pedagogicalDays['ÙÙŠØ²ÙŠØ§Ø¡'];

    const sections = buildSections();
    if(sections.length===0){ alert('Ù„Ø§ Ø£Ù‚Ø³Ø§Ù… Ù…Ø­Ø¯Ø¯Ø©. Ø§Ø¶ØºØ· Ù…Ø¤Ø³Ø³ØªÙŠ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….'); return; }
    if(teachers.length===0){ if(confirm('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙØ§Ø±ØºØ©. ØªØ­Ù…ÙŠÙ„ Ù…Ø¤Ø³Ø³ØªÙŠØŸ')) loadMyInstitution(); else return; }

    // compute requirements per section
    const req = {};
    sections.forEach(sec=>{
      const lvl = sec.charAt(0);
      req[sec] = {};
      for(const subj in subjectHours){
        const h = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
        if(h>0) req[sec][subj] = h;
      }
      // special: 4th grade no info sys
      if(sec.startsWith('4') && req[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']) delete req[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ'];
      if(sec.startsWith('4') && !req[sec]['Ø±Ø³Ù…']) req[sec]['Ø±Ø³Ù…'] = 1;
    });

    // teacher index snapshot
    const MAX_TRIALS = 500;
    let best = null;
    let diag = '';

    // schedule template
    function makeSchedule() {
      const S = {};
      sections.forEach(sec=>{
        S[sec] = {};
        for(const d of DAYS){ S[sec][d] = {}; for(const s of SLOTS) S[sec][d][s] = null; }
      });
      return S;
    }

    // teacher busy map
    function makeBusy() {
      const busy = {};
      teachers.forEach(t=>{ busy[t.name] = {}; for(const d of DAYS){ busy[t.name][d] = {}; for(const s of SLOTS) busy[t.name][d][s] = false; } });
      return busy;
    }

    // candidate teachers selection
    function candidateTeachers(subject, section, tstate){
      const cand = tstate.filter(x=> x.subject === subject);
      // prefer those assigned to the section (if sections set) or with less assigned
      cand.sort((a,b)=>{
        const aHas = a.sections && a.sections.includes(section);
        const bHas = b.sections && b.sections.includes(section);
        if(aHas && !bHas) return -1;
        if(!aHas && bHas) return 1;
        return (a.totalAssigned||0) - (b.totalAssigned||0);
      });
      return cand;
    }

    // trial loop
    const sectionsShuffledBase = sections.slice();
    outer:
    for(let trial=0; trial<MAX_TRIALS; trial++){
      // prepare
      const schedule = makeSchedule();
      const tstate = teachers.map(t=> ({...t, totalAssigned:0}));
      const busy = makeBusy();
      shuffle(sectionsShuffledBase);
      let failed = false;

      // allocate per section
      for(const sec of sectionsShuffledBase){
        const lvl = sec.charAt(0);
        // subject order by need desc
        const subjects = Object.keys(req[sec]).sort((a,b)=> req[sec][b] - req[sec][a]);
        // recursive assignment per subject
        function assignSubject(idx){
          if(idx>=subjects.length) return true;
          const subj = subjects[idx];
          let need = req[sec][subj];
          // build candidate slots: respect pedagogy and Tuesday half day and break
          const slotCandidates = [];
          for(const d of DAYS){
            if(pedagogicalDays[subj] && pedagogicalDays[subj] === d) continue;
            const orderSlots = (subj==='Ø±ÙŠØ§Ø¶ÙŠØ§Øª') ? ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'] : SLOTS.slice();
            for(const s of orderSlots){
              if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && ['13:00-14:00','14:00-15:00','15:00-16:00'].includes(s)) continue;
              if(s===BREAK) continue;
              slotCandidates.push({d,s});
            }
          }
          shuffle(slotCandidates);

          const chosen = [];
          function placeOne(k){
            if(k>=need) return true;
            for(const ds of slotCandidates){
              const {d,s} = ds;
              if(schedule[sec][d][s]) continue; // slot taken for this section
              // avoid >2 same subj in same day for same section
              const sameDay = SLOTS.reduce((a,sl)=> a + (schedule[sec][d][sl] && schedule[sec][d][sl].subj===subj ? 1:0), 0);
              if(sameDay>=2) continue;
              // find teacher
              const cands = candidateTeachers(subj, sec, tstate);
              shuffle(cands);
              for(const cand of cands){
                if(cand.totalAssigned >= cand.hours) continue;
                if(cand.totalAssigned >= MAX_TEACHER) continue;
                if(busy[cand.name][d][s]) continue;
                // assign
                schedule[sec][d][s] = { subj, teacher: cand.name, type: 'official' };
                cand.totalAssigned++;
                busy[cand.name][d][s] = true;
                chosen.push({d,s,cand:cand.name});
                if(placeOne(k+1)) return true;
                // backtrack
                const r = chosen.pop();
                schedule[sec][r.d][r.s] = null;
                const t = tstate.find(x=>x.name===r.cand); if(t) t.totalAssigned--;
                busy[r.cand][r.d][r.s] = false;
              }
            }
            return false;
          }
          const ok = placeOne(0);
          if(!ok) return false;
          return assignSubject(idx+1);
        }

        const ok = assignSubject(0);
        if(!ok){ failed = true; break; }
      } // end sections

      if(!failed){
        // verify all needs met & no teacher > MAX
        let okAll = true;
        for(const sec of sections){
          for(const subj in req[sec]){
            const need = req[sec][subj];
            const got = DAYS.reduce((a,d)=> a + SLOTS.reduce((x,s)=> x + (schedule[sec][d][s] && schedule[sec][d][s].subj===subj ? 1:0),0), 0);
            if(got < need){ okAll = false; break; }
          }
          if(!okAll) break;
        }
        if(!okAll) continue;
        if(tstate.some(t=> t.totalAssigned > MAX_TEACHER)){ continue; }
        // success
        best = schedule;
        // update teachers assigned counts
        teachers.forEach(t=> t.totalAssigned = 0);
        for(const sec of sections){
          for(const d of DAYS) for(const s of SLOTS){
            const c = best[sec][d][s];
            if(c){
              const t = teachers.find(x=> x.name===c.teacher);
              if(t) t.totalAssigned = (t.totalAssigned||0) + 1;
            }
          }
        }
        break outer;
      }
    } // end trials

    if(!best){
      $('#diagnostic').innerText = 'ÙØ´Ù„ Ø¥ÙŠØ¬Ø§Ø¯ Ø­Ù„ ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. Ø­Ø§ÙˆÙ„ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø§ØªØ°Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†ØµØ§Ø¨ Ø£Ùˆ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ù†ÙŠØ©.';
      renderResult(null, buildSections());
      return;
    }

    lastSchedule = best;
    $('#diagnostic').innerText = 'ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø¶ØºØ· Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ (ğŸ”) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ù„ Ø¢Ø®Ø±.';
    renderResult(best, buildSections());
  }

  function regenerate(){ generateAll(); }

  // render results
  function renderResult(schedule, sections){
    const out = $('#outputArea');
    out.innerHTML = '';
    const header = document.createElement('div');
    header.innerHTML = `<div class="flex items-center justify-between mb-3"><div><h2 class="text-xl text-indigo-300 font-semibold">${$('#institutionName').value || 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´'}</h2><div class="text-sm text-slate-300">Ø£Ù‚Ø³Ø§Ù…: ${sections.join(', ')}</div></div><div class="text-sm"><button class="px-3 py-1 rounded bg-green-600" onclick="document.getElementById('btnCSV').click()">Ø§Ø³ØªØ®Ø±Ø§Ø¬ CSV</button></div></div>`;
    out.appendChild(header);

    if(!schedule){
      const p = document.createElement('p'); p.className='text-slate-300'; p.textContent = 'Ù„Ù… ÙŠÙÙˆÙ„Ù‘ÙØ¯ Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø£Ùˆ Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø­Ù„.'; out.appendChild(p); return;
    }

    // institution summary (per day)
    for(const d of DAYS){
      const dayTitle = document.createElement('h3'); dayTitle.className = 'text-lg mt-4 text-indigo-200'; dayTitle.textContent = d; out.appendChild(dayTitle);
      const tableWrap = document.createElement('div'); tableWrap.className = 'overflow-auto';
      let html = `<table class="schedule-table w-full bg-white text-black"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
      sections.forEach(s=> html += `<th class="slot">${s}</th>`);
      html += `</tr></thead><tbody>`;
      for(const slot of SLOTS){
        html += `<tr><td>${slot}</td>`;
        for(const sec of sections){
          const cell = schedule[sec] && schedule[sec][d] ? schedule[sec][d][slot] : null;
          if(cell){
            html += `<td contenteditable="true" class="editable" data-sec="${sec}" data-day="${d}" data-slot="${slot}"><strong>${cell.subj}</strong><br/><small>${cell.teacher}</small></td>`;
          } else {
            if(slot==='13:00-14:00') html += `<td contenteditable="true" class="editable">Ø±Ø§Ø­Ø©</td>`;
            else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true">â€”</td>`;
            else html += `<td contenteditable="true" class="editable">ÙØ±Ø§Øº</td>`;
          }
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
      out.appendChild(tableWrap);
    }

    // students per section (compact)
    const sectionsDiv = document.createElement('div'); sectionsDiv.className='mt-6';
    sectionsDiv.innerHTML = `<h3 class="text-lg text-indigo-200">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° (Ø£Ù‚Ø³Ø§Ù…)</h3>`;
    for(const sec of sections){
      let secHTML = `<h4 class="mt-2 font-semibold">${sec}</h4><div class="overflow-auto"><table class="schedule-table w-full bg-white text-black"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
      DAYS.forEach(d=> secHTML += `<th>${d}</th>`);
      secHTML += `</tr></thead><tbody>`;
      for(const slot of SLOTS){
        secHTML += `<tr><td>${slot}</td>`;
        for(const d of DAYS){
          const cell = schedule[sec] && schedule[sec][d] ? schedule[sec][d][slot] : null;
          if(cell) secHTML += `<td contenteditable="true" class="editable official">${cell.subj}<br/><small>${cell.teacher}</small></td>`;
          else {
            if(slot==='13:00-14:00') secHTML += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
            else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) secHTML += `<td contenteditable="true">â€”</td>`;
            else secHTML += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
          }
        }
        secHTML += `</tr>`;
      }
      secHTML += `</tbody></table></div>`;
      sectionsDiv.insertAdjacentHTML('beforeend', secHTML);
    }
    out.appendChild(sectionsDiv);

    // teachers schedules
    const teachDiv = document.createElement('div'); teachDiv.className = 'mt-6';
    teachDiv.innerHTML = `<h3 class="text-lg text-indigo-200">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h3>`;
    for(const t of teachers){
      let tHTML = `<h4 class="mt-2 font-semibold">${t.name} â€” ${t.subject} (Ù†ØµØ§Ø¨: ${t.hours})</h4><div class="overflow-auto"><table class="schedule-table w-full bg-white text-black"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
      DAYS.forEach(d=> tHTML += `<th>${d}</th>`); tHTML += `</tr></thead><tbody>`;
      for(const s of SLOTS){
        tHTML += `<tr><td>${s}</td>`;
        for(const d of DAYS){
          // search if this teacher teaches any section at this day & slot
          let found = null;
          for(const sec of sections){
            const c = schedule[sec] && schedule[sec][d] ? schedule[sec][d][s] : null;
            if(c && c.teacher === t.name){ found = {sec,c}; break; }
          }
          if(found) tHTML += `<td contenteditable="true" class="editable official">${found.sec}<br/><small>${found.c.subj}</small></td>`;
          else {
            if(s==='13:00-14:00') tHTML += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
            else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4) tHTML += `<td contenteditable="true">â€”</td>`;
            else tHTML += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
          }
        }
        tHTML += `</tr>`;
      }
      tHTML += `</tbody></table></div>`;
      teachDiv.insertAdjacentHTML('beforeend', tHTML);
    }
    out.appendChild(teachDiv);

    // scroll to output
    setTimeout(()=> window.scrollTo({top: out.offsetTop - 20, behavior:'smooth'}), 60);
  }

  // simple copy html
  function copyHTML(){
    const out = $('#outputArea');
    navigator.clipboard.writeText(out.innerHTML).then(()=> alert('ØªÙ… Ù†Ø³Ø® HTML'));
  }

  // export CSV (concatenate tables)
  function exportCSV(){
    const out = $('#outputArea');
    if(!out.innerHTML.trim()){ alert('Ù„Ø§ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    const tables = out.querySelectorAll('.schedule-table');
    let csv = '';
    tables.forEach((table,idx)=>{
      const caption = table.previousElementSibling ? table.previousElementSibling.innerText.replace(/\n/g,' ') : `Table ${idx+1}`;
      csv += `"${caption}"\n`;
      for(const row of table.rows){
        const cells = Array.from(row.cells).map(c => '"' + c.innerText.replace(/"/g,'""').replace(/\n/g,' / ') + '"');
        csv += cells.join(',') + '\n';
      }
      csv += '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schedules.csv'; a.click();
    URL.revokeObjectURL(a.href);
  }

  // export Word (simple HTML -> doc)
  function exportWord(){
    const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('Ù„Ø§ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    const html = '<html><head><meta charset="utf-8"></head><body dir="rtl">' + out.innerHTML + '</body></html>';
    const blob = new Blob(['\ufeff', html], {type:'application/msword'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schedules.doc'; a.click();
    URL.revokeObjectURL(a.href);
  }

  // export PDF using html2canvas + jsPDF (load if needed)
  async function exportPDF(){
    const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('Ù„Ø§ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    if(typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const canvas = await html2canvas(out, { scale: 1.2, logging:false, useCORS:true, backgroundColor:'#0b1220' });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf || window.jspdf;
    const pdf = new jsPDF('l','mm','a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(imgData,'PNG',0,0,w,h);
    pdf.save('schedules.pdf');
  }

  function loadScript(src){
    return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); });
  }

  // regenerate wrapper
  window.regenerate = regenerate;
  function regenerate(){ generateAll(); }

  // attach to global for buttons
  window.loadMyInstitution = loadMyInstitution;
  window.resetAll = resetAll;
  window.generateAll = generateAll;
  window.copyHTML = copyHTML;
  window.exportCSV = exportCSV;
  window.exportWord = exportWord;
  window.exportPDF = exportPDF;

  // Expose functions to inline buttons
  // minimal global binding for deleteTeacher used in generated rows
  window.deleteTeacher = function(){};

  // initial small helper to render empty message
  (function init(){
    $('#outputArea').innerHTML = '<p class="text-slate-400">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„Â».</p>';
    $('#diagnostic').innerText = 'Ø¬Ø§Ù‡Ø²';
  })();

  </script>
</body>
</html>
