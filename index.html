<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ai_dali_nadjib_emploi_cem</title>
<style>
:root{
  --bg:#071018; --card:#0f1720; --accent:#5D5CDE; --muted:#94a3b8;
  --official:#90EE90; --remedial:#FFF59D; --project:#8BC34A; --free:#D1C4E9; --break:#FFECB3;
  --text-dark:#061018;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Tahoma,Arial;background:var(--bg);color:#fff;direction:rtl}
.wrap{max-width:1300px;margin:14px auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
.small{font-size:12px;color:var(--muted)}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
button.ghost{background:#15303b}
.grid{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="number"],input[type="text"],select,textarea{width:100%;padding:8px;border-radius:8px;border:none;background:#071824;color:#fff}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #123040;padding:6px;text-align:center}
th{background:#071829;color:#fff}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.legend span{padding:6px 10px;border-radius:6px;font-weight:700;color:var(--text-dark)}
.official{background:var(--official)}
.remedial{background:var(--remedial)}
.project{background:var(--project)}
.free{background:var(--free)}
.break{background:var(--break)}
.notice{color:#ffe082;font-weight:700;margin-top:8px}
.schedule-table{border-collapse:collapse;width:100%;margin:10px 0;background:#fff;color:var(--text-dark)}
.schedule-table th,.schedule-table td{border:1px solid #ccc;padding:6px;text-align:center}
.slot{min-width:120px}
.editable{outline:none}
.footer-note{margin-top:12px;color:var(--muted);font-size:13px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Ai_dali_nadjib_emploi_cem</h1>
        <div class="small">Ù…ÙˆÙ„Ø¯ Ø°ÙƒÙŠ Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù† â€” Ø§Ø¶ØºØ· "Ù…Ø¤Ø³Ø³ØªÙŠ" Ø«Ù… "ØªÙˆÙ„ÙŠØ¯" â€” ÙƒÙ„ ØªÙˆÙ„ÙŠØ¯ ÙŠØ¹Ø·ÙŠ Ø­Ù„Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.</div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="imgInput" type="file" accept="image/*" style="display:none" onchange="loadAvatar(event)">
          <img id="avatar" class="avatar" src="" alt="profile" onerror="this.style.display='none'"/>
          <div style="text-align:right">
            <button class="ghost" onclick="document.getElementById('imgInput').click()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
            <div class="small">ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø¯Ø§Ø¦Ø±ÙŠØ©)</div>
          </div>
        </div>
        <div id="userInfo" style="text-align:right">
          <div class="small">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: <strong id="showInstitution">â€”</strong></div>
          <div class="small">Ø£Ø³ØªØ§Ø° Ù…Ø¤Ø³Ø³ØªÙŠ: <strong id="showTeacher">â€”</strong></div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- left -->
      <div>
        <div class="card">
          <h3>1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…Ø·ÙŠ)</h3>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <input id="institutionName" type="text" placeholder="Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´">
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Ø³Ù†Ø© 1Ù… - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl1" type="number" min="0" value="5" onchange="updateTotal()">
            </div>
            <div style="flex:1">
              <label>Ø³Ù†Ø© 2Ù… - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl2" type="number" min="0" value="4" onchange="updateTotal()">
            </div>
            <div style="flex:1">
              <label>Ø³Ù†Ø© 3Ù… - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl3" type="number" min="0" value="3" onchange="updateTotal()">
            </div>
            <div style="flex:1">
              <label>Ø³Ù†Ø© 4Ù… - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl4" type="number" min="0" value="2" onchange="updateTotal()">
            </div>
          </div>
          <div style="margin-top:8px"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</strong> <span id="totalClasses">14</span></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>2. Ø£Ø³Ø§ØªØ°Ø© (ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§)</h3>
          <div class="small">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙÙ…Ù„Ø£ Ø¨Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¤Ø³Ø³ØªÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù…Ø¤Ø³Ø³ØªÙŠ". ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù Ø£Ø³Ø§ØªØ°Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
          <div style="margin-top:10px;max-height:260px;overflow:auto">
            <table id="teachersTable">
              <thead><tr><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</th><th>Ø³Ø§Ø¹Ø§Øª</th><th>Ø­Ø°Ù</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button onclick="loadMyInstitution()">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ</button>
          <button onclick="resetAll()" class="ghost">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
          <button onclick="generateAll()" style="background:#06b6d4">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
          <button onclick="regenerate()" class="ghost">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ø­Ù„ Ø¬Ø¯ÙŠØ¯)</button>
          <button onclick="copyOutput()" class="ghost">ğŸ“‹ Ù†Ø³Ø® HTML</button>
          <button onclick="exportPDF()" class="ghost">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
          <button onclick="exportCSV()" class="ghost">ğŸ“Š ØªØµØ¯ÙŠØ± Excel (CSV)</button>
          <button onclick="exportWord()" class="ghost">ğŸ“ƒ ØªØµØ¯ÙŠØ± Word</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="legend">
            <span class="official">Ø­ØµØ© Ø±Ø³Ù…ÙŠØ©</span>
            <span class="remedial">Ø§Ø³ØªØ¯Ø±Ø§Ùƒ</span>
            <span class="project">Ø£Ø¹Ù…Ø§Ù„ Ù…ÙˆØ¬Ù‡Ø©/ØªØ·Ø¨ÙŠÙ‚ÙŠØ©</span>
            <span class="free">ÙØ±Ø§Øº</span>
            <span class="break">Ø§Ø³ØªØ±Ø§Ø­Ø© 12â€“13</span>
          </div>
          <div class="notice">Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªÙˆÙ„Ù‘Ø¯ Ø­Ù„ÙˆÙ„Ù‹Ø§ ÙƒØ§Ù…Ù„Ø©ØŒ ØªÙ‚Ù„Ù„ Ø§Ù„ÙØ±Ø§ØºØ§ØªØŒ ØªÙØ¶Ù‘Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØµØ¨Ø§Ø­Ù‹Ø§ØŒ ÙˆØªØ­ØªØ±Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©.</div>
        </div>
      </div>

      <!-- right -->
      <div>
        <div class="card">
          <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
          <div><strong>Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„:</strong> Ø§Ù„Ø£Ø­Ø¯ØŒ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†ØŒ Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ (Ù†ØµÙ ÙŠÙˆÙ…)ØŒ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ØŒ Ø§Ù„Ø®Ù…ÙŠØ³</div>
          <div><strong>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</strong> 08:00-15:00 (Ø§Ø³ØªØ±Ø§Ø­Ø© 12:00-13:00)</div>
          <div><strong>Ø§Ø³ØªØ¯Ø±Ø§Ùƒ:</strong> 15:00-16:00 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Ø£ÙŠØ§Ù… Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠØ© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <label>Ø±ÙŠØ§Ø¶ÙŠØ§Øª<select id="pdMath"><option>Ø§Ù„Ø®Ù…ÙŠØ³</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option></select></label>
            <label>Ø¹Ø±Ø¨ÙŠØ©<select id="pdArabic"><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option></select></label>
            <label>ÙØ±Ù†Ø³ÙŠØ©<select id="pdFrench"><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option></select></label>
            <label>Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©<select id="pdEng"><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option></select></label>
            <label>Ø¹Ù„ÙˆÙ…<select id="pdSci"><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option></select></label>
            <label>ÙÙŠØ²ÙŠØ§Ø¡<select id="pdPhy"><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option></select></label>
          </div>
        </div>

      </div>
    </div>

    <div id="outputArea" style="margin-top:18px"></div>
    <div class="footer-note">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø±ÙŠØ± Ø£ÙŠ Ø®Ù„ÙŠØ© (Ø§Ù†Ù‚Ø± ÙˆØ§ÙƒØªØ¨) Ø«Ù… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªÙŠØ¬Ø©. Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯" Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø­Ù„ Ù…Ø®ØªÙ„Ù.</div>
  </div>

<script>
// ===== constants & defaults =====
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
const BREAK = '12:00-13:00';
const MAX_TEACHER = 20; // max hours

const subjHours = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':{'1':4,'2':4,'3':5,'4':5},
  'Ø¹Ø±Ø¨ÙŠØ©':{'1':4,'2':4,'3':4,'4':4},
  'ÙØ±Ù†Ø³ÙŠØ©':{'1':3,'2':3,'3':3,'4':3},
  'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':{'1':3,'2':3,'3':3,'4':3},
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':{'1':3,'2':3,'3':3,'4':3},
  'ÙÙŠØ²ÙŠØ§Ø¡':{'1':2,'2':2,'3':2,'4':2},
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':{'1':2,'2':2,'3':2,'4':2},
  'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':{'1':1,'2':1,'3':1,'4':1},
  'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':{'1':2,'2':2,'3':2,'4':2},
  'Ø±ÙŠØ§Ø¶Ø©':{'1':2,'2':2,'3':2,'4':2},
  'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':{'1':1,'2':1,'3':1,'4':0},
  'Ø±Ø³Ù…':{'1':1,'2':1,'3':1,'4':1}
};

// default pedagogical mapping (can be adjusted from UI)
let pedagogical = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¹Ø±Ø¨ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','ÙØ±Ù†Ø³ÙŠØ©':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†',
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':'Ø§Ù„Ø£Ø­Ø¯','ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':'Ø§Ù„Ø£Ø­Ø¯','ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†',
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','ÙÙŠØ²ÙŠØ§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø±Ø³Ù…':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'
};

// state
let teachers = [];
let institution = { name:'', levels:{'1':5,'2':4,'3':3,'4':2} }; // default per user request

// DOM helpers
const q = s => document.querySelector(s);

// update total classes
function updateTotal(){
  institution.levels['1'] = parseInt(q('#lvl1').value||0);
  institution.levels['2'] = parseInt(q('#lvl2').value||0);
  institution.levels['3'] = parseInt(q('#lvl3').value||0);
  institution.levels['4'] = parseInt(q('#lvl4').value||0);
  const tot = Object.values(institution.levels).reduce((a,b)=>a+b,0);
  q('#totalClasses').innerText = tot;
}

// render teachers table
function renderTeachersUI(){
  const tbody = q('#teachersTable tbody'); tbody.innerHTML='';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td><td>${t.subject}</td><td>${t.sections.join(',')||'â€”'}</td><td>${t.hours}</td><td><button onclick="delTeacher(${i})">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
}

// delete teacher
function delTeacher(i){ teachers.splice(i,1); renderTeachersUI(); }

// avatar
function loadAvatar(e){
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const img = q('#avatar'); img.src = url; img.style.display='block';
}

// load user's institution data (auto)
function loadMyInstitution(){
  resetAll();
  institution.name = 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  q('#institutionName').value = institution.name;
  q('#lvl1').value = 5; q('#lvl2').value = 4; q('#lvl3').value = 3; q('#lvl4').value = 2; updateTotal();

  teachers = [
    {name:'Ù†Ø¬ÙŠØ¨',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:20,totalAssigned:0},
    {name:'Ù…Ù†ÙŠØ±Ø©',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
    {name:'Ø±Ù…Ø²ÙŠ',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
    {name:'Ø£Ù…Ø§Ù„',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},

    {name:'ØµØ¨Ø±ÙŠÙ†Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'Ù…Ø±ÙˆØ©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'Ø³Ø§Ø±Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'ÙˆØ­ÙŠØ¯',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø¹Ø§Ù…Ø±',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},

    {name:'Ø§Ù„Ø¹ÙŠØ¯',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø³Ù„Ù…Ù‰',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø³Ø§Ø±Ø©_Ù',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},

    {name:'Ø¨ÙˆØ¨ÙƒØ±',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ù‡Ø´Ø§Ù…',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ù†',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:14,totalAssigned:0},

    {name:'Ø¹Ø§Ø¦Ø´Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:12,totalAssigned:0},
    {name:'ÙØ§Ø·Ù…Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},
    {name:'Ø£Ù…Ø§Ù„_Øª',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},

    {name:'ÙˆØ³ÙŠÙ„Ø©',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ø·Ø§ÙˆØ³',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},

    {name:'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:12,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_ÙÙŠ',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:10,totalAssigned:0},

    {name:'Ø¹Ù„Ø§Ø¡',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},
    {name:'Ø³Ù…ÙŠØ±',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},

    {name:'Ø³Ø¹ÙŠØ¯',subject:'Ø±Ø³Ù…',sections:[],hours:6,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ø¹Ù„Ø§Ù…',subject:'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ',sections:[],hours:6,totalAssigned:0},
    {name:'Ù…Ø¹Ù„Ù…_Ø§Ø³Ù„Ø§Ù…ÙŠ',subject:'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©',sections:[],hours:8,totalAssigned:0}
  ];

  // show info
  q('#showInstitution').innerText = institution.name;
  q('#showTeacher').innerText = 'Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨ â€” Ø±ÙŠØ§Ø¶ÙŠØ§Øª';
  renderTeachersUI();
}

// reset everything but keep UI
function resetAll(){
  teachers = []; renderTeachersUI();
  institution = { name:'', levels:{'1':0,'2':0,'3':0,'4':0} };
  q('#institutionName').value=''; q('#lvl1').value=0; q('#lvl2').value=0; q('#lvl3').value=0; q('#lvl4').value=0;
  updateTotal();
  q('#outputArea').innerHTML='';
  q('#showInstitution').innerText = 'â€”';
  q('#showTeacher').innerText = 'â€”';
}

// Utility shuffle
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

// Build sections list per institution
function buildSections(){
  const arr=[];
  Object.entries(institution.levels).forEach(([lvl,cnt])=>{
    for(let i=1;i<=cnt;i++) arr.push(`${lvl}Ù…${i}`);
  });
  return arr;
}

// Main generator (heuristic + backtracking)
// We'll attempt many randomized trials; each trial tries greedy placing heavy subjects first per class, with backtracking at subject level.
function generateAll(){
  // read institution values
  institution.name = q('#institutionName').value || 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  institution.levels['1'] = parseInt(q('#lvl1').value||0);
  institution.levels['2'] = parseInt(q('#lvl2').value||0);
  institution.levels['3'] = parseInt(q('#lvl3').value||0);
  institution.levels['4'] = parseInt(q('#lvl4').value||0);

  // update pedagogical from UI
  pedagogical['Ø±ÙŠØ§Ø¶ÙŠØ§Øª'] = q('#pdMath')?.value || pedagogical['Ø±ÙŠØ§Ø¶ÙŠØ§Øª'];
  pedagogical['Ø¹Ø±Ø¨ÙŠØ©'] = q('#pdArabic')?.value || pedagogical['Ø¹Ø±Ø¨ÙŠØ©'];
  pedagogical['ÙØ±Ù†Ø³ÙŠØ©'] = q('#pdFrench')?.value || pedagogical['ÙØ±Ù†Ø³ÙŠØ©'];
  pedagogical['Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'] = q('#pdEng')?.value || pedagogical['Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'];
  pedagogical['Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©'] = q('#pdSci')?.value || pedagogical['Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©'];
  pedagogical['ÙÙŠØ²ÙŠØ§Ø¡'] = q('#pdPhy')?.value || pedagogical['ÙÙŠØ²ÙŠØ§Ø¡'];

  const sections = buildSections();
  if(sections.length===0){ alert('Ù„Ù… ØªÙØ¹Ø±Ù‘Ù Ø£Ù‚Ø³Ø§Ù…. Ø§Ø¶ØºØ· "Ù…Ø¤Ø³Ø³ØªÙŠ" Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….'); return; }
  if(teachers.length===0){ if(confirm('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙØ§Ø±ØºØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙŠØŸ')) loadMyInstitution(); else return; }

  // build class requirements
  const classReq = {};
  sections.forEach(sec=>{
    const lvl = sec.charAt(0);
    classReq[sec]={};
    for(const subj in subjHours){
      const hrs = subjHours[subj] && subjHours[subj][lvl] ? subjHours[subj][lvl]:0;
      if(hrs>0) classReq[sec][subj]=hrs;
    }
    // 4Ù…: no Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ, ensure Ø±Ø³Ù… present
    if(lvl==='4'){
      if(classReq[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']) delete classReq[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ'];
      if(!classReq[sec]['Ø±Ø³Ù…']) classReq[sec]['Ø±Ø³Ù…']=1;
    }
  });

  // index teachers by subject
  const teachersBySubj = {};
  teachers.forEach(t=>{ if(!teachersBySubj[t.subject]) teachersBySubj[t.subject]=[]; teachersBySubj[t.subject].push({...t}); });

  // prepare schedule structure
  const scheduleTemplate = {};
  sections.forEach(sec=>{ scheduleTemplate[sec] = {}; DAYS.forEach(d=>{ scheduleTemplate[sec][d] = {}; SLOTS.forEach(s=> scheduleTemplate[sec][d][s]=null); }); });

  // teacherBusy template
  function makeTeacherBusy(){
    const busy = {};
    teachers.forEach(t=>{
      busy[t.name] = {};
      DAYS.forEach(d=>{ busy[t.name][d] = {}; SLOTS.forEach(s=> busy[t.name][d][s]=false); });
    });
    return busy;
  }

  // candidate teachers order for subj+section (prioritize those with no overload)
  function candidateTeachers(subj, section, teachersState){
    const list = (teachersBySubj[subj] || []).slice();
    // sort: teachers with explicit sections assigned (if any) first, then lower assigned hours
    list.sort((a,b)=>{
      const aHas = (a.sections && a.sections.includes(section));
      const bHas = (b.sections && b.sections.includes(section));
      if(aHas && !bHas) return -1;
      if(!aHas && bHas) return 1;
      return (a.totalAssigned||0) - (b.totalAssigned||0);
    });
    return list;
  }

  // try many randomized trials with backtracking per class
  const MAX_TRIALS = 200;
  let finalSchedule = null;

  trialLoop:
  for(let trial=0; trial<MAX_TRIALS; trial++){
    // prepare fresh copies
    const schedule = JSON.parse(JSON.stringify(scheduleTemplate));
    const teachersState = {}; // map name -> {name,subject,sections,hours,totalAssigned}
    teachers.forEach(t=> teachersState[t.name] = { ...t, totalAssigned:0 });

    const teacherBusy = makeTeacherBusy();

    // classes order: shuffle to vary solutions
    const classOrder = shuffle(sections.slice());

    // place for each class using backtracking over subjects
    let failedOverall = false;

    for(const section of classOrder){
      const lvl = section.charAt(0);
      // subjects list sorted by descending required hours (most constrained first)
      const subjList = Object.keys(classReq[section] || {}).sort((a,b)=> (classReq[section][b] - classReq[section][a]));
      // inner recursive backtracking to place all hours for this section
      function placeSubjects(index){
        if(index>=subjList.length) return true;
        const subj = subjList[index];
        let remaining = classReq[section][subj];
        // try to place 'remaining' occurrences using search
        // create list of all possible day-slot pairs that are allowed for this subject & section
        const slotsCandidates = [];
        for(const day of DAYS){
          if(pedagogical[subj] && pedagogical[subj]===day) continue;
          const slotOrder = subj==='Ø±ÙŠØ§Ø¶ÙŠØ§Øª' ? ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'] : ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
          for(const slot of slotOrder){
            // Tuesday half-day: only first 4 slots allowed
            if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && ['13:00-14:00','14:00-15:00','15:00-16:00'].includes(slot)) continue;
            // avoid break (12-13)
            if(slot===BREAK) continue;
            slotsCandidates.push({day,slot});
          }
        }
        // shuffle to vary
        shuffle(slotsCandidates);
        // we need to pick 'remaining' distinct day-slot places such that:
        // - class slot free
        // - teacher available and within hours
        // - same subject in same day <=2
        // We'll do backtracking choosing placements one by one
        const chosen = [];

        function placeOne(k){
          if(k>=remaining) return true;
          for(const ds of slotsCandidates){
            const day=ds.day, slot=ds.slot;
            // skip if class already has something in that slot
            if(schedule[section][day][slot]) continue;
            // check same-day constraint
            const sameDayCount = SLOTS.reduce((acc,s)=> acc + (schedule[section][day][s] && schedule[section][day][s].subj===subj ? 1:0), 0);
            if(sameDayCount>=2) continue;
            // find candidate teacher for subj:
            const candList = candidateTeachers(subj, section, teachersState);
            // shuffle candList to vary
            shuffle(candList);
            for(const cand of candList){
              const tState = teachersState[cand.name];
              if(!tState) continue;
              if(tState.totalAssigned >= tState.hours) continue;
              if(tState.totalAssigned >= MAX_TEACHER){ // exceeded allowed hours
                // show alert only if happens persistent: request another teacher
                alert(`ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø£Ø³ØªØ§Ø° ${tState.name} ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†ØµØ§Ø¨ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${MAX_TEACHER} Ø³Ø§Ø¹Ø©). ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£Ø³ØªØ§Ø° Ø¢Ø®Ø± Ù„Ù…Ø§Ø¯Ø© ${tState.subject}.`);
                return false;
              }
              if(teacherBusy[tState.name][day][slot]) continue;
              // assign tentatively
              schedule[section][day][slot] = { subj, teacher: tState.name, type: 'official' };
              tState.totalAssigned++;
              teacherBusy[tState.name][day][slot] = true;
              chosen.push({day,slot,tname:tState.name});
              if(placeOne(k+1)) return true;
              // backtrack
              const removed = chosen.pop();
              schedule[section][removed.day][removed.slot] = null;
              tState.totalAssigned--;
              teacherBusy[tState.name][removed.day][removed.slot] = false;
            }
          }
          return false;
        }

        const ok = placeOne(0);
        if(!ok) return false;
        return placeSubjects(index+1);
      } // end placeSubjects

      const ok = placeSubjects(0);
      if(!ok){ failedOverall=true; break; }
    } // end for each section

    // after placing all classes, validate every class's requirements satisfied
    if(!failedOverall){
      // verify counts
      let allSatisfied=true;
      for(const sec of sections){
        for(const subj in classReq[sec]){
          const need = classReq[sec][subj];
          const got = DAYS.reduce((acc,d)=> acc + SLOTS.reduce((a,s)=> a + (schedule[sec][d][s] && schedule[sec][d][s].subj===subj ? 1:0), 0), 0);
          if(got<need){ allSatisfied=false; break; }
        }
        if(!allSatisfied) break;
      }
      if(allSatisfied){
        finalSchedule = schedule;
        break trialLoop;
      }
    }
    // else continue next trial for different randomization
  } // end trials

  if(!finalSchedule){
    alert('Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙŠØ¬Ø§Ø¯ Ø­Ù„ ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. Ø­Ø§ÙˆÙ„ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ø£Ùˆ Ø³Ø§Ø¹Ø§ØªÙ‡Ù… ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
    // still render best-effort empty schedule
    renderResult({}, buildSections());
    return;
  }

  // success: render finalSchedule
  renderResult(finalSchedule, buildSections());
}

// Render results (institution + students + teachers) with editable cells
function renderResult(schedule, sections){
  const out = q('#outputArea'); out.innerHTML='';

  // header
  const head = document.createElement('div'); head.className='card';
  head.innerHTML = `<h3>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© â€” ${institution.name}</h3><div class="small">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${sections.join(', ')}</div>`;
  out.appendChild(head);

  // institution overview per day
  const instCard = document.createElement('div'); instCard.className='card';
  let instHTML = '<h4>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ø§Ù„ÙŠÙˆÙ… Ã— Ø§Ù„Ø³Ø§Ø¹Ø© Ã— Ø§Ù„Ù‚Ø³Ù…)</h4>';
  for(const day of DAYS){
    instHTML += `<h5 style="margin:6px 0">${day}</h5><table class="schedule-table"><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    sections.forEach(sec=> instHTML += `<th class="slot">${sec}</th>`);
    instHTML += '</tr>';
    SLOTS.forEach(slot=>{
      instHTML += `<tr><td>${slot}</td>`;
      sections.forEach(sec=>{
        const cell = (schedule[sec] && schedule[sec][day]) ? schedule[sec][day][slot] : null;
        if(cell){
          const cls = cell.type==='remedial' ? 'remedial' : 'official';
          instHTML += `<td contenteditable="true" class="editable ${cls}">${cell.subj}<br/><span class="small">${cell.teacher}</span></td>`;
        } else {
          if(slot==='13:00-14:00') instHTML += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
          else if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) instHTML += `<td contenteditable="true" class="free">â€”</td>`;
          else instHTML += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
        }
      });
      instHTML += `</tr>`;
    });
    instHTML += `</table>`;
  }
  instCard.innerHTML = instHTML;
  out.appendChild(instCard);

  // students per class
  const studentsCard = document.createElement('div'); studentsCard.className='card';
  let studsHTML = '<h4>Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° Ù„ÙƒÙ„ Ù‚Ø³Ù…</h4>';
  sections.forEach(sec=>{
    studsHTML += `<h5 style="margin:6px 0">${sec}</h5><table class="schedule-table"><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    DAYS.forEach(d=> studsHTML += `<th>${d}</th>`);
    studsHTML += '</tr>';
    SLOTS.forEach(slot=>{
      studsHTML += `<tr><td>${slot}</td>`;
      DAYS.forEach(day=>{
        const cell = (schedule[sec] && schedule[sec][day]) ? schedule[sec][day][slot] : null;
        if(cell){
          const cls = (cell.type==='remedial') ? 'remedial' : 'official';
          studsHTML += `<td contenteditable="true" class="editable ${cls}">${cell.subj}<br/><span class="small">${cell.teacher}</span></td>`;
        } else {
          if(slot==='13:00-14:00') studsHTML += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
          else if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) studsHTML += `<td contenteditable="true" class="free">â€”</td>`;
          else studsHTML += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
        }
      });
      studsHTML += '</tr>';
    });
    studsHTML += '</table>';
  });
  studentsCard.innerHTML = studsHTML;
  out.appendChild(studentsCard);

  // teachers schedules
  const teachCard = document.createElement('div'); teachCard.className='card';
  let teachHTML = '<h4>Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h4>';
  teachers.forEach(t=>{
    teachHTML += `<h5 style="margin:6px 0">${t.name} â€” ${t.subject} (Ø³Ø§Ø¹Ø§Øª Ù…Ù‚Ø±Ø±Ø©: ${t.hours})</h5><table class="schedule-table"><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    DAYS.forEach(d=> teachHTML += `<th>${d}</th>`);
    teachHTML += '</tr>';
    SLOTS.forEach(slot=>{
      teachHTML += `<tr><td>${slot}</td>`;
      DAYS.forEach(day=>{
        let found = null;
        for(const sec of sections){
          const c = (schedule[sec] && schedule[sec][day]) ? schedule[sec][day][slot] : null;
          if(c && c.teacher===t.name){ found={sec,c}; break; }
        }
        if(found){
          const cls = (found.c.type==='remedial') ? 'remedial' : 'official';
          teachHTML += `<td contenteditable="true" class="editable ${cls}">${found.sec}<br/><span class="small">${found.c.subj}</span></td>`;
        } else {
          if(slot==='13:00-14:00') teachHTML += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
          else if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) teachHTML += `<td contenteditable="true" class="free">â€”</td>`;
          else teachHTML += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
        }
      });
      teachHTML += `</tr>`;
    });
    teachHTML += `</table>`;
  });
  teachCard.innerHTML = teachHTML;
  out.appendChild(teachCard);

  setTimeout(()=> window.scrollTo({ top: out.offsetTop - 20, behavior: 'smooth' }), 50);
}

// Regenerate: simply call generateAll again to get new solution
function regenerate(){ generateAll(); }

// Copy HTML
function copyOutput(){
  const html = q('#outputArea').innerHTML;
  navigator.clipboard.writeText(html).then(()=> alert('ØªÙ… Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (HTML) Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©'));
}

// Export PDF (requires html2canvas + jsPDF loaded)
async function exportPDF(){
  if(!window.html2canvas || !window.jspdf){ alert('ÙŠØªØ·Ù„Ø¨ jsPDF & html2canvas Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.'); return; }
  const el = q('#outputArea');
  const canvas = await html2canvas(el, {scale:1.2, useCORS:true, backgroundColor: '#071018'});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','mm','a4');
  const pdfW = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfH = (imgProps.height * pdfW) / imgProps.width;
  pdf.addImage(imgData,'PNG',0,0,pdfW,pdfH);
  pdf.save('Ai_dali_nadjib_emploi_cem_schedule.pdf');
}

// Export CSV: concatenates schedule tables
function exportCSV(){
  const out = q('#outputArea');
  if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ± Ø¨Ø¹Ø¯.'); return; }
  const tables = out.querySelectorAll('.schedule-table');
  let csvParts = [];
  tables.forEach((table, idx)=>{
    const title = table.previousElementSibling ? table.previousElementSibling.textContent.trim() : `Table${idx+1}`;
    csvParts.push(`"${title}"`);
    for(const row of table.rows){
      const cells = [];
      for(const cell of row.cells){
        cells.push('"' + cell.innerText.replace(/\n/g,' / ').replace(/"/g,'""') + '"');
      }
      csvParts.push(cells.join(','));
    }
    csvParts.push('');
  });
  const csvContent = csvParts.join('\n');
  const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'schedules.csv'; a.click(); URL.revokeObjectURL(url);
}

// Export Word (simple)
function exportWord(){
  const content = q('#outputArea').innerHTML;
  if(!content.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±.'); return; }
  const header = `<html><head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</title></head><body dir="rtl">${content}</body></html>`;
  const blob = new Blob(['\ufeff', header], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'schedules.doc'; a.click(); URL.revokeObjectURL(url);
}

// expose some functions to buttons
window.loadMyInstitution = loadMyInstitution;
window.resetAll = resetAll;
window.generateAll = generateAll;
window.regenerate = regenerate;
window.copyOutput = copyOutput;
window.exportPDF = exportPDF;
window.exportCSV = exportCSV;
window.exportWord = exportWord;
window.loadAvatar = loadAvatar;
window.delTeacher = delTeacher;

// initial
updateTotal();
renderTeachersUI();
q('#showInstitution').innerText = 'â€”';
q('#showTeacher').innerText = 'â€”';
</script>

<!-- include html2canvas & jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
