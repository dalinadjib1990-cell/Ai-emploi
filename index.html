
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ai_dali_nadjib_emploi_cem โ ุงููููุฏ ุงูุฐูู ุงูููุงุฆู</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:linear-gradient(180deg,#031022,#061428);color:#e6eef6;font-family:Inter,system-ui,Arial}
    .card{background:#0b1622;border-radius:10px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
    table{border-collapse:collapse}
    th,td{border:1px solid rgba(255,255,255,0.06);padding:8px;text-align:center}
    .avatar{width:60px;height:60px;border-radius:9999px;object-fit:cover;border:3px solid rgba(255,255,255,0.08)}
    .tag{padding:5px 8px;border-radius:8px;font-weight:700}
    .official{background:#b7e4c7;color:#04201b}
    .remedial{background:#fff59d;color:#111}
    .project{background:#a5d6a7;color:#04201b}
    .free{background:#d6c6f0;color:#1b0f2b}
    .break{background:#ffe0a3;color:#1b0f2b}
    .small{font-size:13px;color:#9fb7d9}
    .muted{color:#94a3b8}
    .danger{color:#ffb4b4}
    .btn{padding:8px 12px;border-radius:8px;font-weight:700}
    .editable{min-height:26px}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-indigo-300">Ai_dali_nadjib_emploi_cem โ ุงููููุฏ ุงูุฐูู ูุงุณุชุนูุงู ุงูุฒูู</h1>
        <div class="small mt-1 muted">ุงุถุบุท ยซูุคุณุณุชูยป ุซู ยซุชูููุฏ ุงูุฌุฏุงููยป. ูู ุชูููุฏ ูุนุทู ุงุญุชูุงููุง ุฌุฏูุฏูุงุ ููู ููุดู โ ูุนุทู ุฃูุถู ุฌุฏูู ูููู ููุนุฑุถ ููุงุญุธุงุช.</div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <div class="muted">ุงููุคุณุณุฉ: <strong id="showInstitution">โ</strong></div>
          <div class="muted">ุฃุณุชุงุฐ ูููุฐุฌู: <strong id="showTeacher">โ</strong></div>
        </div>
        <div>
          <img id="avatar" class="avatar hidden" alt="avatar">
          <div class="mt-2 text-center">
            <input id="imgFile" type="file" accept="image/*" class="hidden">
            <button id="btnUpload" class="btn bg-slate-600">ุชุญููู ุตูุฑุฉ</button>
          </div>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Controls -->
      <aside class="lg:col-span-1 space-y-4">
        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">1. ุฅุนุฏุงุฏ ุงููุคุณุณุฉ</h2>
          <label class="block small mt-2 muted">ุงุณู ุงููุคุณุณุฉ</label>
          <input id="institutionName" class="w-full p-2 rounded bg-slate-800 text-white" placeholder="ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด">

          <div class="grid grid-cols-2 gap-2 mt-3">
            <label class="small">ุณูุฉ 1ู: <input id="lvl1" type="number" min="0" value="5" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">ุณูุฉ 2ู: <input id="lvl2" type="number" min="0" value="4" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">ุณูุฉ 3ู: <input id="lvl3" type="number" min="0" value="3" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">ุณูุฉ 4ู: <input id="lvl4" type="number" min="0" value="2" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          </div>
          <div class="mt-2 small">ุฅุฌูุงูู ุงูุฃูุณุงู: <strong id="totalClasses">14</strong></div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">2. ุงูุฃุณุงุชุฐุฉ</h2>
          <div class="small muted">ูุงุฆูุฉ ูุงุจูุฉ ููุชุญููู (ูุคุณุณุชู) ุซู ุชุนุฏูู. ูุตุงุจ ุฃูุตู: <strong>20</strong> ุณุงุนุฉ.</div>
          <div class="mt-2 overflow-auto" style="max-height:260px">
            <table id="teachersTable" class="w-full text-sm">
              <thead><tr class="muted"><th>ุงูุฃุณุชุงุฐ</th><th>ุงููุงุฏุฉ</th><th>ุงูุฃูุณุงู</th><th>ุณุงุนุงุช</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnMyInst" class="btn bg-emerald-600">๐ซ ูุคุณุณุชู</button>
            <button id="btnReset" class="btn bg-slate-600">๐ ุฅุนุงุฏุฉ ุงูุชุนููู</button>
            <button id="btnGenerate" class="btn bg-indigo-600">โก ุชูููุฏ ุงูุฌุฏุงูู</button>
            <button id="btnRegen" class="btn bg-indigo-500">๐ ุฅุนุงุฏุฉ ุชูููุฏ</button>
          </div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">3. ุนุฑุถ</h2>
          <div class="mt-2">
            <button id="viewInstitution" class="btn bg-blue-600 w-full mb-2">๐ ุฌุฏูู ุงููุคุณุณุฉ</button>
            <div class="flex gap-2">
              <select id="teacherSelector" class="w-full p-2 rounded bg-slate-800"></select>
              <button id="viewTeacherBtn" class="btn bg-blue-500">ุนุฑุถ</button>
            </div>
            <div class="mt-2 flex gap-2">
              <select id="classSelector" class="w-full p-2 rounded bg-slate-800"></select>
              <button id="viewClassBtn" class="btn bg-blue-500">ุนุฑุถ</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">4. ุชุตุฏูุฑ / ูุณุฎ</h2>
          <div class="flex gap-2 mt-2 flex-wrap">
            <button id="btnCopy" class="btn bg-sky-600">๐ ูุณุฎ HTML</button>
            <button id="btnCSV" class="btn bg-sky-700">๐ Excel (CSV)</button>
            <button id="btnWord" class="btn bg-sky-500">๐ Word</button>
            <button id="btnPDF" class="btn bg-sky-400">๐ PDF</button>
          </div>
          <div class="mt-3 small" id="diagnostic">ุงูุญุงูุฉ: ุฌุงูุฒ.</div>
        </div>
      </aside>

      <!-- Output -->
      <main class="lg:col-span-3">
        <div id="outputArea" class="card min-h-[320px]">
          <p class="small muted">ุจุนุฏ ุงูุถุบุท ุนูู ยซุชูููุฏ ุงูุฌุฏุงููยป ุณูุธูุฑ ุฌุฏูู ุงููุคุณุณุฉ ููุง. ุงูุชูููุฏ ูุง ููุดู โ ุณูุนุทู ุฃูุถู ุฌุฏูู ูููู ููุนุฑุถ ููุงุญุธุงุช ููุตูุฉ ุจุงูุฃุณูู.</p>
        </div>
      </main>
    </div>

    <footer class="text-sm text-slate-400">ุงูุชุทุจูู ูุนุทู ุฌุฏูููุง ุญุชู ูู ูุงูุช ุงููุฏุฎูุงุช ูุญุฏูุฏุฉ: ุณูุนุฑุถ ุงูุฎุงูุงุช ุงููุงุฑุบุฉ ูุงูููุงุญุธุงุช ุงููุงุฒูุฉ ูุงุณุชุฏุฑุงุฌ ุฃุณุงุชุฐุฉ/ุฒูุงุฏุฉ ุณุงุนุงุช.</footer>
  </div>

<script>
/* ---------- ุซูุงุจุช ูููุงุนุฏ ---------- */
const DAYS = ['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
const MAX_TEACHER = 20;

// ูุตุงุจ ุงูููุงุฏ ุญุณุจ ุงููุณุชูู (ุชูุฑูุจู ุญุณุจ ุทูุจู)
const subjectHours = {
  'ุฑูุงุถูุงุช': {'1':4,'2':4,'3':5,'4':5},
  'ุนุฑุจูุฉ': {'1':4,'2':4,'3':4,'4':4},
  'ูุฑูุณูุฉ': {'1':3,'2':3,'3':3,'4':3},
  'ุงูุฌููุฒูุฉ': {'1':3,'2':3,'3':3,'4':3},
  'ุนููู ุทุจูุนูุฉ': {'1':3,'2':3,'3':3,'4':3},
  'ููุฒูุงุก': {'1':2,'2':2,'3':2,'4':2},
  'ุชุงุฑูุฎ ูุฌุบุฑุงููุง': {'1':2,'2':2,'3':2,'4':2},
  'ุชุฑุจูุฉ ูุฏููุฉ': {'1':1,'2':1,'3':1,'4':1},
  'ุชุฑุจูุฉ ุงุณูุงููุฉ': {'1':2,'2':2,'3':2,'4':2},
  'ุฑูุงุถุฉ': {'1':2,'2':2,'3':2,'4':2},
  'ุฅุนูุงู ุขูู': {'1':1,'2':1,'3':1,'4':0},
  'ุฑุณู': {'1':1,'2':1,'3':1,'4':1}
};

// ุฃูุงู ุจูุฏุงุบูุฌูุฉ ุงูุชุฑุงุถูุฉ (ูุงุจูุฉ ููุชุนุฏูู ูุงุญููุง)
let pedagogicalDays = {
  'ุฑูุงุถูุงุช':'ุงูุฎููุณ','ุนุฑุจูุฉ':'ุงูุงุซููู','ูุฑูุณูุฉ':'ุงูุซูุงุซุงุก','ุงูุฌููุฒูุฉ':'ุงูุงุซููู','ุนููู ุทุจูุนูุฉ':'ุงูุฃุฑุจุนุงุก','ููุฒูุงุก':'ุงูุซูุงุซุงุก','ุฑุณู':'ุงูุฎููุณ','ุฅุนูุงู ุขูู':'ุงูุฃุฑุจุนุงุก'
};

/* ---------- ุญุงูุฉ ุงูุชุทุจูู ---------- */
let teachers = []; // {name,subject,sections:[],hours,totalAssigned}
let institution = {name:'',levels:{1:5,2:4,3:3,4:2}};
let lastSchedule = null;
let lastSections = [];

/* ---------- DOM helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function clone(o){ return JSON.parse(JSON.stringify(o)); }

/* ---------- UI wiring ---------- */
$('#btnUpload').addEventListener('click', ()=> $('#imgFile').click());
$('#imgFile').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); $('#avatar').src=url; $('#avatar').classList.remove('hidden'); });

$('#lvl1').addEventListener('change', updateTotal);
$('#lvl2').addEventListener('change', updateTotal);
$('#lvl3').addEventListener('change', updateTotal);
$('#lvl4').addEventListener('change', updateTotal);

$('#btnMyInst').addEventListener('click', loadMyInstitution);
$('#btnReset').addEventListener('click', ()=> { if(confirm('ุฅุนุงุฏุฉ ุงูุชุนููู ูุชูุฑูุบ ูู ุงููุฏุฎูุงุช ูุงูุฌุฏุงููุ')) resetAll(); });
$('#btnGenerate').addEventListener('click', ()=> generateAll());
$('#btnRegen').addEventListener('click', ()=> generateAll(true));
$('#viewInstitution').addEventListener('click', ()=> showInstitutionTable());
$('#viewTeacherBtn').addEventListener('click', ()=> showTeacherTable($('#teacherSelector').value));
$('#viewClassBtn').addEventListener('click', ()=> showClassTable($('#classSelector').value));

$('#btnCopy').addEventListener('click', copyHTML);
$('#btnCSV').addEventListener('click', exportCSV);
$('#btnWord').addEventListener('click', exportWord);
$('#btnPDF').addEventListener('click', exportPDF);

/* ---------- utilities ---------- */
function updateTotal(){
  const tot = (parseInt($('#lvl1').value||0) + parseInt($('#lvl2').value||0) + parseInt($('#lvl3').value||0) + parseInt($('#lvl4').value||0));
  $('#totalClasses').innerText = tot;
}

function buildSections(){
  const arr=[];
  const l1 = parseInt($('#lvl1').value||0), l2 = parseInt($('#lvl2').value||0), l3 = parseInt($('#lvl3').value||0), l4 = parseInt($('#lvl4').value||0);
  for(let i=1;i<=l1;i++) arr.push(`1ู${i}`);
  for(let i=1;i<=l2;i++) arr.push(`2ู${i}`);
  for(let i=1;i<=l3;i++) arr.push(`3ู${i}`);
  for(let i=1;i<=l4;i++) arr.push(`4ู${i}`);
  lastSections = arr;
  renderTeachersUI();
  return arr;
}

/* ---------- teachers UI ---------- */
function renderTeachersUI(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${t.sections.length? t.sections.join(',') : 'โ'}</td><td class="p-2">${t.hours}</td><td class="p-2"><button onclick="deleteTeacher(${i})" class="px-2 py-1 bg-red-600 rounded text-xs">ุญุฐู</button></td>`;
    tbody.appendChild(tr);
  });
  // selectors
  const teacherSel = $('#teacherSelector'); teacherSel.innerHTML = '<option value="">ุงุฎุชุฑ ุฃุณุชุงุฐ</option>';
  teachers.forEach(t=> { const o=document.createElement('option'); o.value=t.name; o.textContent=`${t.name} โ ${t.subject}`; teacherSel.appendChild(o); });
  const classSel = $('#classSelector'); classSel.innerHTML = '<option value="">ุงุฎุชุฑ ูุณู</option>';
  lastSections.forEach(s=> { const o=document.createElement('option'); o.value=s; o.textContent=s; classSel.appendChild(o); });
}
window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); };

/* ---------- load sample institution ---------- */
function loadMyInstitution(){
  resetAll(false);
  institution.name = 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด';
  $('#institutionName').value = institution.name;
  $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2;
  updateTotal();

  teachers = [
    {name:'ูุฌูุจ',subject:'ุฑูุงุถูุงุช',sections:[],hours:20,totalAssigned:0},
    {name:'ูููุฑุฉ',subject:'ุฑูุงุถูุงุช',sections:[],hours:18,totalAssigned:0},
    {name:'ุฑูุฒู',subject:'ุฑูุงุถูุงุช',sections:[],hours:18,totalAssigned:0},
    {name:'ุฃูุงู',subject:'ุฑูุงุถูุงุช',sections:[],hours:18,totalAssigned:0},

    {name:'ุตุจุฑููุฉ',subject:'ุนุฑุจูุฉ',sections:[],hours:18,totalAssigned:0},
    {name:'ูุฑูุฉ',subject:'ุนุฑุจูุฉ',sections:[],hours:18,totalAssigned:0},
    {name:'ุณุงุฑุฉ',subject:'ุนุฑุจูุฉ',sections:[],hours:18,totalAssigned:0},
    {name:'ูุญูุฏ',subject:'ุนุฑุจูุฉ',sections:[],hours:16,totalAssigned:0},
    {name:'ุนุงูุฑ',subject:'ุนุฑุจูุฉ',sections:[],hours:16,totalAssigned:0},

    {name:'ุงูุนูุฏ',subject:'ูุฑูุณูุฉ',sections:[],hours:16,totalAssigned:0},
    {name:'ุณููู',subject:'ูุฑูุณูุฉ',sections:[],hours:16,totalAssigned:0},
    {name:'ุณุงุฑุฉ_ู',subject:'ูุฑูุณูุฉ',sections:[],hours:16,totalAssigned:0},

    {name:'ุจูุจูุฑ',subject:'ุงูุฌููุฒูุฉ',sections:[],hours:12,totalAssigned:0},
    {name:'ูุดุงู',subject:'ุงูุฌููุฒูุฉ',sections:[],hours:12,totalAssigned:0},
    {name:'ุฃูููุฉ_ุงู',subject:'ุงูุฌููุฒูุฉ',sections:[],hours:14,totalAssigned:0},

    {name:'ุนุงุฆุดุฉ',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:[],hours:12,totalAssigned:0},
    {name:'ูุงุทูุฉ',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:[],hours:10,totalAssigned:0},
    {name:'ุฃูุงู_ุช',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:[],hours:10,totalAssigned:0},

    {name:'ูุณููุฉ',subject:'ุนููู ุทุจูุนูุฉ',sections:[],hours:12,totalAssigned:0},
    {name:'ุทุงูุณ',subject:'ุนููู ุทุจูุนูุฉ',sections:[],hours:12,totalAssigned:0},

    {name:'ุนุจุฏ ุงูุฑุฒุงู',subject:'ููุฒูุงุก',sections:[],hours:12,totalAssigned:0},
    {name:'ุฃูููุฉ_ูู',subject:'ููุฒูุงุก',sections:[],hours:10,totalAssigned:0},

    {name:'ุนูุงุก',subject:'ุฑูุงุถุฉ',sections:[],hours:8,totalAssigned:0},
    {name:'ุณููุฑ',subject:'ุฑูุงุถุฉ',sections:[],hours:8,totalAssigned:0},

    {name:'ุณุนูุฏ',subject:'ุฑุณู',sections:[],hours:6,totalAssigned:0},
    {name:'ุฃูููุฉ_ุงุนูุงู',subject:'ุฅุนูุงู ุขูู',sections:[],hours:6,totalAssigned:0},
    {name:'ูุนูู_ุงุณูุงูู',subject:'ุชุฑุจูุฉ ุงุณูุงููุฉ',sections:[],hours:8,totalAssigned:0}
  ];

  lastSections = buildSections();
  $('#showInstitution').innerText = institution.name;
  $('#showTeacher').innerText = 'ุฏุงูู ูุฌูุจ โ ุฑูุงุถูุงุช';
  renderTeachersUI();
  $('#diagnostic').innerText = 'ุชู ุชุญููู ุจูุงูุงุช ุงููุคุณุณุฉ ุงููููุฐุฌูุฉ. ุงุถุบุท ุชูููุฏ.';
}

/* ---------- reset ---------- */
function resetAll(clearUI=true){
  teachers = [];
  institution = {name:'',levels:{1:0,2:0,3:0,4:0}};
  $('#institutionName').value='';
  $('#lvl1').value=0; $('#lvl2').value=0; $('#lvl3').value=0; $('#lvl4').value=0;
  updateTotal();
  $('#showInstitution').innerText='โ';
  $('#showTeacher').innerText='โ';
  $('#outputArea').innerHTML = `<p class="small muted">ุงููุชุงุฆุฌ ุณุชุธูุฑ ููุง ุจุนุฏ ุงูุชูููุฏ.</p>`;
  $('#diagnostic').innerText = 'ุชู ุงูุชูุฑูุบ.';
  lastSchedule = null; lastSections = [];
  if(clearUI) renderTeachersUI();
}

/* ---------- ุงูุชูููุฏ ุงูุฐูู (ูุง ููุดู) ---------- */
function generateAll(forceNew=false){
  institution.name = $('#institutionName').value || institution.name || 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด';
  $('#showInstitution').innerText = institution.name;
  const sections = buildSections();
  if(sections.length===0){ alert('ูู ุชูุนุฑูู ุฃูุณุงู. ุงุถุบุท "ูุคุณุณุชู" ุฃู ุฃุฏุฎู ุนุฏุฏ ุงูุฃูุณุงู.'); return; }
  if(teachers.length===0){ if(confirm('ูุงุฆูุฉ ุงูุฃุณุงุชุฐุฉ ูุงุฑุบุฉ. ุชุญููู ูุคุณุณุชูุ')) loadMyInstitution(); else return; }

  // ูุชุทูุจุงุช ูู ูุณู (ุนุฏุฏ ุงูุญุตุต ููู ูุงุฏุฉ)
  const req = {};
  for(const sec of sections){
    const lvl = sec.charAt(0);
    req[sec] = {};
    for(const subj in subjectHours){
      const h = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(h>0) req[sec][subj] = h;
    }
    // ุชุนุฏูู ุฎุงุต ูุณูุฉ ุฑุงุจุนุฉ: ูุง ุฅุนูุงู ุขูู
    if(sec.startsWith('4') && req[sec]['ุฅุนูุงู ุขูู']) delete req[sec]['ุฅุนูุงู ุขูู'];
    if(sec.startsWith('4') && !req[sec]['ุฑุณู']) req[sec]['ุฑุณู'] = 1;
  }

  // ุฅูุดุงุก ูุงูุจ ุฌุฏูู ูุงุฑุบ
  function makeSchedule(){
    const S = {};
    for(const sec of sections){ S[sec] = {}; for(const d of DAYS){ S[sec][d] = {}; for(const s of SLOTS) S[sec][d][s] = null; } }
    return S;
  }
  const schedule = makeSchedule();

  // busy map ูููุนูููู
  const busy = {};
  teachers.forEach(t=>{ busy[t.name] = {}; for(const d of DAYS) { busy[t.name][d] = {}; for(const s of SLOTS) busy[t.name][d][s] = false; } t.totalAssigned=0; });

  // ุชุฑุชูุจ ุฃููู ููููู: ูู ูุงุฏุฉ ููู ูุณู ููุงุฆูุฉ ูู ูุญุฏุงุช ุงูุญุตุฉ
  const tasks = []; // ูู ูููุฉ: {sec, subj}
  for(const sec of sections){
    for(const subj in req[sec]){
      for(let k=0;k<req[sec][subj];k++){
        tasks.push({sec,subj});
      }
    }
  }
  // ูุฎูุท ุงูููุงู ูุชููุน ุงูุญูููุ ููู ูุฑูุฏ ุฑูุงุถูุงุช ูุจูุฑูุง => ูุถุน ุงูุฑูุงุถูุงุช ูู ุจุฏุงูุฉ ุงููุงุฆูุฉ ูุน ุฃูุถููุฉ ูููุณู 4ู
  const mathTasks = tasks.filter(t=> t.subj==='ุฑูุงุถูุงุช').sort((a,b)=> (a.sec.startsWith('4')? -1:0));
  const other = tasks.filter(t=> t.subj!=='ุฑูุงุถูุงุช');
  const mixed = mathTasks.concat(shuffle(other));

  // function to get candidate teachers for subject
  function candidates(subj, section){
    // teachers who teach this subj and not exceeded requested hours
    let cand = teachers.filter(t => t.subject === subj);
    // if none, allow teachers of other subjects? NO โ we prefer not to. If none, return empty.
    // sort: those with fewer assigned hours first
    cand.sort((a,b)=> (a.totalAssigned||0) - (b.totalAssigned||0));
    return cand;
  }

  // Preferred slot order per subject: math -> morning preference
  function preferredSlotsFor(subj){
    if(subj === 'ุฑูุงุถูุงุช'){
      return ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
    }
    return SLOTS.slice();
  }

  // Helper: section free at day/slot?
  function isSectionFree(sec,d,s){ return !schedule[sec][d][s]; }

  // Worker: attempt place one task, returns true if placed else false (and record reason)
  const notes = []; // ูุตุงุฆุญ ูููุงุญุธุงุช
  function placeTask(task){
    const {sec,subj} = task;
    const slotsOrder = preferredSlotsFor(subj);
    // build list of candidate day-slot pairs, avoiding pedagogical day for subj
    const dsPairs = [];
    for(const d of DAYS){
      if(pedagogicalDays[subj] && pedagogicalDays[subj] === d) continue;
      for(const s of slotsOrder){
        if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(s)>=4) continue; // ุงูุซูุงุซุงุก ูุตู ููู - ุงูุณูุงุญ ุจุนุฑูุถ ููููุฉ ุจุนุฏ 12ุ ุญุณุจ ุทูุจ: ุงูุซูุงุซุงุก ูุตู ููู -> ูููุน ุจุนุฏ ุงูุธูุฑ
        dsPairs.push({d,s});
      }
    }
    // shuffle to vary across regenerations, but keep order priority
    shuffle(dsPairs);
    // attempt: prefer morning for math and prefer teachers with available hours
    const cands = candidates(subj, sec);
    for(const {d,s} of dsPairs){
      if(!isSectionFree(sec,d,s)) continue;
      // try teachers in order
      for(const t of cands){
        if(t.totalAssigned >= t.hours) continue; // teacher reached requested hours
        if(t.totalAssigned >= MAX_TEACHER) continue; // safety
        if(busy[t.name][d][s]) continue;
        // ensure teacher not teaching same section at same slot (busy covers)
        // assign
        schedule[sec][d][s] = {subj, teacher: t.name, type: 'official'};
        t.totalAssigned = (t.totalAssigned||0) + 1;
        busy[t.name][d][s] = true;
        return true;
      }
    }
    // if cannot place because no teacher available in preferred slots, try more flexible slots including pedagogical day or Tuesday afternoons
    const dsPairsFlex = [];
    for(const d of DAYS){
      for(const s of SLOTS){
        // allow pedagogical day slots as last resort
        dsPairsFlex.push({d,s});
      }
    }
    shuffle(dsPairsFlex);
    for(const {d,s} of dsPairsFlex){
      if(!isSectionFree(sec,d,s)) continue;
      const cands2 = candidates(subj, sec);
      for(const t of cands2){
        if(t.totalAssigned >= t.hours) continue;
        if(t.totalAssigned >= MAX_TEACHER) continue;
        if(busy[t.name][d][s]) continue;
        schedule[sec][d][s] = {subj, teacher: t.name, type: 'official (flex)'};
        t.totalAssigned = (t.totalAssigned||0) + 1;
        busy[t.name][d][s] = true;
        return true;
      }
    }
    // ุฃุฎูุฑุงู: ูุง ููุฌุฏ ูุนููุ ูุชุฑู ุงููุฑุงุบ ููุณุฌู ููุงุญุธุฉ
    notes.push(`ุงููุณู ${sec} โ ุงููุงุฏุฉ ${subj}: ูุง ููุฌุฏ ุฃุณุชุงุฐ ูุชุงุญ ุฃู ูุตุงุจ ูุงููุ ุชุฑูุช ุงูุญุตุฉ ูุงุฑุบุฉ.`);
    return false;
  }

  // ุฃูู ูุฑุญูุฉ: ูุญุงูู ูุถุน ูู ุงูููุงู
  for(const t of mixed){
    placeTask(t);
  }

  // ุจุนุฏ ุงูุชุนููู: ูููุฃ ุงููุฌูุงุช ุงูููููุฉ ุจุญุตุต ุงุณุชุฏุฑุงู ุฃู ุจุฏู ูุฑุงุบุงุช ุฅู ุฃููู (ูุญุงูู ุชูููู ุงููุฑุงุบุงุช ููุฃุณุงุชุฐุฉ)
  // ูุญุงููุฉ ุจุณูุทุฉ: ููู ูุนููุ ุฅุฐุง ูุฏูู ูุฑุงุบุงุช ูุซูุฑุฉ ูุนูู ูุง ุดูุก ูุนูุฏ โ ูุชุฑู ุงูุฎูุงุฑุฒููุฉ ุงูุฃุณุงุณูุฉุ ูุฃููุง ูุงููุฉ ุงูุขู.

  lastSchedule = schedule;

  // ุจูุงุก ุชูุฑูุฑ ููุงุญุธุงุช ููุงุฆู: ูุฐูุฑ ุงูููุงุฏ ุบูุฑ ุงูููุชููุฉ (ุนุฏุฏ ุงูุญุตุต ูู ุงููุทููุจ/ุงูููุฌูุฏ)
  const report = [];
  for(const sec of sections){
    for(const subj in req[sec]){
      const need = req[sec][subj];
      let got = 0;
      for(const d of DAYS) for(const s of SLOTS) if(schedule[sec][d][s] && schedule[sec][d][s].subj === subj) got++;
      if(got < need) report.push(`ุงููุณู ${sec} โ ${subj}: ูุทููุจ ${need} ุญุตุตุ ููุนูู ${got} โ ููุฒู ุงุณุชุฏุนุงุก/ุฒูุงุฏุฉ ุฃุณุงุชุฐุฉ ุฃู ุชุนุฏูู ูุตุงุจ.`);
    }
  }
  // ุชุญุฐูุฑ: ุฃุณุงุชุฐุฉ ุชุฌุงูุฒูุง ูุตุงุจููุ
  const overloads = teachers.filter(t=> (t.totalAssigned||0) > t.hours).map(t=> `${t.name} (ููุนูู: ${t.totalAssigned}ุ ูุตุงุจ: ${t.hours})`);
  if(overloads.length) report.push('ุชุญุฐูุฑ: ุจุนุถ ุงูุฃุณุงุชุฐุฉ ุชุฌุงูุฒูุง ูุตุงุจูู: ' + overloads.join('; '));

  // ูุฎุฑุฌุงุช: ูุนุฑุถ ุงูุฌุฏูู ูุงููุคุณุณุฉ ูุงูุชูููุฐ ูุงูุฃุณุงุชุฐุฉ ุญุณุจ ุทูุจู
  $('#diagnostic').innerText = report.length ? ('ููุงุญุธุงุช: \n' + report.join('\n')) : 'ุชู ุงูุชูููุฏ โ ูุง ููุงุญุธุงุช ูููุฉ.';
  showInstitutionTable();
}

/* ---------- ุนุฑุถ ุงููุชุงุฆุฌ ---------- */
function showInstitutionTable(){
  if(!lastSchedule){ $('#outputArea').innerHTML = `<p class="small muted">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ. ุงุถุบุท ุชูููุฏ.</p>`; return; }
  const sections = lastSections.slice();
  const out = $('#outputArea'); out.innerHTML = '';
  const header = document.createElement('div'); header.innerHTML = `<h2 class="text-xl text-indigo-300">${$('#institutionName').value || 'ุงููุคุณุณุฉ'}</h2><div class="small muted">ุนุฑุถ ุงุณุชุนูุงู ุงูุฒูู ูููุคุณุณุฉ โ ุงูุฃูุณุงู: ${sections.join(', ')}</div>`; out.appendChild(header);

  for(const d of DAYS){
    const dayTitle = document.createElement('h3'); dayTitle.className='text-lg text-indigo-200 mt-4'; dayTitle.textContent = d; out.appendChild(dayTitle);
    const wrap = document.createElement('div'); wrap.className='overflow-auto';
    let html = `<table class="w-full bg-white text-black schedule-table"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
    sections.forEach(s=> html += `<th>${s}</th>`);
    html += `</tr></thead><tbody>`;
    for(const slot of SLOTS){
      html += `<tr><td>${slot}</td>`;
      for(const sec of sections){
        const c = lastSchedule[sec][d][slot];
        if(c) html += `<td contenteditable="true" class="editable official">${c.subj}<br/><small>${c.teacher}</small></td>`;
        else {
          if(slot === '13:00-14:00') html += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
          else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot) >= 4) html += `<td contenteditable="true" class="free">โ</td>`;
          else html += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</tbody></table>`;
    wrap.innerHTML = html; out.appendChild(wrap);
  }
}

function showTeacherTable(teacherName){
  if(!teacherName){ alert('ุงุฎุชุฑ ุฃุณุชุงุฐูุง'); return; }
  if(!lastSchedule){ alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ. ุงุถุบุท ุชูููุฏ'); return; }
  const sections = lastSections.slice();
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">ุฌุฏูู ุงูุฃุณุชุงุฐ ${teacherName}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      let found = null;
      for(const sec of sections){
        const c = lastSchedule[sec][d][slot];
        if(c && c.teacher === teacherName){ found = {sec,c}; break; }
      }
      if(found) html += `<td contenteditable="true" class="editable official">${found.sec}<br/><small>${found.c.subj}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
        else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot) >= 4) html += `<td contenteditable="true" class="free">โ</td>`;
        else html += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

function showClassTable(section){
  if(!section){ alert('ุงุฎุชุฑ ูุณููุง'); return; }
  if(!lastSchedule){ alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ. ุงุถุบุท ุชูููุฏ'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">ุฌุฏูู ุงููุณู ${section}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      const c = lastSchedule[section][d][slot];
      if(c) html += `<td contenteditable="true" class="editable official">${c.subj}<br/><small>${c.teacher}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
        else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot) >= 4) html += `<td contenteditable="true" class="free">โ</td>`;
        else html += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

/* ---------- ุชุตุฏูุฑ ูููุณุฎ ---------- */
function copyHTML(){ navigator.clipboard.writeText($('#outputArea').innerHTML).then(()=> alert('ุชู ูุณุฎ HTML'));}
function exportCSV(){
  const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('ูุง ุชูุฌุฏ ุฌุฏุงูู'); return; }
  const tables = out.querySelectorAll('table'); let csv='';
  tables.forEach((table,idx)=>{
    const title = table.previousElementSibling ? table.previousElementSibling.innerText.replace(/\n/g,' ') : `Table${idx+1}`;
    csv += `"${title}"\n`;
    for(const row of table.rows){
      const cells = Array.from(row.cells).map(c=> '"' + c.innerText.replace(/"/g,'""').replace(/\n/g,' / ') + '"');
      csv += cells.join(',') + '\n';
    }
    csv += '\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='schedules.csv'; a.click();
  URL.revokeObjectURL(a.href);
}
function exportWord(){
  const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('ูุง ุชูุฌุฏ ุฌุฏุงูู'); return; }
  const html = '<html><head><meta charset="utf-8"></head><body dir="rtl">' + out.innerHTML + '</body></html>';
  const blob = new Blob(['\ufeff', html], {type:'application/msword'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='schedules.doc'; a.click();
  URL.revokeObjectURL(a.href);
}
async function exportPDF(){
  const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('ูุง ุชูุฌุฏ ุฌุฏุงูู'); return; }
  if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
  if(typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  const canvas = await html2canvas(out, {scale:1.2,useCORS:true,backgroundColor:'#031022'});
  const img = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf || window.jspdf;
  const pdf = new jsPDF('l','mm','a4'); const w = pdf.internal.pageSize.getWidth(); const h = (canvas.height * w) / canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h); pdf.save('schedules.pdf');
}
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

/* ---------- initialization ---------- */
updateTotal();
renderTeachersUI();
// end of script
</script>
</body>
</html>
