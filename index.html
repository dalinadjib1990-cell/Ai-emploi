<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ai_dali_nadjib_emploi_cem โ ูููุฏ ุงุณุชุนูุงู ุงูุฒูู (GA)</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { background: linear-gradient(180deg,#071025,#051022); color: #e6eef6; font-family: Inter, system-ui, Arial; }
  .card { background: #07182a; border-radius: 10px; padding: 14px; box-shadow: 0 6px 20px rgba(2,6,23,.6); }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid rgba(255,255,255,0.06); padding: 6px; text-align: center; font-size: 13px; }
  .slot-official { background: #7dd3fc; color: #022c3a; font-weight:700; }
  .slot-remedial { background: #fde68a; color: #1b1b00; }
  .slot-project { background: #86efac; color: #04200b; }
  .slot-free { background: #9b7bd6; color: #0f0420; }
  .slot-break { background: #ffd7a6; color: #120800; }
  .small { font-size:12px; color:#93c5fd; }
  .muted { color: #9fb7d9; }
  .btn { padding: 8px 12px; border-radius:8px; font-weight:700; }
  .progressbar { height:8px; background:#0b1220; border-radius:6px; overflow:hidden; }
  .progress { height:100%; background:linear-gradient(90deg,#06b6d4,#7c3aed); width:0%; }
  .editable { min-height:24px; }
</style>
</head>
<body>
<div class="max-w-7xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-indigo-300">Ai_dali_nadjib_emploi_cem โ ูููุฏ ุงุณุชุนูู ุฒูู ุฐูู (GA)</h1>
      <div class="small muted">ุงูุชูููุฏ ุฏุงุฆูุงู ูุนูู โ ูุนุทู ุญููู ูุชุนุฏุฏุฉ ุนูุฏ ูู ุชูููุฏ. ุฃููููุฉ: ุชูููุฏ ุตุงูุญ ุซู ุชุญุณูู ุฑุงุญุฉ ุงูุฃุณุงุชุฐุฉ.</div>
    </div>
    <div class="text-right">
      <div class="muted">ูุคุณุณุฉ: <span id="showInstitution" class="font-bold">โ</span></div>
      <div class="muted">ุฃุณุชุงุฐ ูููุฐุฌู: <span id="showTeacher" class="font-bold">ุฏุงูู ูุฌูุจ โ ุฑูุงุถูุงุช</span></div>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- controls -->
    <aside class="lg:col-span-1 space-y-4">
      <div class="card">
        <h2 class="text-lg font-bold text-indigo-200">1. ุฅุนุฏุงุฏ ุงููุคุณุณุฉ</h2>
        <label class="block small muted mt-2">ุงุณู ุงููุคุณุณุฉ</label>
        <input id="institutionName" class="w-full p-2 rounded bg-slate-800 text-white" placeholder="ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด" value="ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด">
        <div class="grid grid-cols-2 gap-2 mt-3">
          <label class="small">ุณูุฉ 1ู: <input id="lvl1" type="number" min="0" value="5" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          <label class="small">ุณูุฉ 2ู: <input id="lvl2" type="number" min="0" value="4" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          <label class="small">ุณูุฉ 3ู: <input id="lvl3" type="number" min="0" value="3" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          <label class="small">ุณูุฉ 4ู: <input id="lvl4" type="number" min="0" value="2" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
        </div>
        <div class="mt-2 small">ุฅุฌูุงูู ุงูุฃูุณุงู: <strong id="totalClasses">14</strong></div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold text-indigo-200">2. ุงูุฃุณุงุชุฐุฉ (ูุงุจู ููุชุนุฏูู)</h2>
        <div class="small muted">ูุงุฆูุฉ ูููุฐุฌูุฉ ูุงุจูุฉ ููุชุนุฏูู. ูุตุงุจ ุฃูุตู: <strong>20</strong> ุณุงุนุฉ.</div>
        <div class="mt-2 overflow-auto" style="max-height:280px">
          <table id="teachersTable" class="w-full text-sm">
            <thead><tr class="muted"><th>ุงูุฃุณุชุงุฐ</th><th>ุงููุงุฏุฉ</th><th>ุงูุฃูุณุงู</th><th>ุณุงุนุงุช</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt-3 grid grid-cols-1 gap-2">
          <div class="grid grid-cols-3 gap-2">
            <input id="newName" placeholder="ุงุณู ุงูุฃุณุชุงุฐ" class="p-2 rounded bg-slate-800">
            <select id="newSubject" class="p-2 rounded bg-slate-800">
              <option value="ุฑูุงุถูุงุช">ุฑูุงุถูุงุช</option><option value="ุนุฑุจูุฉ">ุนุฑุจูุฉ</option><option value="ูุฑูุณูุฉ">ูุฑูุณูุฉ</option>
              <option value="ุงูุฌููุฒูุฉ">ุงูุฌููุฒูุฉ</option><option value="ุนููู ุทุจูุนูุฉ">ุนููู ุทุจูุนูุฉ</option><option value="ููุฒูุงุก">ููุฒูุงุก</option>
              <option value="ุชุงุฑูุฎ ูุฌุบุฑุงููุง">ุชุงุฑูุฎ ูุฌุบุฑุงููุง</option><option value="ุชุฑุจูุฉ ูุฏููุฉ">ุชุฑุจูุฉ ูุฏููุฉ</option>
              <option value="ุชุฑุจูุฉ ุงุณูุงููุฉ">ุชุฑุจูุฉ ุงุณูุงููุฉ</option><option value="ุฑูุงุถุฉ">ุฑูุงุถุฉ</option>
              <option value="ุฅุนูุงู ุขูู">ุฅุนูุงู ุขูู</option><option value="ุฑุณู">ุฑุณู</option>
            </select>
            <input id="newHours" type="number" min="1" max="20" value="18" class="p-2 rounded bg-slate-800">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input id="newSections" placeholder="ุฃูุณุงู (ูุซุงู: 1ู1,2ู1)" class="p-2 rounded bg-slate-800 col-span-2">
            <button id="btnAddTeacher" class="btn bg-green-600">ุฅุถุงูุฉ ุฃุณุชุงุฐ</button>
            <button id="btnMyInst" class="btn bg-emerald-500">๐ซ ูุคุณุณุชู (ุชุญููู)</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold text-indigo-200">3. ุชูููุฏ / ุนุฑุถ / ุชุตุฏูุฑ</h2>
        <div class="flex gap-2 mt-2">
          <button id="btnGenerate" class="btn bg-indigo-600 w-full">โก ุชูููุฏ ุงูุฌุฏุงูู</button>
          <button id="btnRegen" class="btn bg-indigo-500 w-full">๐ ุฅุนุงุฏุฉ ุชูููุฏ</button>
        </div>
        <div class="mt-3">
          <label class="small muted">ุณุฑุนุฉ ุงูุฃุฏุงุก (ุณูุงู ร ุฃุฌูุงู)</label>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <input id="popSize" type="number" value="50" min="10" class="p-2 rounded bg-slate-800">
            <input id="generations" type="number" value="120" min="20" class="p-2 rounded bg-slate-800">
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="viewInstitution" class="btn bg-blue-600 w-full">๐ ุฌุฏูู ุงููุคุณุณุฉ</button>
          <div class="flex gap-2 mt-2">
            <select id="teacherSelector" class="w-full p-2 rounded bg-slate-800"></select>
            <button id="viewTeacherBtn" class="btn bg-blue-500">ุนุฑุถ</button>
          </div>
          <div class="flex gap-2 mt-2">
            <select id="classSelector" class="w-full p-2 rounded bg-slate-800"></select>
            <button id="viewClassBtn" class="btn bg-blue-500">ุนุฑุถ</button>
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="btnCopy" class="btn bg-sky-600 w-full">๐ ูุณุฎ HTML</button>
          <button id="btnCSV" class="btn bg-sky-700 w-full">๐ Excel (CSV)</button>
          <button id="btnPDF" class="btn bg-sky-400 w-full">๐ PDF</button>
        </div>
        <div class="mt-3">
          <div class="small muted">ุญุงูุฉ ุงูุชูููุฏ:</div>
          <div class="progressbar mt-1"><div id="progress" class="progress"></div></div>
          <div id="diagnostic" class="small muted mt-2">ุฌุงูุฒ.</div>
        </div>
      </div>
    </aside>

    <!-- output -->
    <main class="lg:col-span-3">
      <div id="outputArea" class="card min-h-[420px]">
        <p class="small muted">ุงููุชุงุฆุฌ ุณุชุธูุฑ ููุง ุจุนุฏ ุงูุถุบุท ุนูู ยซุชูููุฏ ุงูุฌุฏุงููยป.</p>
      </div>
    </main>
  </div>

  <footer class="text-sm text-slate-400 mt-6">ุงูุชุทุจูู ูุนุทู ุฌุฏููุงู ุตุงูุญุงู ุฏุงุฆูุงูุ ููุนุทู ุนุฏุฉ ุงุญุชูุงูุงุช ุนุจุฑ ุฅุนุงุฏุฉ ุงูุชูููุฏ. ููููู ุชุนุฏูู ุฃู ุฎููุฉ ู ุชุตุฏูุฑ ุงููุชุงุฆุฌ.</footer>
</div>

<script>
/* ---------------------- ุซูุงุจุช ูุจูุงูุงุช ุงูุชุฑุงุถูุฉ ---------------------- */
const DAYS = ['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00']; // 4 morning + 3 afternoon
const MAX_TEACHER = 20;
const TUESDAY_HALF = true; // ุงูุซูุงุซุงุก ูุตู ููู -> ุณููููุฏ ุจุนุฏ ุงูุธูุฑ ูุฃูู ุฃููููุฉ (ูููุน ุบุงูุจุงู)
const MORNING_SLOTS = SLOTS.slice(0,4);
const AFTERNOON_SLOTS = SLOTS.slice(4);
const DEFAULT_POP = 50, DEFAULT_GEN = 120;

/* ุณุงุนุงุช ุงูููุงุฏ ุญุณุจ ุงููุณุชูู (ุชูุฑูุจูุฉ ููุง ุทูุจุช) */
const subjectHours = {
  'ุฑูุงุถูุงุช': {'1':4,'2':4,'3':5,'4':5},
  'ุนุฑุจูุฉ': {'1':4,'2':4,'3':4,'4':4},
  'ูุฑูุณูุฉ': {'1':3,'2':3,'3':3,'4':3},
  'ุงูุฌููุฒูุฉ': {'1':3,'2':3,'3':3,'4':3},
  'ุนููู ุทุจูุนูุฉ': {'1':3,'2':3,'3':3,'4':3},
  'ููุฒูุงุก': {'1':2,'2':2,'3':2,'4':2},
  'ุชุงุฑูุฎ ูุฌุบุฑุงููุง': {'1':2,'2':2,'3':2,'4':2},
  'ุชุฑุจูุฉ ูุฏููุฉ': {'1':1,'2':1,'3':1,'4':1},
  'ุชุฑุจูุฉ ุงุณูุงููุฉ': {'1':2,'2':2,'3':2,'4':2},
  'ุฑูุงุถุฉ': {'1':2,'2':2,'3':2,'4':2},
  'ุฅุนูุงู ุขูู': {'1':1,'2':1,'3':1,'4':0},
  'ุฑุณู': {'1':1,'2':1,'3':1,'4':1}
};

/* ุฃูุงู ุจูุฏุงุบูุฌูุฉ: ูู ูุงุฏุฉ ููุง ููู ูุฎุตุต ูุง ูุถุน ูููุง ุญุตุต (ูุงุจูุฉ ููุชุนุฏูู ูุงุญูุงู) */
let pedagogicalDays = {
  'ุฑูุงุถูุงุช':'ุงูุฎููุณ','ุนุฑุจูุฉ':'ุงูุงุซููู','ูุฑูุณูุฉ':'ุงูุซูุงุซุงุก','ุงูุฌููุฒูุฉ':'ุงูุงุซููู','ุนููู ุทุจูุนูุฉ':'ุงูุฃุฑุจุนุงุก','ููุฒูุงุก':'ุงูุซูุงุซุงุก','ุฑุณู':'ุงูุฎููุณ','ุฅุนูุงู ุขูู':'ุงูุฃุฑุจุนุงุก'
};

/* ุญุงูุฉ ุงูุชุทุจูู */
let teachers = []; // each: {name, subject, sections:[], hoursRequested, totalAssigned}
let sectionsList = []; // ['1ู1', '1ู2', ...]
let lastSchedule = null; // structure: schedule[section][day][slot] = {subj, teacher, type}
let population = []; // for GA
let bestSolution = null;

/* ---------- DOM helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function randInt(max){ return Math.floor(Math.random()*max); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

/* ---------- UI wiring ---------- */
$('#lvl1').addEventListener('change', updateTotal);
$('#lvl2').addEventListener('change', updateTotal);
$('#lvl3').addEventListener('change', updateTotal);
$('#lvl4').addEventListener('change', updateTotal);
$('#btnAddTeacher').addEventListener('click', addTeacherFromInputs);
$('#btnMyInst').addEventListener('click', loadSampleInstitution);
$('#btnGenerate').addEventListener('click', ()=> runGenetic(false));
$('#btnRegen').addEventListener('click', ()=> runGenetic(true));
$('#viewInstitution').addEventListener('click', showInstitutionTable);
$('#viewTeacherBtn').addEventListener('click', ()=> showTeacherTable($('#teacherSelector').value));
$('#viewClassBtn').addEventListener('click', ()=> showClassTable($('#classSelector').value));
$('#btnCopy').addEventListener('click', copyHTML);
$('#btnCSV').addEventListener('click', exportCSV);
$('#btnPDF').addEventListener('click', exportPDF);

/* ---------- utility: update total sections ---------- */
function updateTotal(){
  const tot = (parseInt($('#lvl1').value||0)+parseInt($('#lvl2').value||0)+parseInt($('#lvl3').value||0)+parseInt($('#lvl4').value||0));
  $('#totalClasses').innerText = tot;
  buildSections();
}

/* ---------- build sections list ---------- */
function buildSections(){
  const arr=[];
  const l1 = parseInt($('#lvl1').value||0), l2 = parseInt($('#lvl2').value||0), l3 = parseInt($('#lvl3').value||0), l4 = parseInt($('#lvl4').value||0);
  for(let i=1;i<=l1;i++) arr.push(`1ู${i}`);
  for(let i=1;i<=l2;i++) arr.push(`2ู${i}`);
  for(let i=1;i<=l3;i++) arr.push(`3ู${i}`);
  for(let i=1;i<=l4;i++) arr.push(`4ู${i}`);
  sectionsList = arr;
  renderTeachersUI();
  return arr;
}

/* ---------- teachers UI ---------- */
function renderTeachersUI(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${t.sections && t.sections.length? t.sections.join(',') : 'โ'}</td><td class="p-2">${t.hoursRequested}</td><td class="p-2"><button onclick="deleteTeacher(${i})" class="px-2 py-1 bg-red-600 rounded text-xs">ุญุฐู</button></td>`;
    tbody.appendChild(tr);
  });
  const teacherSel = $('#teacherSelector'); teacherSel.innerHTML = '<option value="">ุงุฎุชุฑ ุฃุณุชุงุฐ</option>';
  teachers.forEach(t=> { const o=document.createElement('option'); o.value=t.name; o.textContent=`${t.name} โ ${t.subject}`; teacherSel.appendChild(o); });
  const classSel = $('#classSelector'); classSel.innerHTML = '<option value="">ุงุฎุชุฑ ูุณู</option>';
  sectionsList.forEach(s=> { const o=document.createElement('option'); o.value=s; o.textContent=s; classSel.appendChild(o); });
}
window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); };

/* ---------- add teacher ---------- */
function addTeacherFromInputs(){
  const name = $('#newName').value.trim(); const subj = $('#newSubject').value; const hours = parseInt($('#newHours').value||0); const secsRaw = $('#newSections').value.trim();
  if(!name || !subj || !hours){ alert('ุงููุฃ ุงุณู ุงูุฃุณุชุงุฐุ ุงููุงุฏุฉุ ูุนุฏุฏ ุงูุณุงุนุงุช'); return; }
  const secs = secsRaw? secsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
  teachers.push({name, subject:subj, sections:secs, hoursRequested: hours, totalAssigned:0});
  $('#newName').value=''; $('#newSections').value='';
  renderTeachersUI();
}

/* ---------- sample institution data (from your inputs) ---------- */
function loadSampleInstitution(){
  // reset
  teachers = []; $('#institutionName').value = 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด';
  $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2; updateTotal();
  // teachers (names from your list)
  const sample = [
    ['ูุฌูุจ','ุฑูุงุถูุงุช',[],20],['ูููุฑุฉ','ุฑูุงุถูุงุช',[],18],['ุฑูุฒู','ุฑูุงุถูุงุช',[],18],['ุฃูุงู','ุฑูุงุถูุงุช',[],18],
    ['ุตุจุฑููุฉ','ุนุฑุจูุฉ',[],18],['ูุฑูุฉ','ุนุฑุจูุฉ',[],18],['ุณุงุฑุฉ','ุนุฑุจูุฉ',[],18],['ูุญูุฏ','ุนุฑุจูุฉ',[],16],['ุนุงูุฑ','ุนุฑุจูุฉ',[],16],
    ['ุงูุนูุฏ','ูุฑูุณูุฉ',[],16],['ุณููู','ูุฑูุณูุฉ',[],16],['ุณุงุฑุฉ_ู','ูุฑูุณูุฉ',[],16],
    ['ุจูุจูุฑ','ุงูุฌููุฒูุฉ',[],12],['ูุดุงู','ุงูุฌููุฒูุฉ',[],12],['ุฃูููุฉ_ุงู','ุงูุฌููุฒูุฉ',[],14],
    ['ุนุงุฆุดุฉ','ุชุงุฑูุฎ ูุฌุบุฑุงููุง',[],12],['ูุงุทูุฉ','ุชุงุฑูุฎ ูุฌุบุฑุงููุง',[],10],['ุฃูุงู_ุช','ุชุงุฑูุฎ ูุฌุบุฑุงููุง',[],10],
    ['ูุณููุฉ','ุนููู ุทุจูุนูุฉ',[],12],['ุทุงูุณ','ุนููู ุทุจูุนูุฉ',[],12],
    ['ุนุจุฏ ุงูุฑุฒุงู','ููุฒูุงุก',[],12],['ุฃูููุฉ_ูู','ููุฒูุงุก',[],10],
    ['ุนูุงุก','ุฑูุงุถุฉ',[],8],['ุณููุฑ','ุฑูุงุถุฉ',[],8],
    ['ุณุนูุฏ','ุฑุณู',[],6],['ุฃูููุฉ_ุงุนูุงู','ุฅุนูุงู ุขูู',[],6],
    ['ูุนูู_ุงุณูุงูู','ุชุฑุจูุฉ ุงุณูุงููุฉ',[],8]
  ];
  for(const s of sample) teachers.push({name:s[0],subject:s[1],sections:s[2],hoursRequested:s[3],totalAssigned:0});
  renderTeachersUI();
  $('#showInstitution').innerText = $('#institutionName').value;
  $('#diagnostic').innerText = 'ุชู ุชุญููู ุจูุงูุงุช ุงููุคุณุณุฉ ุงููููุฐุฌูุฉ. ุงุถุบุท ุชูููุฏ.';
}

/* ---------- GA encoding ---------- 
We represent a chromosome as an array of length = totalSlots,
totalSlots = sectionsList.length * DAYS.length * SLOTS.length.
Each gene is either null or an assignment object {sec, subj, teacher}.
We prebuild tasks: for each section and each subject, create required number of task units (per week).
Population: many schedules created by shuffling tasks and filling slots.
Fitness: score higher = better. We'll compute penalties for:
 - conflicts (teacher double-booked at same day-slot)
 - section double assigned at same slot
 - missing required assignments (task not placed)
 - teacher hours > requested or > MAX_TEACHER (heavy penalty)
 - single evening hour for teacher (penalize)
 - pedagogical day violation (putting subject on its pedagogical day)
 - prefer math in morning (reward)
*/
function buildTasks(){
  const tasks = [];
  for(const sec of sectionsList){
    const lvl = sec.charAt(0);
    for(const subj in subjectHours){
      const hours = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(hours<=0) continue;
      // adjust: year 4 no info tech
      if(lvl==='4' && subj==='ุฅุนูุงู ุขูู') continue;
      // add hours units
      for(let i=0;i<hours;i++){
        tasks.push({section:sec, subject:subj});
      }
    }
    // special: ensure year 4 has ุฑุณู at least 1
    if(lvl==='4' && !tasks.some(t=>t.section===sec && t.subject==='ุฑุณู')){
      tasks.push({section:sec, subject:'ุฑุณู'});
    }
  }
  return tasks;
}

function totalSlotsCount(){ return sectionsList.length * DAYS.length * SLOTS.length; }
function slotIndexToDS(idx){
  const perSection = DAYS.length * SLOTS.length;
  const secIdx = Math.floor(idx / perSection);
  const rem = idx % perSection;
  const dayIdx = Math.floor(rem / SLOTS.length);
  const slotIdx = rem % SLOTS.length;
  return {secIdx, dayIdx, slotIdx};
}

/* ---------- create schedule object from chromosome ---------- */
function chromosomeToSchedule(chrom){
  // schedule[section][day][slot]
  const schedule = {};
  for(const s of sectionsList){
    schedule[s] = {};
    for(const d of DAYS){ schedule[s][d] = {}; for(const sl of SLOTS) schedule[s][d][sl] = null; }
  }
  const perSection = DAYS.length * SLOTS.length;
  for(let idx=0; idx<chrom.length; idx++){
    const gene = chrom[idx];
    const {secIdx, dayIdx, slotIdx} = slotIndexToDS(idx);
    const sec = sectionsList[secIdx];
    const day = DAYS[dayIdx];
    const slot = SLOTS[slotIdx];
    if(gene) schedule[sec][day][slot] = gene; // {section, subject, teacher}
  }
  return schedule;
}

/* ---------- initialize population ---------- */
function initPopulation(popSize){
  const tasks = buildTasks();
  const totalSlots = totalSlotsCount();
  const pop = [];
  for(let i=0;i<popSize;i++){
    // shuffle tasks
    const tcopy = shuffle(clone(tasks));
    const chrom = new Array(totalSlots).fill(null);
    // fill by slot order but random teacher selection among candidates
    let ptr = 0;
    for(const task of tcopy){
      // find next free slot for task
      // choose random slot index
      let placed = false;
      const attempts = totalSlots * 2;
      for(let a=0;a<attempts;a++){
        const idx = Math.floor(Math.random()*totalSlots);
        const {secIdx, dayIdx, slotIdx} = slotIndexToDS(idx);
        const sec = sectionsList[secIdx];
        if(sec !== task.section) continue; // only assign to correct section slot
        const day = DAYS[dayIdx];
        const slot = SLOTS[slotIdx];
        if(TUESDAY_HALF && day==='ุงูุซูุงุซุงุก' && slotIdx>=4) continue; // avoid Tue afternoon initially
        // pick candidate teacher for subject
        const cand = teachers.filter(t=> t.subject===task.subject);
        if(cand.length===0) continue;
        const teach = cand[Math.floor(Math.random()*cand.length)];
        if(!chrom[idx]){
          chrom[idx] = {section:task.section, subject:task.subject, teacher:teach.name, type:'official'};
          placed = true; break;
        }
      }
      // if not placed by random tries, do sequential place
      if(!placed){
        for(let j=0;j<totalSlots;j++){
          const {secIdx} = slotIndexToDS(j);
          if(sectionsList[secIdx] !== task.section) continue;
          if(!chrom[j]){
            const cand = teachers.filter(t=> t.subject===task.subject);
            const teach = cand.length? cand[0] : null;
            chrom[j] = teach? {section:task.section, subject:task.subject, teacher:teach.name, type:'official'} : null;
            placed = true; break;
          }
        }
      }
      // if still not placed -> skip (will penalize)
    }
    pop.push(chrom);
  }
  return pop;
}

/* ---------- fitness function ---------- */
function fitnessOfChrom(chrom){
  // compute schedule, teacher assignments, conflicts and penalties
  const schedule = chromosomeToSchedule(chrom);
  const teacherBusy = {}; // teacherBusy[name][day][slot] = count
  const teacherHours = {}; // teacherHours[name] = assigned count
  const sectionSlotCount = {}; // count assignments in section slot
  const missingTasksPenalty = 0;
  for(const t of teachers){ teacherBusy[t.name] = {}; for(const d of DAYS) teacherBusy[t.name][d] = {}; teacherHours[t.name]=0; for(const sl of SLOTS) teacherBusy[t.name][d][sl] = 0; }

  // iterate schedule
  let conflicts = 0;
  let placedCount = 0;
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of SLOTS){
        const cell = schedule[sec][d][s];
        if(cell){
          placedCount++;
          // teacher busy check
          teacherBusy[cell.teacher][d][s] = (teacherBusy[cell.teacher][d][s] || 0) + 1;
          if(teacherBusy[cell.teacher][d][s] > 1) conflicts += (teacherBusy[cell.teacher][d][s]-1);
          teacherHours[cell.teacher] = (teacherHours[cell.teacher]||0) + 1;
        }
      }
    }
  }

  // penalty: teacher exceeding requested hours or MAX_TEACHER
  let overPenalty = 0;
  for(const t of teachers){
    const h = teacherHours[t.name] || 0;
    // heavy penalty if >20
    if(h > MAX_TEACHER) overPenalty += (h - MAX_TEACHER) * 50;
    // penalty for exceeding requested hours? (we prefer not to exceed requested by much)
    if(h > t.hoursRequested) overPenalty += (h - t.hoursRequested) * 8;
  }

  // penalty for missing tasks: compute required tasks and compare placed
  const required = {};
  for(const sec of sectionsList){
    const lvl = sec.charAt(0);
    for(const subj in subjectHours){
      const hh = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(hh>0) required[`${sec}||${subj}`] = hh;
    }
    if(lvl==='4' && required[`${sec}||ุฅุนูุงู ุขูู`]) delete required[`${sec}||ุฅุนูุงู ุขูู`];
    if(lvl==='4' && !required[`${sec}||ุฑุณู`]) required[`${sec}||ุฑุณู`] = (required[`${sec}||ุฑุณู`]||0)+1;
  }
  // count placed per sec-subj
  const placed = {};
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of SLOTS){
        const cell = schedule[sec][d][s];
        if(cell){
          const key = `${sec}||${cell.subject}`;
          placed[key] = (placed[key]||0) + 1;
        }
      }
    }
  }
  let missingPenalty = 0;
  for(const key in required){
    const need = required[key]; const got = placed[key] || 0;
    if(got < need) missingPenalty += (need - got) * 30;
  }

  // penalty for single evening hour for a teacher (we require 0 or >=2)
  let singleEveningPenalty = 0;
  for(const t of teachers){
    // count evening hours for teacher across week
    let eveningHours = 0;
    for(const d of DAYS) for(const s of AFTERNOON_SLOTS){
      // if Tue afternoon and TUESDAY_HALF, it still counts but we avoid earlier
      for(const sec of sectionsList){
        const cell = schedule[sec][d][s];
        if(cell && cell.teacher === t.name) eveningHours++;
      }
    }
    if(eveningHours === 1) singleEveningPenalty += 40; // penalize single
    if(eveningHours > 0 && eveningHours < 2) singleEveningPenalty += 20;
  }

  // penalty for pedagogical days (subject placed on its pedagogical day)
  let pedPenalty = 0;
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of SLOTS){
        const cell = schedule[sec][d][s];
        if(cell){
          if(pedagogicalDays[cell.subject] && pedagogicalDays[cell.subject] === d) pedPenalty += 8;
        }
      }
    }
  }

  // reward for math in morning
  let mathMorningBonus = 0;
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of MORNING_SLOTS){
        const cell = schedule[sec][d][s];
        if(cell && cell.subject === 'ุฑูุงุถูุงุช') mathMorningBonus += 5;
      }
    }
  }

  // penalty for teacher double-book across sections same slot already counted as conflicts
  const conflictPenalty = conflicts * 25;

  // penalty for teacher gaps? We'll lightly penalize isolated single teaching hours between gaps (hard to compute here, skip heavy)
  // compute final score: higher is better
  const placedScore = placedCount * 2;
  const score = placedScore + mathMorningBonus - (missingPenalty + overPenalty + conflictPenalty + singleEveningPenalty + pedPenalty);
  return {score, schedule, details:{placedCount, missingPenalty, overPenalty, conflictPenalty, singleEveningPenalty, pedPenalty}};
}

/* ---------- GA operators ---------- */
function tournamentSelection(pop, scores){
  const k = 3;
  let best = null, bestIdx = -1;
  for(let i=0;i<k;i++){
    const idx = randInt(pop.length);
    if(best === null || scores[idx].score > best){
      best = scores[idx].score; bestIdx = idx;
    }
  }
  return clone(pop[bestIdx]);
}

function crossover(a,b){
  // one-point crossover
  const L = a.length;
  const pt = randInt(L);
  const c1 = a.slice(0,pt).concat(b.slice(pt));
  const c2 = b.slice(0,pt).concat(a.slice(pt));
  return [c1,c2];
}

function mutate(chrom, mutationRate=0.01){
  const L = chrom.length;
  for(let i=0;i<L;i++){
    if(Math.random() < mutationRate){
      // swap with another random index
      const j = randInt(L);
      const tmp = chrom[i]; chrom[i] = chrom[j]; chrom[j] = tmp;
    }
  }
}

/* ---------- GA main loop ---------- */
async function runGenetic(isRegen){
  // validations
  buildSections();
  if(sectionsList.length===0){ alert('ูู ุชูุนุฑูู ุฃูุณุงู. ุงุถุบุท "ูุคุณุณุชู" ุฃู ุฃุฏุฎู ุนุฏุฏ ุงูุฃูุณุงู.'); return; }
  if(teachers.length===0){ if(confirm('ูุงุฆูุฉ ุงูุฃุณุงุชุฐุฉ ูุงุฑุบุฉ. ุชุญููู ูุคุณุณุชูุ')) loadSampleInstitution(); else return; }

  $('#diagnostic').innerText = 'ุฌุงุฑู ุงูุชูููุฏ โ ุจุฏุงูุฉ ุงูุฎูุงุฑุฒููุฉ...';
  const popSize = parseInt($('#popSize').value) || DEFAULT_POP;
  const gens = parseInt($('#generations').value) || DEFAULT_GEN;
  const mutationRate = 0.02;

  // init population
  population = initPopulation(popSize);
  let best = null, bestScore = -Infinity, bestDetails = null;
  for(let g=0; g<gens; g++){
    const scores = population.map(ch => fitnessOfChrom(ch));
    // track best
    for(let i=0;i<scores.length;i++){
      if(scores[i].score > bestScore){
        bestScore = scores[i].score; best = clone(population[i]); bestDetails = scores[i].details;
      }
    }
    // update progress
    const percent = Math.round((g+1)/gens*100);
    $('#progress').style.width = percent + '%';
    $('#diagnostic').innerText = `ุฌูู ${g+1}/${gens} โ ุฃูุถู ูุชูุฌุฉ ุญุชู ุงูุขู: ${Math.round(bestScore)} ููุงุท โ (ุงูููุงู ุงููุนููุฉ: ${bestDetails?bestDetails.placedCount:0})`;

    // create new population
    const newPop = [];
    // elitism: keep top 2
    const sortedIdx = scores.map((s,i)=>({s:s.score,i})).sort((a,b)=>b.s-a.s).map(x=>x.i);
    if(sortedIdx.length>0) newPop.push(clone(population[sortedIdx[0]]));
    if(sortedIdx.length>1) newPop.push(clone(population[sortedIdx[1]]));

    while(newPop.length < popSize){
      const parentA = tournamentSelection(population, scores);
      const parentB = tournamentSelection(population, scores);
      let [c1,c2] = crossover(parentA,parentB);
      mutate(c1, mutationRate); mutate(c2, mutationRate);
      newPop.push(c1);
      if(newPop.length < popSize) newPop.push(c2);
    }
    population = newPop;
    // yield to UI
    if(g%10===0) await new Promise(r=>setTimeout(r,5));
  }

  // final best
  bestSolution = best;
  lastSchedule = chromosomeToSchedule(bestSolution);
  // compute final fitness and details
  const finalFit = fitnessOfChrom(bestSolution);
  $('#diagnostic').innerText = `ุชู ุงูุชูููุฏ โ ุฃูุถู ูุชูุฌุฉ: ${Math.round(finalFit.score)} ููุงุท. ููุฎุต ููุงุญุธุงุช: ${composeNotes(finalFit.details)}`;
  $('#progress').style.width = '100%';
  // render institution table
  showInstitutionTable();
}

/* ---------- compose notes text from details ---------- */
function composeNotes(details){
  const arr = [];
  if(!details) return '';
  if(details.missingPenalty) arr.push(`ุญุตุต ูุงูุตุฉ (ูููุฉ ุนููุจุฉ ${details.missingPenalty})`);
  if(details.overPenalty) arr.push(`ุชุฌุงูุฒ ูุตุงุจ/ุฒูุงุฏุฉ (ุนููุจุฉ ${details.overPenalty})`);
  if(details.conflictPenalty) arr.push(`ุชุถุงุฑุจ/ุญุฌูุฒุงุช ูุชูุฑุฑุฉ (ุนููุจุฉ ${details.conflictPenalty})`);
  if(details.singleEveningPenalty) arr.push(`ุญุตุฉ ูุณุงุฆูุฉ ูููุฑุฏุฉ (ุนููุจุฉ ${details.singleEveningPenalty})`);
  if(details.pedPenalty) arr.push(`ุฃูุงู ุจูุฏุงุบูุฌูุฉ ูุฎุงููุฉ (ุนููุจุฉ ${details.pedPenalty})`);
  if(arr.length===0) return 'โ๏ธ ุฌุฏูู ุฌูุฏ';
  return arr.join('ุ ');
}

/* ---------- display functions ---------- */
function showInstitutionTable(){
  if(!lastSchedule){ $('#outputArea').innerHTML = `<p class="small muted">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ. ุงุถุบุท ุชูููุฏ.</p>`; return; }
  const sections = sectionsList.slice();
  const out = $('#outputArea'); out.innerHTML = '';
  out.insertAdjacentHTML('beforeend', `<h2 class="text-xl text-indigo-300">${$('#institutionName').value || 'ุงููุคุณุณุฉ'}</h2><div class="small muted">ุนุฑุถ ุงุณุชุนูุงู ุงูุฒูู ูููุคุณุณุฉ โ ุงูุฃูุณุงู: ${sections.join(', ')}</div>`);

  for(const d of DAYS){
    out.insertAdjacentHTML('beforeend', `<h3 class="text-lg text-indigo-200 mt-4">${d}</h3>`);
    let html = `<div class="overflow-auto"><table class="schedule-table bg-white text-black"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
    sections.forEach(s=> html += `<th>${s}</th>`);
    html += `</tr></thead><tbody>`;
    for(const slot of SLOTS){
      html += `<tr><td>${slot}</td>`;
      for(const sec of sections){
        const c = lastSchedule[sec][d][slot];
        if(c) html += `<td contenteditable="true" class="slot-official editable">${c.subject}<br/><small>${c.teacher}</small></td>`;
        else {
          if(slot === '13:00-14:00') html += `<td contenteditable="true" class="slot-break">ุฑุงุญุฉ</td>`;
          else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true" class="slot-free">โ</td>`;
          else html += `<td contenteditable="true" class="slot-free">ูุฑุงุบ</td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</tbody></table></div>`;
    out.insertAdjacentHTML('beforeend', html);
  }
}

function showTeacherTable(teacherName){
  if(!teacherName){ alert('ุงุฎุชุฑ ุฃุณุชุงุฐูุง'); return; }
  if(!lastSchedule){ alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ. ุงุถุบุท ุชูููุฏ'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">ุฌุฏูู ุงูุฃุณุชุงุฐ ${teacherName}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      let found = null;
      for(const sec of sectionsList){
        const cell = lastSchedule[sec][d][slot];
        if(cell && cell.teacher === teacherName){ found = {sec,c:cell}; break; }
      }
      if(found) html += `<td contenteditable="true" class="slot-official editable">${found.sec}<br/><small>${found.c.subject}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="slot-break">ุฑุงุญุฉ</td>`;
        else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true" class="slot-free">โ</td>`;
        else html += `<td contenteditable="true" class="slot-free">ูุฑุงุบ</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

function showClassTable(section){
  if(!section){ alert('ุงุฎุชุฑ ูุณููุง'); return; }
  if(!lastSchedule){ alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ. ุงุถุบุท ุชูููุฏ'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">ุฌุฏูู ุงููุณู ${section}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      const c = lastSchedule[section][d][slot];
      if(c) html += `<td contenteditable="true" class="slot-official editable">${c.subject}<br/><small>${c.teacher}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="slot-break">ุฑุงุญุฉ</td>`;
        else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true" class="slot-free">โ</td>`;
        else html += `<td contenteditable="true" class="slot-free">ูุฑุงุบ</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

/* ---------- export / copy ---------- */
function copyHTML(){
  navigator.clipboard.writeText($('#outputArea').innerHTML).then(()=> alert('ุชู ูุณุฎ HTML'));
}
function exportCSV(){
  if(!lastSchedule){ alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ'); return; }
  let csv = '';
  for(const sec of sectionsList){
    csv += `ูุณู ${sec}\n`;
    csv += `ุงูุณุงุนุฉ,${DAYS.join(',')}\n`;
    for(const slot of SLOTS){
      const row = [slot];
      for(const d of DAYS){
        const c = lastSchedule[sec][d][slot];
        row.push(c? `${c.subject} (${c.teacher})` : (slot==='13:00-14:00'?'ุฑุงุญุฉ':'ูุฑุงุบ'));
      }
      csv += row.map(x=>`"${x}"`).join(',') + '\n';
    }
    csv += '\n';
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schedules.csv'; a.click(); URL.revokeObjectURL(a.href);
}
async function exportPDF(){
  if(!lastSchedule){ alert('ูุง ุชูุฌุฏ ูุชุงุฆุฌ'); return; }
  if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
  if(typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  const out = $('#outputArea');
  const canvas = await html2canvas(out, {scale:1.2,useCORS:true, backgroundColor: '#07182a'});
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','mm','a4');
  const w = pdf.internal.pageSize.getWidth();
  const h = (canvas.height * w) / canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h);
  pdf.save('schedules.pdf');
}
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src = src; s.onload = res; s.onerror = rej; document.head.appendChild(s); }); }

/* ---------- initialization ---------- */
updateTotal();
renderTeachersUI();
loadSampleInstitution();

</script>
</body>
</html>
