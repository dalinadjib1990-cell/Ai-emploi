<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ai_dali_nadjib_emploi_cem â€” Ù…ÙˆÙ„Ø¯ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù† (GA)</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { background: linear-gradient(180deg,#071025,#051022); color: #e6eef6; font-family: Inter, system-ui, Arial; }
  .card { background: #07182a; border-radius: 10px; padding: 14px; box-shadow: 0 6px 20px rgba(2,6,23,.6); }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid rgba(255,255,255,0.06); padding: 6px; text-align: center; font-size: 13px; }
  .slot-official { background: #7dd3fc; color: #022c3a; font-weight:700; }
  .slot-remedial { background: #fde68a; color: #1b1b00; }
  .slot-project { background: #86efac; color: #04200b; }
  .slot-free { background: #9b7bd6; color: #0f0420; }
  .slot-break { background: #ffd7a6; color: #120800; }
  .small { font-size:12px; color:#93c5fd; }
  .muted { color: #9fb7d9; }
  .btn { padding: 8px 12px; border-radius:8px; font-weight:700; }
  .progressbar { height:8px; background:#0b1220; border-radius:6px; overflow:hidden; }
  .progress { height:100%; background:linear-gradient(90deg,#06b6d4,#7c3aed); width:0%; }
  .editable { min-height:24px; }
</style>
</head>
<body>
<div class="max-w-7xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-indigo-300">Ai_dali_nadjib_emploi_cem â€” Ù…ÙˆÙ„Ø¯ Ø§Ø³ØªØ¹Ù…Ù„ Ø²Ù…Ù† Ø°ÙƒÙŠ (GA)</h1>
      <div class="small muted">Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙŠØ¹Ù…Ù„ â€” ÙŠØ¹Ø·ÙŠ Ø­Ù„ÙˆÙ„ Ù…ØªØ¹Ø¯Ø¯Ø© Ø¹Ù†Ø¯ ÙƒÙ„ ØªÙˆÙ„ÙŠØ¯. Ø£ÙˆÙ„ÙˆÙŠØ©: ØªÙˆÙ„ÙŠØ¯ ØµØ§Ù„Ø­ Ø«Ù… ØªØ­Ø³ÙŠÙ† Ø±Ø§Ø­Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©.</div>
    </div>
    <div class="text-right">
      <div class="muted">Ù…Ø¤Ø³Ø³Ø©: <span id="showInstitution" class="font-bold">â€”</span></div>
      <div class="muted">Ø£Ø³ØªØ§Ø° Ù†Ù…ÙˆØ°Ø¬ÙŠ: <span id="showTeacher" class="font-bold">Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨ â€” Ø±ÙŠØ§Ø¶ÙŠØ§Øª</span></div>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- controls -->
    <aside class="lg:col-span-1 space-y-4">
      <div class="card">
        <h2 class="text-lg font-bold text-indigo-200">1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h2>
        <label class="block small muted mt-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
        <input id="institutionName" class="w-full p-2 rounded bg-slate-800 text-white" placeholder="Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´" value="Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´">
        <div class="grid grid-cols-2 gap-2 mt-3">
          <label class="small">Ø³Ù†Ø© 1Ù…: <input id="lvl1" type="number" min="0" value="5" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          <label class="small">Ø³Ù†Ø© 2Ù…: <input id="lvl2" type="number" min="0" value="4" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          <label class="small">Ø³Ù†Ø© 3Ù…: <input id="lvl3" type="number" min="0" value="3" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          <label class="small">Ø³Ù†Ø© 4Ù…: <input id="lvl4" type="number" min="0" value="2" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
        </div>
        <div class="mt-2 small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: <strong id="totalClasses">14</strong></div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold text-indigo-200">2. Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</h2>
        <div class="small muted">Ù‚Ø§Ø¦Ù…Ø© Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„. Ù†ØµØ§Ø¨ Ø£Ù‚ØµÙ‰: <strong>20</strong> Ø³Ø§Ø¹Ø©.</div>
        <div class="mt-2 overflow-auto" style="max-height:280px">
          <table id="teachersTable" class="w-full text-sm">
            <thead><tr class="muted"><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</th><th>Ø³Ø§Ø¹Ø§Øª</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt-3 grid grid-cols-1 gap-2">
          <div class="grid grid-cols-3 gap-2">
            <input id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°" class="p-2 rounded bg-slate-800">
            <select id="newSubject" class="p-2 rounded bg-slate-800">
              <option value="Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option value="Ø¹Ø±Ø¨ÙŠØ©">Ø¹Ø±Ø¨ÙŠØ©</option><option value="ÙØ±Ù†Ø³ÙŠØ©">ÙØ±Ù†Ø³ÙŠØ©</option>
              <option value="Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©">Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option><option value="Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©">Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©</option><option value="ÙÙŠØ²ÙŠØ§Ø¡">ÙÙŠØ²ÙŠØ§Ø¡</option>
              <option value="ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§">ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§</option><option value="ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©">ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©</option>
              <option value="ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©">ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option value="Ø±ÙŠØ§Ø¶Ø©">Ø±ÙŠØ§Ø¶Ø©</option>
              <option value="Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ">Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ</option><option value="Ø±Ø³Ù…">Ø±Ø³Ù…</option>
            </select>
            <input id="newHours" type="number" min="1" max="20" value="18" class="p-2 rounded bg-slate-800">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input id="newSections" placeholder="Ø£Ù‚Ø³Ø§Ù… (Ù…Ø«Ø§Ù„: 1Ù…1,2Ù…1)" class="p-2 rounded bg-slate-800 col-span-2">
            <button id="btnAddTeacher" class="btn bg-green-600">Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø°</button>
            <button id="btnMyInst" class="btn bg-emerald-500">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ (ØªØ­Ù…ÙŠÙ„)</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold text-indigo-200">3. ØªÙˆÙ„ÙŠØ¯ / Ø¹Ø±Ø¶ / ØªØµØ¯ÙŠØ±</h2>
        <div class="flex gap-2 mt-2">
          <button id="btnGenerate" class="btn bg-indigo-600 w-full">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
          <button id="btnRegen" class="btn bg-indigo-500 w-full">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯</button>
        </div>
        <div class="mt-3">
          <label class="small muted">Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø³ÙƒØ§Ù† Ã— Ø£Ø¬ÙŠØ§Ù„)</label>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <input id="popSize" type="number" value="50" min="10" class="p-2 rounded bg-slate-800">
            <input id="generations" type="number" value="120" min="20" class="p-2 rounded bg-slate-800">
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="viewInstitution" class="btn bg-blue-600 w-full">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</button>
          <div class="flex gap-2 mt-2">
            <select id="teacherSelector" class="w-full p-2 rounded bg-slate-800"></select>
            <button id="viewTeacherBtn" class="btn bg-blue-500">Ø¹Ø±Ø¶</button>
          </div>
          <div class="flex gap-2 mt-2">
            <select id="classSelector" class="w-full p-2 rounded bg-slate-800"></select>
            <button id="viewClassBtn" class="btn bg-blue-500">Ø¹Ø±Ø¶</button>
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="btnCopy" class="btn bg-sky-600 w-full">ğŸ“‹ Ù†Ø³Ø® HTML</button>
          <button id="btnCSV" class="btn bg-sky-700 w-full">ğŸ“Š Excel (CSV)</button>
          <button id="btnPDF" class="btn bg-sky-400 w-full">ğŸ“„ PDF</button>
        </div>
        <div class="mt-3">
          <div class="small muted">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯:</div>
          <div class="progressbar mt-1"><div id="progress" class="progress"></div></div>
          <div id="diagnostic" class="small muted mt-2">Ø¬Ø§Ù‡Ø².</div>
        </div>
      </div>
    </aside>

    <!-- output -->
    <main class="lg:col-span-3">
      <div id="outputArea" class="card min-h-[420px]">
        <p class="small muted">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„Â».</p>
      </div>
    </main>
  </div>

  <footer class="text-sm text-slate-400 mt-6">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ø·ÙŠ Ø¬Ø¯ÙˆÙ„Ø§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ ÙˆÙŠØ¹Ø·ÙŠ Ø¹Ø¯Ø© Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø¹Ø¨Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø®Ù„ÙŠØ© Ùˆ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</footer>
</div>

<script>
/* ---------------------- Ø«ÙˆØ§Ø¨Øª ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ---------------------- */
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00']; // 4 morning + 3 afternoon
const MAX_TEACHER = 20;
const TUESDAY_HALF = true; // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ Ù†ØµÙ ÙŠÙˆÙ… -> Ø³Ù†Ù‚ÙŠÙ‘Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø± ÙƒØ£Ù‚Ù„ Ø£ÙˆÙ„ÙˆÙŠØ© (Ù†Ù…Ù†Ø¹ ØºØ§Ù„Ø¨Ø§Ù‹)
const MORNING_SLOTS = SLOTS.slice(0,4);
const AFTERNOON_SLOTS = SLOTS.slice(4);
const DEFAULT_POP = 50, DEFAULT_GEN = 120;

/* Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª) */
const subjectHours = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª': {'1':4,'2':4,'3':5,'4':5},
  'Ø¹Ø±Ø¨ÙŠØ©': {'1':4,'2':4,'3':4,'4':4},
  'ÙØ±Ù†Ø³ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'ÙÙŠØ²ÙŠØ§Ø¡': {'1':2,'2':2,'3':2,'4':2},
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§': {'1':2,'2':2,'3':2,'4':2},
  'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©': {'1':1,'2':1,'3':1,'4':1},
  'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©': {'1':2,'2':2,'3':2,'4':2},
  'Ø±ÙŠØ§Ø¶Ø©': {'1':2,'2':2,'3':2,'4':2},
  'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ': {'1':1,'2':1,'3':1,'4':0},
  'Ø±Ø³Ù…': {'1':1,'2':1,'3':1,'4':1}
};

/* Ø£ÙŠØ§Ù… Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠØ©: ÙƒÙ„ Ù…Ø§Ø¯Ø© Ù„Ù‡Ø§ ÙŠÙˆÙ… Ù…Ø®ØµØµ Ù„Ø§ Ù†Ø¶Ø¹ ÙÙŠÙ‡Ø§ Ø­ØµØµ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹) */
let pedagogicalDays = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¹Ø±Ø¨ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','ÙØ±Ù†Ø³ÙŠØ©':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','ÙÙŠØ²ÙŠØ§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø±Ø³Ù…':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'
};

/* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
let teachers = []; // each: {name, subject, sections:[], hoursRequested, totalAssigned}
let sectionsList = []; // ['1Ù…1', '1Ù…2', ...]
let lastSchedule = null; // structure: schedule[section][day][slot] = {subj, teacher, type}
let population = []; // for GA
let bestSolution = null;

/* ---------- DOM helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function randInt(max){ return Math.floor(Math.random()*max); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

/* ---------- UI wiring ---------- */
$('#lvl1').addEventListener('change', updateTotal);
$('#lvl2').addEventListener('change', updateTotal);
$('#lvl3').addEventListener('change', updateTotal);
$('#lvl4').addEventListener('change', updateTotal);
$('#btnAddTeacher').addEventListener('click', addTeacherFromInputs);
$('#btnMyInst').addEventListener('click', loadSampleInstitution);
$('#btnGenerate').addEventListener('click', ()=> runGenetic(false));
$('#btnRegen').addEventListener('click', ()=> runGenetic(true));
$('#viewInstitution').addEventListener('click', showInstitutionTable);
$('#viewTeacherBtn').addEventListener('click', ()=> showTeacherTable($('#teacherSelector').value));
$('#viewClassBtn').addEventListener('click', ()=> showClassTable($('#classSelector').value));
$('#btnCopy').addEventListener('click', copyHTML);
$('#btnCSV').addEventListener('click', exportCSV);
$('#btnPDF').addEventListener('click', exportPDF);

/* ---------- utility: update total sections ---------- */
function updateTotal(){
  const tot = (parseInt($('#lvl1').value||0)+parseInt($('#lvl2').value||0)+parseInt($('#lvl3').value||0)+parseInt($('#lvl4').value||0));
  $('#totalClasses').innerText = tot;
  buildSections();
}

/* ---------- build sections list ---------- */
function buildSections(){
  const arr=[];
  const l1 = parseInt($('#lvl1').value||0), l2 = parseInt($('#lvl2').value||0), l3 = parseInt($('#lvl3').value||0), l4 = parseInt($('#lvl4').value||0);
  for(let i=1;i<=l1;i++) arr.push(`1Ù…${i}`);
  for(let i=1;i<=l2;i++) arr.push(`2Ù…${i}`);
  for(let i=1;i<=l3;i++) arr.push(`3Ù…${i}`);
  for(let i=1;i<=l4;i++) arr.push(`4Ù…${i}`);
  sectionsList = arr;
  renderTeachersUI();
  return arr;
}

/* ---------- teachers UI ---------- */
function renderTeachersUI(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${t.sections && t.sections.length? t.sections.join(',') : 'â€”'}</td><td class="p-2">${t.hoursRequested}</td><td class="p-2"><button onclick="deleteTeacher(${i})" class="px-2 py-1 bg-red-600 rounded text-xs">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  const teacherSel = $('#teacherSelector'); teacherSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°</option>';
  teachers.forEach(t=> { const o=document.createElement('option'); o.value=t.name; o.textContent=`${t.name} â€” ${t.subject}`; teacherSel.appendChild(o); });
  const classSel = $('#classSelector'); classSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…</option>';
  sectionsList.forEach(s=> { const o=document.createElement('option'); o.value=s; o.textContent=s; classSel.appendChild(o); });
}
window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); };

/* ---------- add teacher ---------- */
function addTeacherFromInputs(){
  const name = $('#newName').value.trim(); const subj = $('#newSubject').value; const hours = parseInt($('#newHours').value||0); const secsRaw = $('#newSections').value.trim();
  if(!name || !subj || !hours){ alert('Ø§Ù…Ù„Ø£ Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª'); return; }
  const secs = secsRaw? secsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
  teachers.push({name, subject:subj, sections:secs, hoursRequested: hours, totalAssigned:0});
  $('#newName').value=''; $('#newSections').value='';
  renderTeachersUI();
}

/* ---------- sample institution data (from your inputs) ---------- */
function loadSampleInstitution(){
  // reset
  teachers = []; $('#institutionName').value = 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2; updateTotal();
  // teachers (names from your list)
  const sample = [
    ['Ù†Ø¬ÙŠØ¨','Ø±ÙŠØ§Ø¶ÙŠØ§Øª',[],20],['Ù…Ù†ÙŠØ±Ø©','Ø±ÙŠØ§Ø¶ÙŠØ§Øª',[],18],['Ø±Ù…Ø²ÙŠ','Ø±ÙŠØ§Ø¶ÙŠØ§Øª',[],18],['Ø£Ù…Ø§Ù„','Ø±ÙŠØ§Ø¶ÙŠØ§Øª',[],18],
    ['ØµØ¨Ø±ÙŠÙ†Ø©','Ø¹Ø±Ø¨ÙŠØ©',[],18],['Ù…Ø±ÙˆØ©','Ø¹Ø±Ø¨ÙŠØ©',[],18],['Ø³Ø§Ø±Ø©','Ø¹Ø±Ø¨ÙŠØ©',[],18],['ÙˆØ­ÙŠØ¯','Ø¹Ø±Ø¨ÙŠØ©',[],16],['Ø¹Ø§Ù…Ø±','Ø¹Ø±Ø¨ÙŠØ©',[],16],
    ['Ø§Ù„Ø¹ÙŠØ¯','ÙØ±Ù†Ø³ÙŠØ©',[],16],['Ø³Ù„Ù…Ù‰','ÙØ±Ù†Ø³ÙŠØ©',[],16],['Ø³Ø§Ø±Ø©_Ù','ÙØ±Ù†Ø³ÙŠØ©',[],16],
    ['Ø¨ÙˆØ¨ÙƒØ±','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',[],12],['Ù‡Ø´Ø§Ù…','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',[],12],['Ø£Ù…ÙŠÙ†Ø©_Ø§Ù†','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',[],14],
    ['Ø¹Ø§Ø¦Ø´Ø©','ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',[],12],['ÙØ§Ø·Ù…Ø©','ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',[],10],['Ø£Ù…Ø§Ù„_Øª','ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',[],10],
    ['ÙˆØ³ÙŠÙ„Ø©','Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',[],12],['Ø·Ø§ÙˆØ³','Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',[],12],
    ['Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚','ÙÙŠØ²ÙŠØ§Ø¡',[],12],['Ø£Ù…ÙŠÙ†Ø©_ÙÙŠ','ÙÙŠØ²ÙŠØ§Ø¡',[],10],
    ['Ø¹Ù„Ø§Ø¡','Ø±ÙŠØ§Ø¶Ø©',[],8],['Ø³Ù…ÙŠØ±','Ø±ÙŠØ§Ø¶Ø©',[],8],
    ['Ø³Ø¹ÙŠØ¯','Ø±Ø³Ù…',[],6],['Ø£Ù…ÙŠÙ†Ø©_Ø§Ø¹Ù„Ø§Ù…','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ',[],6],
    ['Ù…Ø¹Ù„Ù…_Ø§Ø³Ù„Ø§Ù…ÙŠ','ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©',[],8]
  ];
  for(const s of sample) teachers.push({name:s[0],subject:s[1],sections:s[2],hoursRequested:s[3],totalAssigned:0});
  renderTeachersUI();
  $('#showInstitution').innerText = $('#institutionName').value;
  $('#diagnostic').innerText = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.';
}

/* ---------- GA encoding ---------- 
We represent a chromosome as an array of length = totalSlots,
totalSlots = sectionsList.length * DAYS.length * SLOTS.length.
Each gene is either null or an assignment object {sec, subj, teacher}.
We prebuild tasks: for each section and each subject, create required number of task units (per week).
Population: many schedules created by shuffling tasks and filling slots.
Fitness: score higher = better. We'll compute penalties for:
 - conflicts (teacher double-booked at same day-slot)
 - section double assigned at same slot
 - missing required assignments (task not placed)
 - teacher hours > requested or > MAX_TEACHER (heavy penalty)
 - single evening hour for teacher (penalize)
 - pedagogical day violation (putting subject on its pedagogical day)
 - prefer math in morning (reward)
*/
function buildTasks(){
  const tasks = [];
  for(const sec of sectionsList){
    const lvl = sec.charAt(0);
    for(const subj in subjectHours){
      const hours = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(hours<=0) continue;
      // adjust: year 4 no info tech
      if(lvl==='4' && subj==='Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ') continue;
      // add hours units
      for(let i=0;i<hours;i++){
        tasks.push({section:sec, subject:subj});
      }
    }
    // special: ensure year 4 has Ø±Ø³Ù… at least 1
    if(lvl==='4' && !tasks.some(t=>t.section===sec && t.subject==='Ø±Ø³Ù…')){
      tasks.push({section:sec, subject:'Ø±Ø³Ù…'});
    }
  }
  return tasks;
}

function totalSlotsCount(){ return sectionsList.length * DAYS.length * SLOTS.length; }
function slotIndexToDS(idx){
  const perSection = DAYS.length * SLOTS.length;
  const secIdx = Math.floor(idx / perSection);
  const rem = idx % perSection;
  const dayIdx = Math.floor(rem / SLOTS.length);
  const slotIdx = rem % SLOTS.length;
  return {secIdx, dayIdx, slotIdx};
}

/* ---------- create schedule object from chromosome ---------- */
function chromosomeToSchedule(chrom){
  // schedule[section][day][slot]
  const schedule = {};
  for(const s of sectionsList){
    schedule[s] = {};
    for(const d of DAYS){ schedule[s][d] = {}; for(const sl of SLOTS) schedule[s][d][sl] = null; }
  }
  const perSection = DAYS.length * SLOTS.length;
  for(let idx=0; idx<chrom.length; idx++){
    const gene = chrom[idx];
    const {secIdx, dayIdx, slotIdx} = slotIndexToDS(idx);
    const sec = sectionsList[secIdx];
    const day = DAYS[dayIdx];
    const slot = SLOTS[slotIdx];
    if(gene) schedule[sec][day][slot] = gene; // {section, subject, teacher}
  }
  return schedule;
}

/* ---------- initialize population ---------- */
function initPopulation(popSize){
  const tasks = buildTasks();
  const totalSlots = totalSlotsCount();
  const pop = [];
  for(let i=0;i<popSize;i++){
    // shuffle tasks
    const tcopy = shuffle(clone(tasks));
    const chrom = new Array(totalSlots).fill(null);
    // fill by slot order but random teacher selection among candidates
    let ptr = 0;
    for(const task of tcopy){
      // find next free slot for task
      // choose random slot index
      let placed = false;
      const attempts = totalSlots * 2;
      for(let a=0;a<attempts;a++){
        const idx = Math.floor(Math.random()*totalSlots);
        const {secIdx, dayIdx, slotIdx} = slotIndexToDS(idx);
        const sec = sectionsList[secIdx];
        if(sec !== task.section) continue; // only assign to correct section slot
        const day = DAYS[dayIdx];
        const slot = SLOTS[slotIdx];
        if(TUESDAY_HALF && day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && slotIdx>=4) continue; // avoid Tue afternoon initially
        // pick candidate teacher for subject
        const cand = teachers.filter(t=> t.subject===task.subject);
        if(cand.length===0) continue;
        const teach = cand[Math.floor(Math.random()*cand.length)];
        if(!chrom[idx]){
          chrom[idx] = {section:task.section, subject:task.subject, teacher:teach.name, type:'official'};
          placed = true; break;
        }
      }
      // if not placed by random tries, do sequential place
      if(!placed){
        for(let j=0;j<totalSlots;j++){
          const {secIdx} = slotIndexToDS(j);
          if(sectionsList[secIdx] !== task.section) continue;
          if(!chrom[j]){
            const cand = teachers.filter(t=> t.subject===task.subject);
            const teach = cand.length? cand[0] : null;
            chrom[j] = teach? {section:task.section, subject:task.subject, teacher:teach.name, type:'official'} : null;
            placed = true; break;
          }
        }
      }
      // if still not placed -> skip (will penalize)
    }
    pop.push(chrom);
  }
  return pop;
}

/* ---------- fitness function ---------- */
function fitnessOfChrom(chrom){
  // compute schedule, teacher assignments, conflicts and penalties
  const schedule = chromosomeToSchedule(chrom);
  const teacherBusy = {}; // teacherBusy[name][day][slot] = count
  const teacherHours = {}; // teacherHours[name] = assigned count
  const sectionSlotCount = {}; // count assignments in section slot
  const missingTasksPenalty = 0;
  for(const t of teachers){ teacherBusy[t.name] = {}; for(const d of DAYS) teacherBusy[t.name][d] = {}; teacherHours[t.name]=0; for(const sl of SLOTS) teacherBusy[t.name][d][sl] = 0; }

  // iterate schedule
  let conflicts = 0;
  let placedCount = 0;
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of SLOTS){
        const cell = schedule[sec][d][s];
        if(cell){
          placedCount++;
          // teacher busy check
          teacherBusy[cell.teacher][d][s] = (teacherBusy[cell.teacher][d][s] || 0) + 1;
          if(teacherBusy[cell.teacher][d][s] > 1) conflicts += (teacherBusy[cell.teacher][d][s]-1);
          teacherHours[cell.teacher] = (teacherHours[cell.teacher]||0) + 1;
        }
      }
    }
  }

  // penalty: teacher exceeding requested hours or MAX_TEACHER
  let overPenalty = 0;
  for(const t of teachers){
    const h = teacherHours[t.name] || 0;
    // heavy penalty if >20
    if(h > MAX_TEACHER) overPenalty += (h - MAX_TEACHER) * 50;
    // penalty for exceeding requested hours? (we prefer not to exceed requested by much)
    if(h > t.hoursRequested) overPenalty += (h - t.hoursRequested) * 8;
  }

  // penalty for missing tasks: compute required tasks and compare placed
  const required = {};
  for(const sec of sectionsList){
    const lvl = sec.charAt(0);
    for(const subj in subjectHours){
      const hh = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(hh>0) required[`${sec}||${subj}`] = hh;
    }
    if(lvl==='4' && required[`${sec}||Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ`]) delete required[`${sec}||Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ`];
    if(lvl==='4' && !required[`${sec}||Ø±Ø³Ù…`]) required[`${sec}||Ø±Ø³Ù…`] = (required[`${sec}||Ø±Ø³Ù…`]||0)+1;
  }
  // count placed per sec-subj
  const placed = {};
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of SLOTS){
        const cell = schedule[sec][d][s];
        if(cell){
          const key = `${sec}||${cell.subject}`;
          placed[key] = (placed[key]||0) + 1;
        }
      }
    }
  }
  let missingPenalty = 0;
  for(const key in required){
    const need = required[key]; const got = placed[key] || 0;
    if(got < need) missingPenalty += (need - got) * 30;
  }

  // penalty for single evening hour for a teacher (we require 0 or >=2)
  let singleEveningPenalty = 0;
  for(const t of teachers){
    // count evening hours for teacher across week
    let eveningHours = 0;
    for(const d of DAYS) for(const s of AFTERNOON_SLOTS){
      // if Tue afternoon and TUESDAY_HALF, it still counts but we avoid earlier
      for(const sec of sectionsList){
        const cell = schedule[sec][d][s];
        if(cell && cell.teacher === t.name) eveningHours++;
      }
    }
    if(eveningHours === 1) singleEveningPenalty += 40; // penalize single
    if(eveningHours > 0 && eveningHours < 2) singleEveningPenalty += 20;
  }

  // penalty for pedagogical days (subject placed on its pedagogical day)
  let pedPenalty = 0;
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of SLOTS){
        const cell = schedule[sec][d][s];
        if(cell){
          if(pedagogicalDays[cell.subject] && pedagogicalDays[cell.subject] === d) pedPenalty += 8;
        }
      }
    }
  }

  // reward for math in morning
  let mathMorningBonus = 0;
  for(const sec of sectionsList){
    for(const d of DAYS){
      for(const s of MORNING_SLOTS){
        const cell = schedule[sec][d][s];
        if(cell && cell.subject === 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª') mathMorningBonus += 5;
      }
    }
  }

  // penalty for teacher double-book across sections same slot already counted as conflicts
  const conflictPenalty = conflicts * 25;

  // penalty for teacher gaps? We'll lightly penalize isolated single teaching hours between gaps (hard to compute here, skip heavy)
  // compute final score: higher is better
  const placedScore = placedCount * 2;
  const score = placedScore + mathMorningBonus - (missingPenalty + overPenalty + conflictPenalty + singleEveningPenalty + pedPenalty);
  return {score, schedule, details:{placedCount, missingPenalty, overPenalty, conflictPenalty, singleEveningPenalty, pedPenalty}};
}

/* ---------- GA operators ---------- */
function tournamentSelection(pop, scores){
  const k = 3;
  let best = null, bestIdx = -1;
  for(let i=0;i<k;i++){
    const idx = randInt(pop.length);
    if(best === null || scores[idx].score > best){
      best = scores[idx].score; bestIdx = idx;
    }
  }
  return clone(pop[bestIdx]);
}

function crossover(a,b){
  // one-point crossover
  const L = a.length;
  const pt = randInt(L);
  const c1 = a.slice(0,pt).concat(b.slice(pt));
  const c2 = b.slice(0,pt).concat(a.slice(pt));
  return [c1,c2];
}

function mutate(chrom, mutationRate=0.01){
  const L = chrom.length;
  for(let i=0;i<L;i++){
    if(Math.random() < mutationRate){
      // swap with another random index
      const j = randInt(L);
      const tmp = chrom[i]; chrom[i] = chrom[j]; chrom[j] = tmp;
    }
  }
}

/* ---------- GA main loop ---------- */
async function runGenetic(isRegen){
  // validations
  buildSections();
  if(sectionsList.length===0){ alert('Ù„Ù… ØªÙØ¹Ø±Ù‘Ù Ø£Ù‚Ø³Ø§Ù…. Ø§Ø¶ØºØ· "Ù…Ø¤Ø³Ø³ØªÙŠ" Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….'); return; }
  if(teachers.length===0){ if(confirm('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙØ§Ø±ØºØ©. ØªØ­Ù…ÙŠÙ„ Ù…Ø¤Ø³Ø³ØªÙŠØŸ')) loadSampleInstitution(); else return; }

  $('#diagnostic').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ â€” Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©...';
  const popSize = parseInt($('#popSize').value) || DEFAULT_POP;
  const gens = parseInt($('#generations').value) || DEFAULT_GEN;
  const mutationRate = 0.02;

  // init population
  population = initPopulation(popSize);
  let best = null, bestScore = -Infinity, bestDetails = null;
  for(let g=0; g<gens; g++){
    const scores = population.map(ch => fitnessOfChrom(ch));
    // track best
    for(let i=0;i<scores.length;i++){
      if(scores[i].score > bestScore){
        bestScore = scores[i].score; best = clone(population[i]); bestDetails = scores[i].details;
      }
    }
    // update progress
    const percent = Math.round((g+1)/gens*100);
    $('#progress').style.width = percent + '%';
    $('#diagnostic').innerText = `Ø¬ÙŠÙ„ ${g+1}/${gens} â€” Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: ${Math.round(bestScore)} Ù†Ù‚Ø§Ø· â€” (Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹ÙŠÙ†Ø©: ${bestDetails?bestDetails.placedCount:0})`;

    // create new population
    const newPop = [];
    // elitism: keep top 2
    const sortedIdx = scores.map((s,i)=>({s:s.score,i})).sort((a,b)=>b.s-a.s).map(x=>x.i);
    if(sortedIdx.length>0) newPop.push(clone(population[sortedIdx[0]]));
    if(sortedIdx.length>1) newPop.push(clone(population[sortedIdx[1]]));

    while(newPop.length < popSize){
      const parentA = tournamentSelection(population, scores);
      const parentB = tournamentSelection(population, scores);
      let [c1,c2] = crossover(parentA,parentB);
      mutate(c1, mutationRate); mutate(c2, mutationRate);
      newPop.push(c1);
      if(newPop.length < popSize) newPop.push(c2);
    }
    population = newPop;
    // yield to UI
    if(g%10===0) await new Promise(r=>setTimeout(r,5));
  }

  // final best
  bestSolution = best;
  lastSchedule = chromosomeToSchedule(bestSolution);
  // compute final fitness and details
  const finalFit = fitnessOfChrom(bestSolution);
  $('#diagnostic').innerText = `ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ â€” Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©: ${Math.round(finalFit.score)} Ù†Ù‚Ø§Ø·. Ù…Ù„Ø®Øµ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${composeNotes(finalFit.details)}`;
  $('#progress').style.width = '100%';
  // render institution table
  showInstitutionTable();
}

/* ---------- compose notes text from details ---------- */
function composeNotes(details){
  const arr = [];
  if(!details) return '';
  if(details.missingPenalty) arr.push(`Ø­ØµØµ Ù†Ø§Ù‚ØµØ© (Ù‚ÙŠÙ…Ø© Ø¹Ù‚ÙˆØ¨Ø© ${details.missingPenalty})`);
  if(details.overPenalty) arr.push(`ØªØ¬Ø§ÙˆØ² Ù†ØµØ§Ø¨/Ø²ÙŠØ§Ø¯Ø© (Ø¹Ù‚ÙˆØ¨Ø© ${details.overPenalty})`);
  if(details.conflictPenalty) arr.push(`ØªØ¶Ø§Ø±Ø¨/Ø­Ø¬ÙˆØ²Ø§Øª Ù…ØªÙƒØ±Ø±Ø© (Ø¹Ù‚ÙˆØ¨Ø© ${details.conflictPenalty})`);
  if(details.singleEveningPenalty) arr.push(`Ø­ØµØ© Ù…Ø³Ø§Ø¦ÙŠØ© Ù…Ù†ÙØ±Ø¯Ø© (Ø¹Ù‚ÙˆØ¨Ø© ${details.singleEveningPenalty})`);
  if(details.pedPenalty) arr.push(`Ø£ÙŠØ§Ù… Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠØ© Ù…Ø®Ø§Ù„ÙØ© (Ø¹Ù‚ÙˆØ¨Ø© ${details.pedPenalty})`);
  if(arr.length===0) return 'âœ”ï¸ Ø¬Ø¯ÙˆÙ„ Ø¬ÙŠØ¯';
  return arr.join('Ø› ');
}

/* ---------- display functions ---------- */
function showInstitutionTable(){
  if(!lastSchedule){ $('#outputArea').innerHTML = `<p class="small muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.</p>`; return; }
  const sections = sectionsList.slice();
  const out = $('#outputArea'); out.innerHTML = '';
  out.insertAdjacentHTML('beforeend', `<h2 class="text-xl text-indigo-300">${$('#institutionName').value || 'Ø§Ù„Ù…Ø¤Ø³Ø³Ø©'}</h2><div class="small muted">Ø¹Ø±Ø¶ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù† Ù„Ù„Ù…Ø¤Ø³Ø³Ø© â€” Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${sections.join(', ')}</div>`);

  for(const d of DAYS){
    out.insertAdjacentHTML('beforeend', `<h3 class="text-lg text-indigo-200 mt-4">${d}</h3>`);
    let html = `<div class="overflow-auto"><table class="schedule-table bg-white text-black"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    sections.forEach(s=> html += `<th>${s}</th>`);
    html += `</tr></thead><tbody>`;
    for(const slot of SLOTS){
      html += `<tr><td>${slot}</td>`;
      for(const sec of sections){
        const c = lastSchedule[sec][d][slot];
        if(c) html += `<td contenteditable="true" class="slot-official editable">${c.subject}<br/><small>${c.teacher}</small></td>`;
        else {
          if(slot === '13:00-14:00') html += `<td contenteditable="true" class="slot-break">Ø±Ø§Ø­Ø©</td>`;
          else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true" class="slot-free">â€”</td>`;
          else html += `<td contenteditable="true" class="slot-free">ÙØ±Ø§Øº</td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</tbody></table></div>`;
    out.insertAdjacentHTML('beforeend', html);
  }
}

function showTeacherTable(teacherName){
  if(!teacherName){ alert('Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°Ù‹Ø§'); return; }
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø° ${teacherName}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      let found = null;
      for(const sec of sectionsList){
        const cell = lastSchedule[sec][d][slot];
        if(cell && cell.teacher === teacherName){ found = {sec,c:cell}; break; }
      }
      if(found) html += `<td contenteditable="true" class="slot-official editable">${found.sec}<br/><small>${found.c.subject}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="slot-break">Ø±Ø§Ø­Ø©</td>`;
        else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true" class="slot-free">â€”</td>`;
        else html += `<td contenteditable="true" class="slot-free">ÙØ±Ø§Øº</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

function showClassTable(section){
  if(!section){ alert('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§'); return; }
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø³Ù… ${section}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      const c = lastSchedule[section][d][slot];
      if(c) html += `<td contenteditable="true" class="slot-official editable">${c.subject}<br/><small>${c.teacher}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="slot-break">Ø±Ø§Ø­Ø©</td>`;
        else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true" class="slot-free">â€”</td>`;
        else html += `<td contenteditable="true" class="slot-free">ÙØ±Ø§Øº</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

/* ---------- export / copy ---------- */
function copyHTML(){
  navigator.clipboard.writeText($('#outputArea').innerHTML).then(()=> alert('ØªÙ… Ù†Ø³Ø® HTML'));
}
function exportCSV(){
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬'); return; }
  let csv = '';
  for(const sec of sectionsList){
    csv += `Ù‚Ø³Ù… ${sec}\n`;
    csv += `Ø§Ù„Ø³Ø§Ø¹Ø©,${DAYS.join(',')}\n`;
    for(const slot of SLOTS){
      const row = [slot];
      for(const d of DAYS){
        const c = lastSchedule[sec][d][slot];
        row.push(c? `${c.subject} (${c.teacher})` : (slot==='13:00-14:00'?'Ø±Ø§Ø­Ø©':'ÙØ±Ø§Øº'));
      }
      csv += row.map(x=>`"${x}"`).join(',') + '\n';
    }
    csv += '\n';
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schedules.csv'; a.click(); URL.revokeObjectURL(a.href);
}
async function exportPDF(){
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬'); return; }
  if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
  if(typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  const out = $('#outputArea');
  const canvas = await html2canvas(out, {scale:1.2,useCORS:true, backgroundColor: '#07182a'});
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','mm','a4');
  const w = pdf.internal.pageSize.getWidth();
  const h = (canvas.height * w) / canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h);
  pdf.save('schedules.pdf');
}
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src = src; s.onload = res; s.onerror = rej; document.head.appendChild(s); }); }

/* ---------- initialization ---------- */
updateTotal();
renderTeachersUI();
loadSampleInstitution();

</script>
</body>
</html>
