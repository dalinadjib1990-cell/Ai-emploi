<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Dali Emploi - Ù…ÙˆÙ„Ø¯ Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ø²Ù…Ù†</title>
<!-- small styles -->
<style>
  :root{--bg:#0f1720;--card:#111827;--accent:#5D5CDE;--muted:#94a3b8}
  body{margin:0;font-family:Tahoma,Arial;background:var(--bg);color:#fff;direction:rtl}
  .wrap{max-width:1200px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:20px;color:var(--accent)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  button.ghost{background:#263043}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="number"],input[type="text"],select{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1116;color:#fff}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid #24303a;padding:6px;text-align:center}
  th{background:#0b1220}
  .small{font-size:12px;color:var(--muted)}
  .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid #fff}
  .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
  .tabBtn{padding:6px 10px;border-radius:8px;background:#0b1220;color:var(--muted);cursor:pointer;border:1px solid #1f2937}
  .tabBtn.active{background:var(--accent);color:#fff}
  .outputArea{margin-top:12px}
  .schedule{overflow:auto;background:#071018;padding:10px;border-radius:8px}
  .slot{min-width:120px}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .legend span{padding:6px 10px;border-radius:6px;font-weight:600}
  .official{background:#90EE90;color:#000}
  .remedial{background:#FFFF99;color:#000}
  .project{background:#66c66b;color:#000}
  .free{background:#ffffff;color:#000}
  .break{background:#e2e8f0;color:#000}
  .notice{color:#fca5a5;font-weight:700;margin-top:8px}
  /* responsive */
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>AI Dali Emploi en CEM â€” Ù…ÙˆÙ„Ø¯ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù†</h1>
        <div class="small">ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ø§Ø¶ØºØ· "Ù…Ø¤Ø³Ø³ØªÙŠ" Ù„Ø±Ø¤ÙŠØ© Ù…Ø«Ø§Ù„ Ø«Ù… "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„"</div>
      </div>
      <div class="top-right">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="imgInput" type="file" accept="image/*" style="display:none" onchange="loadAvatar(event)">
          <img id="avatar" class="avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='%23222'/><text x='50%' y='55%' font-size='60' fill='%23fff' text-anchor='middle' font-family='Arial'>Ø¹</text></svg>">
          <div>
            <button class="ghost" onclick="document.getElementById('imgInput').click()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
            <div class="small">ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø¯Ø§Ø¦Ø±ÙŠØ©)</div>
          </div>
        </div>
        <div class="small">Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ</div>
      </div>
    </header>

    <div class="grid">
      <!-- left column: setup -->
      <div>
        <div class="card">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <input id="institutionName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù†ÙˆØ±">
          <div style="display:flex;gap:10px;margin-top:10px">
            <div style="flex:1">
              <label>1Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl1" type="number" min="0" value="5" onchange="updateTotal()" />
            </div>
            <div style="flex:1">
              <label>2Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl2" type="number" min="0" value="3" onchange="updateTotal()" />
            </div>
            <div style="flex:1">
              <label>3Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl3" type="number" min="0" value="3" onchange="updateTotal()" />
            </div>
            <div style="flex:1">
              <label>4Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
              <input id="lvl4" type="number" min="0" value="2" onchange="updateTotal()" />
            </div>
          </div>
          <div style="margin-top:8px"><strong>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…:</strong> <span id="totalClasses">13</span></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px 0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (Ø£Ø¶Ù/Ø­Ø°Ù)</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input id="tName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°">
            <select id="tSubject">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
              <option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option>Ø¹Ø±Ø¨ÙŠØ©</option><option>ÙØ±Ù†Ø³ÙŠØ©</option><option>Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
              <option>ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§</option><option>ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©</option><option>Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©</option>
              <option>ÙÙŠØ²ÙŠØ§Ø¡</option><option>ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option>Ø±ÙŠØ§Ø¶Ø©</option>
              <option>Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ</option><option>Ø±Ø³Ù…</option>
            </select>
            <input id="tSections" type="text" placeholder="Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù…Ø«Ø§Ù„: 4Ù…1,4Ù…2)">
            <input id="tHours" type="number" min="1" max="20" placeholder="Ø³Ø§Ø¹Ø§Øª/Ø£Ø³Ø¨ÙˆØ¹" style="width:110px">
            <button onclick="addTeacher()" style="background:#10b981;padding:8px 10px;border-radius:8px">Ø¥Ø¶Ø§ÙØ©</button>
          </div>

          <div style="max-height:220px;overflow:auto">
            <table id="teachersTable">
              <thead><tr><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</th><th>Ø³/Ø£Ø³Ø¨ÙˆØ¹</th><th>Ø­Ø°Ù</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="small" style="margin-top:8px;color:#94a3b8">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªÙƒØªØ¨ Ø¨ØµÙŠØºØ© 4Ù…1,3Ù…2 ...</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button onclick="loadMyInstitution()" class="">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ</button>
          <button onclick="resetAll()" class="ghost">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
          <button onclick="generate()" style="background:#06b6d4">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
          <button onclick="copyOutput()" class="ghost">ğŸ“‹ Ù†Ø³Ø® HTML</button>
          <button onclick="exportPDF()" class="ghost">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="legend">
            <span class="official">Ø­ØµØ© Ø±Ø³Ù…ÙŠØ©</span>
            <span class="remedial">Ø§Ø³ØªØ¯Ø±Ø§Ùƒ</span>
            <span class="project">Ø£Ø¹Ù…Ø§Ù„ Ù…ÙˆØ¬Ù‡Ø©</span>
            <span class="free">ÙØ±Ø§Øº</span>
            <span class="break">Ø§Ø³ØªØ±Ø§Ø­Ø©</span>
          </div>
          <div class="notice">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙˆÙ„ÙŠØ¯" ÙŠØ¹Ø·ÙŠ Ø­Ù„Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù„ÙƒÙ†Ù‡ ÙŠØ­ØªØ±Ù… Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.</div>
        </div>
      </div>

      <!-- right column: preview / institution summary -->
      <div>
        <div class="card">
          <h3 style="margin:0 0 8px 0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
          <div><strong>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©:</strong> <span id="showInstitution">â€”</span></div>
          <div><strong>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:</strong> 08:00-15:00 (Ø§Ø³ØªØ±Ø§Ø­Ø© 12-13)</div>
          <div style="margin-top:8px"><strong>Ø§Ù„ÙŠÙˆÙ… Ù†ØµÙ Ø§Ù„Ø¹Ù…Ù„:</strong> Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø§Ø¹Ø© 12:00)</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px 0">ØªØ­Ø¯ÙŠØ¯ ÙŠÙˆÙ… Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠ Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø© (ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <select id="pdMath"><option>Ø§Ù„Ø®Ù…ÙŠØ³</option><option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option></select>
            <select id="pdArabic"><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option><option>Ø§Ù„Ø£Ø­Ø¯</option></select>
            <select id="pdFrench"><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option></select>
            <select id="pdEng"><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option></select>
          </div>
        </div>
      </div>
    </div>

    <!-- output -->
    <div class="outputArea" id="outputArea" style="margin-top:18px"></div>
  </div>

<script>
/* ===== data and helpers ===== */
let teachers = []; // {name,subject,sections:[],hours,totalAssigned}
let institution = {name:'',levels:{'1':5,'2':3,'3':3,'4':2}};
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
const SLOT_BREAK = '12:00-13:00';
const MAX_HOUR=20;
const subjHours = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':{'1':4,'2':4,'3':5,'4':5},
  'Ø¹Ø±Ø¨ÙŠØ©':{'1':4,'2':4,'3':4,'4':4},
  'ÙØ±Ù†Ø³ÙŠØ©':{'1':3,'2':3,'3':3,'4':3},
  'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':{'1':3,'2':3,'3':3,'4':3},
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':{'1':3,'2':3,'3':3,'4':3},
  'ÙÙŠØ²ÙŠØ§Ø¡':{'1':2,'2':2,'3':2,'4':2},
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':{'1':2,'2':2,'3':2,'4':2},
  'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':{'1':1,'2':1,'3':1,'4':1},
  'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':{'1':2,'2':2,'3':2,'4':2},
  'Ø±ÙŠØ§Ø¶Ø©':{'1':2,'2':2,'3':2,'4':2},
  'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':{'1':1,'2':1,'3':1,'4':0},
  'Ø±Ø³Ù…':{'1':1,'2':1,'3':1,'4':1}
};
/* pedagogical days default */
let pedagogical = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¹Ø±Ø¨ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','ÙØ±Ù†Ø³ÙŠØ©':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†',
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':'Ø§Ù„Ø£Ø­Ø¯','ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':'Ø§Ù„Ø£Ø­Ø¯','ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†',
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','ÙÙŠØ²ÙŠØ§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø±Ø³Ù…':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'
};
/* helpers */
function q(sel){return document.querySelector(sel)}
function updateTotal(){ 
  institution.levels['1']=parseInt(q('#lvl1').value||0);
  institution.levels['2']=parseInt(q('#lvl2').value||0);
  institution.levels['3']=parseInt(q('#lvl3').value||0);
  institution.levels['4']=parseInt(q('#lvl4').value||0);
  const total = Object.values(institution.levels).reduce((a,b)=>a+b,0);
  q('#totalClasses').innerText = total;
}
function addTeacher(){
  const name = q('#tName').value.trim(); if(!name){alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°');return}
  const subject = q('#tSubject').value; if(!subject){alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©');return}
  const sections = q('#tSections').value.split(',').map(s=>s.trim()).filter(Boolean);
  const hours = parseInt(q('#tHours').value) || Math.min(6,MAX_HOUR);
  teachers.push({name,subject,sections,hours,totalAssigned:0});
  q('#tName').value=''; q('#tSections').value=''; q('#tHours').value='';
  renderTeachers();
}
function renderTeachers(){
  const body = q('#teachersTable tbody'); body.innerHTML='';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td><td>${t.subject}</td><td>${t.sections.join(',')||'â€”'}</td><td>${t.hours}</td><td><button onclick="delTeacher(${i})">Ø­Ø°Ù</button></td>`;
    body.appendChild(tr);
  });
}
function delTeacher(i){teachers.splice(i,1); renderTeachers()}

/* avatar */
function loadAvatar(e){
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  q('#avatar').src = url;
}

/* load sample institution (user data provided) */
function loadMyInstitution(){
  resetAll();
  q('#institutionName').value = 'Ù…ØªÙˆØ³Ø·Ø© Ù„Ø§Ø±Ø§ (Ù†Ù…ÙˆØ°Ø¬)';
  q('#lvl1').value=5; q('#lvl2').value=3; q('#lvl3').value=4; q('#lvl4').value=2; updateTotal();
  // teachers list based on earlier user list (sample distribution)
  const sample = [
    {name:'Ù†Ø¬ÙŠØ¨',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:['4Ù…1','3Ù…1'],hours:18},
    {name:'Ù…Ù†ÙŠØ±Ø©',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:['4Ù…2','2Ù…1'],hours:18},
    {name:'Ø±Ù…Ø²ÙŠ',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:['4Ù…3','1Ù…1'],hours:18},
    {name:'Ø£Ù…Ø§Ù„',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:['1Ù…2','2Ù…2'],hours:18},
    {name:'ØµØ¨Ø±ÙŠÙ†Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:['1Ù…1','1Ù…3'],hours:18},
    {name:'Ù…Ø±ÙˆØ©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:['1m4','2Ù…1'],hours:18},
    {name:'Ø³Ø§Ø±Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:['3Ù…1','3Ù…2'],hours:18},
    {name:'ÙˆØ­ÙŠØ¯',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:['2Ù…2'],hours:16},
    {name:'Ø¹Ø§Ù…Ø±',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:['4Ù…2'],hours:16},
    {name:'Ø§Ù„Ø¹ÙŠØ¯',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:['1Ù…1'],hours:15},
    {name:'Ø³Ù„Ù…Ù‰',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:['2Ù…1'],hours:15},
    {name:'Ø£Ù…ÙŠØ±Ø©',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:['3Ù…1'],hours:15},
    {name:'Ø¨ÙˆØ¨ÙƒØ±',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:['1Ù…1'],hours:12},
    {name:'Ù‡Ø´Ø§Ù…',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:['2Ù…1'],hours:12},
    {name:'Ø£Ù…ÙŠÙ†Ø©',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:['3Ù…1','4Ù…2','4Ù…1'],hours:16},
    {name:'Ø¹Ø§Ø¦Ø´Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:['1Ù…1','2Ù…1'],hours:12},
    {name:'ÙØ§Ø·Ù…Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:['3Ù…1'],hours:10},
    {name:'ÙˆØ³ÙŠÙ„Ø©',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:['1Ù…1','2Ù…1'],hours:10},
    {name:'Ø·Ø§ÙˆØ³',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:['3Ù…1','4Ù…1'],hours:10},
    {name:'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:['4Ù…1','4Ù…2'],hours:8},
    {name:'Ø³Ù…ÙŠØ±',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:['1Ù…1','2Ù…1'],hours:8},
    {name:'Ø¹Ù„Ø§Ø¡',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:['3Ù…1'],hours:8},
    {name:'Ø³Ø¹ÙŠØ¯',subject:'Ø±Ø³Ù…',sections:['4Ù…1','4Ù…2'],hours:4},
    {name:'Ø§Ù…ÙŠÙ†Ù‡_Ø§Ø¹Ù„Ø§Ù…',subject:'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ',sections:['1Ù…1','2Ù…1'],hours:6},
    {name:'Ø§Ù…ÙŠÙ†Ù‡',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:['3Ù…2'],hours:6},
    {name:'Ø¹Ø§Ù…Ù„_Ù…Ø´ØªØ±Ùƒ',subject:'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©',sections:['1Ù…1','2Ù…1'],hours:6},
    {name:'Ù…ÙˆØ¬ÙˆØ¯',subject:'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©',sections:['1Ù…1','2Ù…1'],hours:6}
  ];
  // clear teachers and push
  teachers = [];
  sample.forEach(s=>teachers.push({...s, totalAssigned:0}));
  renderTeachers();
  q('#showInstitution').innerText = q('#institutionName').value;
}

/* reset all */
function resetAll(){
  teachers = []; renderTeachers();
  q('#institutionName').value=''; q('#lvl1').value=0; q('#lvl2').value=0; q('#lvl3').value=0; q('#lvl4').value=0; updateTotal();
  q('#outputArea').innerHTML='';
}

/* ===== scheduling algorithm (greedy + retries) ===== */
function generate(){
  // basic checks
  if(teachers.length===0){ if(!confirm('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙØ§Ø±ØºØ©. ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙŠØŸ')) return; loadMyInstitution(); }
  // build sections list from levels
  const secs = [];
  Object.entries(institution.levels).forEach(([lvl,cnt])=>{
    for(let i=1;i<=cnt;i++) secs.push(`${lvl}Ù…${i}`);
  });
  // build per-class subject requirements based on subjHours
  const classReq = {}; // class -> {subject:remaining}
  secs.forEach(sec=>{
    const levelNum = sec.charAt(0); // '1'..'4'
    classReq[sec] = {};
    for(const subj in subjHours){
      const h = subjHours[subj][levelNum];
      if(h && h>0) classReq[sec][subj]=h;
    }
    // special: 4Ù… has Ø±Ø³Ù… instead of Ø§Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ
    if(levelNum==='4'){ if(classReq[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']) delete classReq[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']; classReq[sec]['Ø±Ø³Ù…']=1; }
  });

  // build teacher availability map: teacherName -> day -> slot -> boolean
  const teacherAvail = {};
  teachers.forEach(t=>{ teacherAvail[t.name] = {}; DAYS.forEach(d=>{ teacherAvail[t.name][d] = {}; SLOTS.forEach(s=>teacherAvail[t.name][d][s]=true) }) });

  // don't schedule into break or into Tuesday afternoons
  const allowedSlots = {};
  DAYS.forEach(d=>{ allowedSlots[d] = SLOTS.filter(s=> !(s==='13:00-14:00' || s==='14:00-15:00' || s==='15:00-16:00') ? true : true) });
  // adjust for Tuesday half-day: remove slots after 11:00-12:00 (i.e., slots with index>=4 are afternoon)
  // we will check when placing

  // institution schedule initialize
  const schedule = {}; // schedule[class][day][slot] = {subj, teacher, type}
  secs.forEach(sec=>{ schedule[sec]={}; DAYS.forEach(d=>{ schedule[sec][d] = {}; SLOTS.forEach(s=> schedule[sec][d][s]=null) }) });

  // teacher assigned hours counter
  const teacherHours = {}; teachers.forEach(t=>teacherHours[t.name]=0);

  // helper: find teacher for subject who can teach that section
  function findTeachersFor(subject,section){
    // prefer teachers who have this section in their list
    let cand = teachers.filter(t=>t.subject===subject && t.sections.includes(section));
    if(cand.length) return cand;
    // else any teacher who teaches subject
    cand = teachers.filter(t=>t.subject===subject);
    return cand;
  }

  // list of slots order preference (morning first), with Tuesday half-day enforced later
  function slotListFor(day){
    // morning slots indices 0..3 (08..12), afternoon 4..5 (13..15), remedial 6
    const arr = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
    // if day is Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ remove afternoon and remedial
    if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡') return arr.slice(0,4);
    return arr;
  }

  // random shuffle
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  // main greedy: for each class, for each subject, place its hours
  const MAX_TRIES = 6;
  let success=false;
  for(let attempt=0; attempt<MAX_TRIES && !success; attempt++){
    // reset
    for(const sec of secs) for(const d of DAYS) for(const s of SLOTS) schedule[sec][d][s]=null;
    for(const t of teachers) teacherHours[t.name]=0;
    // shuffle order to get different solutions
    const classOrder = shuffle([...secs]);
    let failed=false;

    for(const sec of classOrder){
      const levelNum = sec.charAt(0);
      // create subject list sorted by descending hours so heavy subjects place first
      const subjList = Object.keys(classReq[sec]).sort((a,b)=> (classReq[sec][b]-classReq[sec][a]));
      for(const subj of subjList){
        let remaining = classReq[sec][subj];
        let placementAttempts=0;
        // try to place each required hour
        while(remaining>0){
          placementAttempts++;
          if(placementAttempts>200){ failed=true; break; }
          // choose day randomly but avoid pedagogical day for subj
          let daysPool = shuffle(DAYS.slice());
          let placed=false;
          for(const day of daysPool){
            if(pedagogical[subj]===day) continue; // skip pedagogical day
            // avoid putting more than 2 occurrences same subj same day
            const sameDayCount = SLOTS.reduce((acc,s)=> acc + (schedule[sec][day][s] && schedule[sec][day][s].subj===subj ? 1:0),0);
            if(sameDayCount>=2) continue;
            // get slot list for day, prefer morning for math
            let slots = slotListFor(day);
            if(subj==='Ø±ÙŠØ§Ø¶ÙŠØ§Øª') slots = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
            slots = shuffle(slots.slice());
            for(const slot of slots){
              // no scheduling into break
              if(slot==='12:00-13:00') continue;
              // avoid remedial slot unless it's last resort or remedial subject
              if(slot==='15:00-16:00' && Math.random()>0.4) continue;
              // check if class slot free
              if(schedule[sec][day][slot]) continue;
              // find teacher candidates
              const cands = shuffle(findTeachersFor(subj,sec));
              let teacherPicked=null;
              for(const cand of cands){
                // teacher must have remaining hours allowance
                if(teacherHours[cand.name] >= cand.hours || teacherHours[cand.name]>=MAX_HOUR) continue;
                // teacher must be free at that slot: check other classes assigned
                let teacherBusy=false;
                for(const otherClass of secs){
                  if(otherClass===sec) continue;
                  const x = schedule[otherClass][day][slot];
                  if(x && x.teacher===cand.name){ teacherBusy=true; break; }
                }
                if(teacherBusy) continue;
                teacherPicked=cand; break;
              }
              if(!teacherPicked) continue;
              // commit
              schedule[sec][day][slot] = {subj,teacher:teacherPicked.name,type:'official'};
              teacherHours[teacherPicked.name] += 1;
              remaining--; placed=true; break;
            }
            if(placed) break;
          } // end daysPool
          if(!placed && remaining>0){
            // if cannot place directly, try to use remedial slot specifically
            let remedialPlaced=false;
            for(const day of DAYS){
              if(pedagogical[subj]===day) continue;
              if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡') continue;
              const slot='15:00-16:00';
              if(schedule[sec][day][slot]) continue;
              const cands = shuffle(findTeachersFor(subj,sec));
              let teacherPicked=null;
              for(const cand of cands){
                if(teacherHours[cand.name] >= cand.hours || teacherHours[cand.name]>=MAX_HOUR) continue;
                let teacherBusy=false;
                for(const otherClass of secs){
                  if(otherClass===sec) continue;
                  const x = schedule[otherClass][day][slot];
                  if(x && x.teacher===cand.name){ teacherBusy=true; break; }
                }
                if(teacherBusy) continue;
                teacherPicked=cand; break;
              }
              if(!teacherPicked) continue;
              schedule[sec][day][slot] = {subj,teacher:teacherPicked.name,type:'remedial'};
              teacherHours[teacherPicked.name] += 1;
              remaining--; remedialPlaced=true; break;
            }
            if(!remedialPlaced) {
              // failed placement for this subject
              failed=true; break;
            }
          }
        } // end while remaining
        if(failed) break;
      } // end subjList
      if(failed) break;
    } // end classOrder

    // final checks: ensure no teacher exceeds max hours
    const anyOver = Object.values(teacherHours).some(h=>h>MAX_HOUR);
    if(!failed && !anyOver){
      success=true;
      // we keep schedule
      // store schedules globally for render
      renderSchedules(schedule,secs,teacherHours);
      return;
    }
  } // attempts

  alert('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙŠØ¬Ø§Ø¯ Ø­Ù„ ÙƒØ§Ù…Ù„ ÙÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø­Ù„ Ø¬Ø²Ø¦ÙŠ.');
  renderSchedules(schedule, Object.keys(schedule), teacherHours);
}

/* render schedules to HTML */
function renderSchedules(schedule,secs,teacherHours){
  const out = q('#outputArea'); out.innerHTML='';
  // Institution summary (one combined table)
  const instCard = document.createElement('div'); instCard.className='card';
  let html = '<h3>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù… (Ù…Ù„Ø®Øµ)</h3>';
  // show each day as table columns with time rows (compact)
  for(const day of DAYS){
    html += `<h4 style="margin:6px 0">${day}</h4><table class="schedule-table"><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    // sections as columns (but could be many -> show compact)
    for(const sec of secs) html += `<th class="slot">${sec}</th>`;
    html += '</tr>';
    for(const slot of SLOTS){
      // skip remedial slot presentation in institution table perhaps include
      html += `<tr><td>${slot}</td>`;
      for(const sec of secs){
        const cell = schedule[sec][day][slot];
        if(cell){
          const cls = cell.type==='remedial' ? 'remedial' : 'official';
          html += `<td class="${cls}">${cell.subj}<br/><span class="small">${cell.teacher}</span></td>`;
        } else {
          // if break slot
          if(slot==='13:00-14:00'){ html += `<td class="break">Ø±Ø§Ø­Ø©</td>`; }
          else if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && (slot==='13:00-14:00' || slot==='14:00-15:00' || slot==='15:00-16:00')) html += `<td class="free">â€”</td>`;
          else html += `<td class="free">ÙØ±Ø§Øº</td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</table>`;
  }
  instCard.innerHTML = html;
  out.appendChild(instCard);

  // Students: create selector and each class table
  const studentsCard = document.createElement('div'); studentsCard.className='card'; 
  let shtml = '<h3>ğŸ‘¨â€ğŸ“ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° (ÙƒÙ„ Ù‚Ø³Ù…)</h3>';
  for(const sec of secs){
    shtml += `<h4 style="margin:6px 0">${sec}</h4><table class="schedule-table"><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    for(const day of DAYS) shtml += `<th>${day}</th>`;
    shtml += '</tr>';
    for(const slot of SLOTS){
      shtml += `<tr><td>${slot}</td>`;
      for(const day of DAYS){
        const cell = schedule[sec][day][slot];
        if(cell){
          const cls = cell.type==='remedial' ? 'remedial' : 'official';
          shtml += `<td class="${cls}">${cell.subj}<br><span class="small">${cell.teacher}</span></td>`;
        } else {
          if(slot==='13:00-14:00'){ shtml += `<td class="break">Ø±Ø§Ø­Ø©</td>`; }
          else if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && (slot==='13:00-14:00' || slot==='14:00-15:00' || slot==='15:00-16:00')) shtml += `<td class="free">â€”</td>`;
          else shtml += `<td class="free">ÙØ±Ø§Øº</td>`;
        }
      }
      shtml += '</tr>';
    }
    shtml += '</table>';
  }
  studentsCard.innerHTML = shtml;
  out.appendChild(studentsCard);

  // Teachers tables
  const teachCard = document.createElement('div'); teachCard.className='card';
  let thtml = '<h3>ğŸ‘©â€ğŸ« Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h3>';
  for(const t of teachers){
    thtml += `<h4 style="margin:6px 0">${t.name} â€” ${t.subject} (Ø³Ø§Ø¹Ø§Øª Ù…ÙØªØ±Ø¶Ø© ${t.hours})</h4><table class="schedule-table"><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    for(const day of DAYS) thtml += `<th>${day}</th>`;
    thtml += '</tr>';
    for(const slot of SLOTS){
      thtml += `<tr><td>${slot}</td>`;
      for(const day of DAYS){
        // find any class where teacher teaches at this time
        let found = null;
        for(const sec of secs){
          const c = schedule[sec][day][slot];
          if(c && c.teacher===t.name){ found = {sec,c}; break; }
        }
        if(found){ const cls = found.c.type==='remedial' ? 'remedial' : 'official'; thtml += `<td class="${cls}">${found.sec}<br><span class="small">${found.c.subj}</span></td>`; }
        else {
          if(slot==='13:00-14:00'){ thtml += `<td class="break">Ø±Ø§Ø­Ø©</td>`; }
          else if(day==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && (slot==='13:00-14:00' || slot==='14:00-15:00' || slot==='15:00-16:00')) thtml += `<td class="free">â€”</td>`;
          else thtml += `<td class="free">ÙØ±Ø§Øº</td>`;
        }
      }
      thtml += `</tr>`;
    }
    thtml += '</table>';
  }
  teachCard.innerHTML = thtml;
  out.appendChild(teachCard);
}

/* copy and export */
function copyOutput(){
  const html = q('#outputArea').innerHTML;
  navigator.clipboard.writeText(html).then(()=>alert('ØªÙ… Ù†Ø³Ø® HTML'));
}
async function exportPDF(){
  // use html2canvas + jsPDF from CDN if available
  const el = q('#outputArea');
  if(!el) return;
  const { jsPDF } = window.jspdf || {};
  if(!window.html2canvas || !jsPDF){ alert('Ù…Ø·Ù„ÙˆØ¨ html2canvas Ùˆ jsPDFØŒ ØªØ£ÙƒØ¯ Ù…Ù† CDN Ø£Ùˆ Ø§ÙØªØ­ ÙÙŠ Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù…Ù‡Ù…Ø§'); return; }
  // render as canvas and save
  const canvas = await html2canvas(el, {scale:1.2, useCORS:true, backgroundColor:'#071018'});
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('l','mm','a4');
  const imgProps = pdf.getImageProperties(imgData);
  const pdfW = pdf.internal.pageSize.getWidth();
  const pdfH = (imgProps.height * pdfW) / imgProps.width;
  pdf.addImage(imgData, 'PNG', 0, 0, pdfW, pdfH);
  pdf.save('schedule.pdf');
}

/* small helpers for selectors */
function q(id){return document.querySelector(id)}

/* initialize */
updateTotal();
renderTeachers();

</script>
<!-- include libs for PDF (optional) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
