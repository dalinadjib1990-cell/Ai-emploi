
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ai_dali_nadjib_emploi_cem â€” Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:linear-gradient(180deg,#031022,#061428);color:#e6eef6;font-family:Inter,system-ui,Arial}
    .card{background:#0b1622;border-radius:10px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
    table{border-collapse:collapse}
    th,td{border:1px solid rgba(255,255,255,0.06);padding:8px;text-align:center}
    .avatar{width:60px;height:60px;border-radius:9999px;object-fit:cover;border:3px solid rgba(255,255,255,0.08)}
    .tag{padding:5px 8px;border-radius:8px;font-weight:700}
    .official{background:#b7e4c7;color:#04201b}
    .remedial{background:#fff59d;color:#111}
    .project{background:#a5d6a7;color:#04201b}
    .free{background:#d6c6f0;color:#1b0f2b}
    .break{background:#ffe0a3;color:#1b0f2b}
    .small{font-size:13px;color:#9fb7d9}
    .muted{color:#94a3b8}
    .danger{color:#ffb4b4}
    .btn{padding:8px 12px;border-radius:8px;font-weight:700}
    .editable{min-height:26px}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-indigo-300">Ai_dali_nadjib_emploi_cem â€” Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù†</h1>
        <div class="small mt-1 muted">Ø§Ø¶ØºØ· Â«Ù…Ø¤Ø³Ø³ØªÙŠÂ» Ø«Ù… Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„Â». ÙƒÙ„ ØªÙˆÙ„ÙŠØ¯ ÙŠØ¹Ø·ÙŠ Ø§Ø­ØªÙ…Ø§Ù„Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ØŒ ÙˆÙ„Ù† ÙŠÙØ´Ù„ â€” ÙŠØ¹Ø·ÙŠ Ø£ÙØ¶Ù„ Ø¬Ø¯ÙˆÙ„ Ù…Ù…ÙƒÙ† ÙˆÙŠØ¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <div class="muted">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: <strong id="showInstitution">â€”</strong></div>
          <div class="muted">Ø£Ø³ØªØ§Ø° Ù†Ù…ÙˆØ°Ø¬ÙŠ: <strong id="showTeacher">â€”</strong></div>
        </div>
        <div>
          <img id="avatar" class="avatar hidden" alt="avatar">
          <div class="mt-2 text-center">
            <input id="imgFile" type="file" accept="image/*" class="hidden">
            <button id="btnUpload" class="btn bg-slate-600">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
          </div>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Controls -->
      <aside class="lg:col-span-1 space-y-4">
        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h2>
          <label class="block small mt-2 muted">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <input id="institutionName" class="w-full p-2 rounded bg-slate-800 text-white" placeholder="Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´">

          <div class="grid grid-cols-2 gap-2 mt-3">
            <label class="small">Ø³Ù†Ø© 1Ù…: <input id="lvl1" type="number" min="0" value="5" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">Ø³Ù†Ø© 2Ù…: <input id="lvl2" type="number" min="0" value="4" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">Ø³Ù†Ø© 3Ù…: <input id="lvl3" type="number" min="0" value="3" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">Ø³Ù†Ø© 4Ù…: <input id="lvl4" type="number" min="0" value="2" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          </div>
          <div class="mt-2 small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: <strong id="totalClasses">14</strong></div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">2. Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h2>
          <div class="small muted">Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø¤Ø³Ø³ØªÙŠ) Ø«Ù… ØªØ¹Ø¯ÙŠÙ„. Ù†ØµØ§Ø¨ Ø£Ù‚ØµÙ‰: <strong>20</strong> Ø³Ø§Ø¹Ø©.</div>
          <div class="mt-2 overflow-auto" style="max-height:260px">
            <table id="teachersTable" class="w-full text-sm">
              <thead><tr class="muted"><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</th><th>Ø³Ø§Ø¹Ø§Øª</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnMyInst" class="btn bg-emerald-600">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ</button>
            <button id="btnReset" class="btn bg-slate-600">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
            <button id="btnGenerate" class="btn bg-indigo-600">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
            <button id="btnRegen" class="btn bg-indigo-500">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯</button>
          </div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">3. Ø¹Ø±Ø¶</h2>
          <div class="mt-2">
            <button id="viewInstitution" class="btn bg-blue-600 w-full mb-2">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</button>
            <div class="flex gap-2">
              <select id="teacherSelector" class="w-full p-2 rounded bg-slate-800"></select>
              <button id="viewTeacherBtn" class="btn bg-blue-500">Ø¹Ø±Ø¶</button>
            </div>
            <div class="mt-2 flex gap-2">
              <select id="classSelector" class="w-full p-2 rounded bg-slate-800"></select>
              <button id="viewClassBtn" class="btn bg-blue-500">Ø¹Ø±Ø¶</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">4. ØªØµØ¯ÙŠØ± / Ù†Ø³Ø®</h2>
          <div class="flex gap-2 mt-2 flex-wrap">
            <button id="btnCopy" class="btn bg-sky-600">ğŸ“‹ Ù†Ø³Ø® HTML</button>
            <button id="btnCSV" class="btn bg-sky-700">ğŸ“Š Excel (CSV)</button>
            <button id="btnWord" class="btn bg-sky-500">ğŸ“ƒ Word</button>
            <button id="btnPDF" class="btn bg-sky-400">ğŸ“„ PDF</button>
          </div>
          <div class="mt-3 small" id="diagnostic">Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø².</div>
        </div>
      </aside>

      <!-- Output -->
      <main class="lg:col-span-3">
        <div id="outputArea" class="card min-h-[320px]">
          <p class="small muted">Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„Â» Ø³ÙŠØ¸Ù‡Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ù‡Ù†Ø§. Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù„Ø§ ÙŠÙØ´Ù„ â€” Ø³ÙŠØ¹Ø·ÙŠ Ø£ÙØ¶Ù„ Ø¬Ø¯ÙˆÙ„ Ù…Ù…ÙƒÙ† ÙˆÙŠØ¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØµÙ„Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</p>
        </div>
      </main>
    </div>

    <footer class="text-sm text-slate-400">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ø·ÙŠ Ø¬Ø¯ÙˆÙ„Ù‹Ø§ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ø©: Ø³ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ø§Ø³ØªØ¯Ø±Ø§Ø¬ Ø£Ø³Ø§ØªØ°Ø©/Ø²ÙŠØ§Ø¯Ø© Ø³Ø§Ø¹Ø§Øª.</footer>
  </div>

<script>
/* ---------- Ø«ÙˆØ§Ø¨Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯ ---------- */
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
const MAX_TEACHER = 20;

// Ù†ØµØ§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ)
const subjectHours = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª': {'1':4,'2':4,'3':5,'4':5},
  'Ø¹Ø±Ø¨ÙŠØ©': {'1':4,'2':4,'3':4,'4':4},
  'ÙØ±Ù†Ø³ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'ÙÙŠØ²ÙŠØ§Ø¡': {'1':2,'2':2,'3':2,'4':2},
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§': {'1':2,'2':2,'3':2,'4':2},
  'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©': {'1':1,'2':1,'3':1,'4':1},
  'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©': {'1':2,'2':2,'3':2,'4':2},
  'Ø±ÙŠØ§Ø¶Ø©': {'1':2,'2':2,'3':2,'4':2},
  'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ': {'1':1,'2':1,'3':1,'4':0},
  'Ø±Ø³Ù…': {'1':1,'2':1,'3':1,'4':1}
};

// Ø£ÙŠØ§Ù… Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§)
let pedagogicalDays = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¹Ø±Ø¨ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','ÙØ±Ù†Ø³ÙŠØ©':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','ÙÙŠØ²ÙŠØ§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø±Ø³Ù…':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'
};

/* ---------- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---------- */
let teachers = []; // {name,subject,sections:[],hours,totalAssigned}
let institution = {name:'',levels:{1:5,2:4,3:3,4:2}};
let lastSchedule = null;
let lastSections = [];

/* ---------- DOM helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function clone(o){ return JSON.parse(JSON.stringify(o)); }

/* ---------- UI wiring ---------- */
$('#btnUpload').addEventListener('click', ()=> $('#imgFile').click());
$('#imgFile').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); $('#avatar').src=url; $('#avatar').classList.remove('hidden'); });

$('#lvl1').addEventListener('change', updateTotal);
$('#lvl2').addEventListener('change', updateTotal);
$('#lvl3').addEventListener('change', updateTotal);
$('#lvl4').addEventListener('change', updateTotal);

$('#btnMyInst').addEventListener('click', loadMyInstitution);
$('#btnReset').addEventListener('click', ()=> { if(confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† ÙˆØªÙØ±ÙŠØº ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ')) resetAll(); });
$('#btnGenerate').addEventListener('click', ()=> generateAll());
$('#btnRegen').addEventListener('click', ()=> generateAll(true));
$('#viewInstitution').addEventListener('click', ()=> showInstitutionTable());
$('#viewTeacherBtn').addEventListener('click', ()=> showTeacherTable($('#teacherSelector').value));
$('#viewClassBtn').addEventListener('click', ()=> showClassTable($('#classSelector').value));

$('#btnCopy').addEventListener('click', copyHTML);
$('#btnCSV').addEventListener('click', exportCSV);
$('#btnWord').addEventListener('click', exportWord);
$('#btnPDF').addEventListener('click', exportPDF);

/* ---------- utilities ---------- */
function updateTotal(){
  const tot = (parseInt($('#lvl1').value||0) + parseInt($('#lvl2').value||0) + parseInt($('#lvl3').value||0) + parseInt($('#lvl4').value||0));
  $('#totalClasses').innerText = tot;
}

function buildSections(){
  const arr=[];
  const l1 = parseInt($('#lvl1').value||0), l2 = parseInt($('#lvl2').value||0), l3 = parseInt($('#lvl3').value||0), l4 = parseInt($('#lvl4').value||0);
  for(let i=1;i<=l1;i++) arr.push(`1Ù…${i}`);
  for(let i=1;i<=l2;i++) arr.push(`2Ù…${i}`);
  for(let i=1;i<=l3;i++) arr.push(`3Ù…${i}`);
  for(let i=1;i<=l4;i++) arr.push(`4Ù…${i}`);
  lastSections = arr;
  renderTeachersUI();
  return arr;
}

/* ---------- teachers UI ---------- */
function renderTeachersUI(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${t.sections.length? t.sections.join(',') : 'â€”'}</td><td class="p-2">${t.hours}</td><td class="p-2"><button onclick="deleteTeacher(${i})" class="px-2 py-1 bg-red-600 rounded text-xs">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  // selectors
  const teacherSel = $('#teacherSelector'); teacherSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°</option>';
  teachers.forEach(t=> { const o=document.createElement('option'); o.value=t.name; o.textContent=`${t.name} â€” ${t.subject}`; teacherSel.appendChild(o); });
  const classSel = $('#classSelector'); classSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…</option>';
  lastSections.forEach(s=> { const o=document.createElement('option'); o.value=s; o.textContent=s; classSel.appendChild(o); });
}
window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); };

/* ---------- load sample institution ---------- */
function loadMyInstitution(){
  resetAll(false);
  institution.name = 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  $('#institutionName').value = institution.name;
  $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2;
  updateTotal();

  teachers = [
    {name:'Ù†Ø¬ÙŠØ¨',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:20,totalAssigned:0},
    {name:'Ù…Ù†ÙŠØ±Ø©',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
    {name:'Ø±Ù…Ø²ÙŠ',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
    {name:'Ø£Ù…Ø§Ù„',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},

    {name:'ØµØ¨Ø±ÙŠÙ†Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'Ù…Ø±ÙˆØ©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'Ø³Ø§Ø±Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'ÙˆØ­ÙŠØ¯',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø¹Ø§Ù…Ø±',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},

    {name:'Ø§Ù„Ø¹ÙŠØ¯',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø³Ù„Ù…Ù‰',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø³Ø§Ø±Ø©_Ù',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},

    {name:'Ø¨ÙˆØ¨ÙƒØ±',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ù‡Ø´Ø§Ù…',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ù†',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:14,totalAssigned:0},

    {name:'Ø¹Ø§Ø¦Ø´Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:12,totalAssigned:0},
    {name:'ÙØ§Ø·Ù…Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},
    {name:'Ø£Ù…Ø§Ù„_Øª',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},

    {name:'ÙˆØ³ÙŠÙ„Ø©',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ø·Ø§ÙˆØ³',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},

    {name:'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:12,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_ÙÙŠ',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:10,totalAssigned:0},

    {name:'Ø¹Ù„Ø§Ø¡',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},
    {name:'Ø³Ù…ÙŠØ±',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},

    {name:'Ø³Ø¹ÙŠØ¯',subject:'Ø±Ø³Ù…',sections:[],hours:6,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ø¹Ù„Ø§Ù…',subject:'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ',sections:[],hours:6,totalAssigned:0},
    {name:'Ù…Ø¹Ù„Ù…_Ø§Ø³Ù„Ø§Ù…ÙŠ',subject:'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©',sections:[],hours:8,totalAssigned:0}
  ];

  lastSections = buildSections();
  $('#showInstitution').innerText = institution.name;
  $('#showTeacher').innerText = 'Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨ â€” Ø±ÙŠØ§Ø¶ÙŠØ§Øª';
  renderTeachersUI();
  $('#diagnostic').innerText = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.';
}

/* ---------- reset ---------- */
function resetAll(clearUI=true){
  teachers = [];
  institution = {name:'',levels:{1:0,2:0,3:0,4:0}};
  $('#institutionName').value='';
  $('#lvl1').value=0; $('#lvl2').value=0; $('#lvl3').value=0; $('#lvl4').value=0;
  updateTotal();
  $('#showInstitution').innerText='â€”';
  $('#showTeacher').innerText='â€”';
  $('#outputArea').innerHTML = `<p class="small muted">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.</p>`;
  $('#diagnostic').innerText = 'ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº.';
  lastSchedule = null; lastSections = [];
  if(clearUI) renderTeachersUI();
}

/* ---------- Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø°ÙƒÙŠ (Ù„Ø§ ÙŠÙØ´Ù„) ---------- */
function generateAll(forceNew=false){
  institution.name = $('#institutionName').value || institution.name || 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  $('#showInstitution').innerText = institution.name;
  const sections = buildSections();
  if(sections.length===0){ alert('Ù„Ù… ØªÙØ¹Ø±Ù‘Ù Ø£Ù‚Ø³Ø§Ù…. Ø§Ø¶ØºØ· "Ù…Ø¤Ø³Ø³ØªÙŠ" Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….'); return; }
  if(teachers.length===0){ if(confirm('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙØ§Ø±ØºØ©. ØªØ­Ù…ÙŠÙ„ Ù…Ø¤Ø³Ø³ØªÙŠØŸ')) loadMyInstitution(); else return; }

  // Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„ Ù‚Ø³Ù… (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©)
  const req = {};
  for(const sec of sections){
    const lvl = sec.charAt(0);
    req[sec] = {};
    for(const subj in subjectHours){
      const h = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(h>0) req[sec][subj] = h;
    }
    // ØªØ¹Ø¯ÙŠÙ„ Ø®Ø§Øµ Ù„Ø³Ù†Ø© Ø±Ø§Ø¨Ø¹Ø©: Ù„Ø§ Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ
    if(sec.startsWith('4') && req[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']) delete req[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ'];
    if(sec.startsWith('4') && !req[sec]['Ø±Ø³Ù…']) req[sec]['Ø±Ø³Ù…'] = 1;
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº
  function makeSchedule(){
    const S = {};
    for(const sec of sections){ S[sec] = {}; for(const d of DAYS){ S[sec][d] = {}; for(const s of SLOTS) S[sec][d][s] = null; } }
    return S;
  }
  const schedule = makeSchedule();

  // busy map Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
  const busy = {};
  teachers.forEach(t=>{ busy[t.name] = {}; for(const d of DAYS) { busy[t.name][d] = {}; for(const s of SLOTS) busy[t.name][d][s] = false; } t.totalAssigned=0; });

  // ØªØ±ØªÙŠØ¨ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù‚ÙŠÙ…: ÙƒÙ„ Ù…Ø§Ø¯Ø© Ù„ÙƒÙ„ Ù‚Ø³Ù… ÙƒÙ‚Ø§Ø¦Ù…Ø© Ù…Ù† ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø­ØµØ©
  const tasks = []; // ÙƒÙ„ Ù…Ù‡Ù…Ø©: {sec, subj}
  for(const sec of sections){
    for(const subj in req[sec]){
      for(let k=0;k<req[sec][subj];k++){
        tasks.push({sec,subj});
      }
    }
  }
  // Ù†Ø®Ù„Ø· Ø§Ù„Ù…Ù‡Ø§Ù… Ù„ØªÙ†ÙˆØ¹ Ø§Ù„Ø­Ù„ÙˆÙ„ØŒ Ù„ÙƒÙ† Ù†Ø±ÙŠØ¯ Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ø¨ÙƒØ±Ù‹Ø§ => Ù†Ø¶Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ Ø£ÙØ¶Ù„ÙŠØ© Ù„Ù„Ù‚Ø³Ù… 4Ù…
  const mathTasks = tasks.filter(t=> t.subj==='Ø±ÙŠØ§Ø¶ÙŠØ§Øª').sort((a,b)=> (a.sec.startsWith('4')? -1:0));
  const other = tasks.filter(t=> t.subj!=='Ø±ÙŠØ§Ø¶ÙŠØ§Øª');
  const mixed = mathTasks.concat(shuffle(other));

  // function to get candidate teachers for subject
  function candidates(subj, section){
    // teachers who teach this subj and not exceeded requested hours
    let cand = teachers.filter(t => t.subject === subj);
    // if none, allow teachers of other subjects? NO â€” we prefer not to. If none, return empty.
    // sort: those with fewer assigned hours first
    cand.sort((a,b)=> (a.totalAssigned||0) - (b.totalAssigned||0));
    return cand;
  }

  // Preferred slot order per subject: math -> morning preference
  function preferredSlotsFor(subj){
    if(subj === 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª'){
      return ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
    }
    return SLOTS.slice();
  }

  // Helper: section free at day/slot?
  function isSectionFree(sec,d,s){ return !schedule[sec][d][s]; }

  // Worker: attempt place one task, returns true if placed else false (and record reason)
  const notes = []; // Ù†ØµØ§Ø¦Ø­ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª
  function placeTask(task){
    const {sec,subj} = task;
    const slotsOrder = preferredSlotsFor(subj);
    // build list of candidate day-slot pairs, avoiding pedagogical day for subj
    const dsPairs = [];
    for(const d of DAYS){
      if(pedagogicalDays[subj] && pedagogicalDays[subj] === d) continue;
      for(const s of slotsOrder){
        if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4) continue; // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ Ù†ØµÙ ÙŠÙˆÙ… - Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¹Ø±ÙˆØ¶ Ù‚Ù„ÙŠÙ„Ø© Ø¨Ø¹Ø¯ 12ØŸ Ø­Ø³Ø¨ Ø·Ù„Ø¨: Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ Ù†ØµÙ ÙŠÙˆÙ… -> Ù†Ù…Ù†Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±
        dsPairs.push({d,s});
      }
    }
    // shuffle to vary across regenerations, but keep order priority
    shuffle(dsPairs);
    // attempt: prefer morning for math and prefer teachers with available hours
    const cands = candidates(subj, sec);
    for(const {d,s} of dsPairs){
      if(!isSectionFree(sec,d,s)) continue;
      // try teachers in order
      for(const t of cands){
        if(t.totalAssigned >= t.hours) continue; // teacher reached requested hours
        if(t.totalAssigned >= MAX_TEACHER) continue; // safety
        if(busy[t.name][d][s]) continue;
        // ensure teacher not teaching same section at same slot (busy covers)
        // assign
        schedule[sec][d][s] = {subj, teacher: t.name, type: 'official'};
        t.totalAssigned = (t.totalAssigned||0) + 1;
        busy[t.name][d][s] = true;
        return true;
      }
    }
    // if cannot place because no teacher available in preferred slots, try more flexible slots including pedagogical day or Tuesday afternoons
    const dsPairsFlex = [];
    for(const d of DAYS){
      for(const s of SLOTS){
        // allow pedagogical day slots as last resort
        dsPairsFlex.push({d,s});
      }
    }
    shuffle(dsPairsFlex);
    for(const {d,s} of dsPairsFlex){
      if(!isSectionFree(sec,d,s)) continue;
      const cands2 = candidates(subj, sec);
      for(const t of cands2){
        if(t.totalAssigned >= t.hours) continue;
        if(t.totalAssigned >= MAX_TEACHER) continue;
        if(busy[t.name][d][s]) continue;
        schedule[sec][d][s] = {subj, teacher: t.name, type: 'official (flex)'};
        t.totalAssigned = (t.totalAssigned||0) + 1;
        busy[t.name][d][s] = true;
        return true;
      }
    }
    // Ø£Ø®ÙŠØ±Ø§Ù‹: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ù„Ù…ØŒ Ù†ØªØ±Ùƒ Ø§Ù„ÙØ±Ø§Øº ÙˆÙ†Ø³Ø¬Ù„ Ù…Ù„Ø§Ø­Ø¸Ø©
    notes.push(`Ø§Ù„Ù‚Ø³Ù… ${sec} â€” Ø§Ù„Ù…Ø§Ø¯Ø© ${subj}: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³ØªØ§Ø° Ù…ØªØ§Ø­ Ø£Ùˆ Ù†ØµØ§Ø¨ ÙƒØ§ÙÙØŒ ØªØ±ÙƒØª Ø§Ù„Ø­ØµØ© ÙØ§Ø±ØºØ©.`);
    return false;
  }

  // Ø£ÙˆÙ„ Ù…Ø±Ø­Ù„Ø©: Ù†Ø­Ø§ÙˆÙ„ ÙˆØ¶Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
  for(const t of mixed){
    placeTask(t);
  }

  // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†: Ù†Ù…Ù„Ø£ Ø§Ù„ÙØ¬ÙˆØ§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ø¨Ø­ØµØµ Ø§Ø³ØªØ¯Ø±Ø§Ùƒ Ø£Ùˆ Ø¨Ø¯Ù„ ÙØ±Ø§ØºØ§Øª Ø¥Ù† Ø£Ù…ÙƒÙ† (Ù†Ø­Ø§ÙˆÙ„ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ù„Ù„Ø£Ø³Ø§ØªØ°Ø©)
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø©: Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…ØŒ Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙ‡ ÙØ±Ø§ØºØ§Øª ÙƒØ«ÙŠØ±Ø© Ù†Ø¹Ù…Ù„ Ù„Ø§ Ø´ÙŠØ¡ Ù…Ø¹Ù‚Ø¯ â€” Ù†ØªØ±Ùƒ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©ØŒ Ù„Ø£Ù†Ù‡Ø§ ÙƒØ§ÙÙŠØ© Ø§Ù„Ø¢Ù†.

  lastSchedule = schedule;

  // Ø¨Ù†Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠ: Ù†Ø°ÙƒØ± Ø§Ù„Ù…ÙˆØ§Ø¯ ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨/Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯)
  const report = [];
  for(const sec of sections){
    for(const subj in req[sec]){
      const need = req[sec][subj];
      let got = 0;
      for(const d of DAYS) for(const s of SLOTS) if(schedule[sec][d][s] && schedule[sec][d][s].subj === subj) got++;
      if(got < need) report.push(`Ø§Ù„Ù‚Ø³Ù… ${sec} â€” ${subj}: Ù…Ø·Ù„ÙˆØ¨ ${need} Ø­ØµØµØŒ Ù…ÙØ¹ÙŠÙ† ${got} â‡’ ÙŠÙ„Ø²Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡/Ø²ÙŠØ§Ø¯Ø© Ø£Ø³Ø§ØªØ°Ø© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù†ØµØ§Ø¨.`);
    }
  }
  // ØªØ­Ø°ÙŠØ±: Ø£Ø³Ø§ØªØ°Ø© ØªØ¬Ø§ÙˆØ²ÙˆØ§ Ù†ØµØ§Ø¨Ù‡Ù…ØŸ
  const overloads = teachers.filter(t=> (t.totalAssigned||0) > t.hours).map(t=> `${t.name} (Ù…ÙØ¹ÙŠÙ†: ${t.totalAssigned}ØŒ Ù†ØµØ§Ø¨: ${t.hours})`);
  if(overloads.length) report.push('ØªØ­Ø°ÙŠØ±: Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ØªØ¬Ø§ÙˆØ²ÙˆØ§ Ù†ØµØ§Ø¨Ù‡Ù…: ' + overloads.join('; '));

  // Ù…Ø®Ø±Ø¬Ø§Øª: Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù…Ø¤Ø³Ø³Ø© ÙˆØ§Ù„ØªÙ„Ù…ÙŠØ° ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
  $('#diagnostic').innerText = report.length ? ('Ù…Ù„Ø§Ø­Ø¸Ø§Øª: \n' + report.join('\n')) : 'ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ â€” Ù„Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©.';
  showInstitutionTable();
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ---------- */
function showInstitutionTable(){
  if(!lastSchedule){ $('#outputArea').innerHTML = `<p class="small muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.</p>`; return; }
  const sections = lastSections.slice();
  const out = $('#outputArea'); out.innerHTML = '';
  const header = document.createElement('div'); header.innerHTML = `<h2 class="text-xl text-indigo-300">${$('#institutionName').value || 'Ø§Ù„Ù…Ø¤Ø³Ø³Ø©'}</h2><div class="small muted">Ø¹Ø±Ø¶ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù† Ù„Ù„Ù…Ø¤Ø³Ø³Ø© â€” Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${sections.join(', ')}</div>`; out.appendChild(header);

  for(const d of DAYS){
    const dayTitle = document.createElement('h3'); dayTitle.className='text-lg text-indigo-200 mt-4'; dayTitle.textContent = d; out.appendChild(dayTitle);
    const wrap = document.createElement('div'); wrap.className='overflow-auto';
    let html = `<table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    sections.forEach(s=> html += `<th>${s}</th>`);
    html += `</tr></thead><tbody>`;
    for(const slot of SLOTS){
      html += `<tr><td>${slot}</td>`;
      for(const sec of sections){
        const c = lastSchedule[sec][d][slot];
        if(c) html += `<td contenteditable="true" class="editable official">${c.subj}<br/><small>${c.teacher}</small></td>`;
        else {
          if(slot === '13:00-14:00') html += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
          else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot) >= 4) html += `<td contenteditable="true" class="free">â€”</td>`;
          else html += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</tbody></table>`;
    wrap.innerHTML = html; out.appendChild(wrap);
  }
}

function showTeacherTable(teacherName){
  if(!teacherName){ alert('Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°Ù‹Ø§'); return; }
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'); return; }
  const sections = lastSections.slice();
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø° ${teacherName}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      let found = null;
      for(const sec of sections){
        const c = lastSchedule[sec][d][slot];
        if(c && c.teacher === teacherName){ found = {sec,c}; break; }
      }
      if(found) html += `<td contenteditable="true" class="editable official">${found.sec}<br/><small>${found.c.subj}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
        else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot) >= 4) html += `<td contenteditable="true" class="free">â€”</td>`;
        else html += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

function showClassTable(section){
  if(!section){ alert('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§'); return; }
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø³Ù… ${section}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const slot of SLOTS){
    html += `<tr><td>${slot}</td>`;
    for(const d of DAYS){
      const c = lastSchedule[section][d][slot];
      if(c) html += `<td contenteditable="true" class="editable official">${c.subj}<br/><small>${c.teacher}</small></td>`;
      else {
        if(slot === '13:00-14:00') html += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
        else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(slot) >= 4) html += `<td contenteditable="true" class="free">â€”</td>`;
        else html += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend', html);
}

/* ---------- ØªØµØ¯ÙŠØ± ÙˆÙ†ÙØ³Ø® ---------- */
function copyHTML(){ navigator.clipboard.writeText($('#outputArea').innerHTML).then(()=> alert('ØªÙ… Ù†Ø³Ø® HTML'));}
function exportCSV(){
  const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„'); return; }
  const tables = out.querySelectorAll('table'); let csv='';
  tables.forEach((table,idx)=>{
    const title = table.previousElementSibling ? table.previousElementSibling.innerText.replace(/\n/g,' ') : `Table${idx+1}`;
    csv += `"${title}"\n`;
    for(const row of table.rows){
      const cells = Array.from(row.cells).map(c=> '"' + c.innerText.replace(/"/g,'""').replace(/\n/g,' / ') + '"');
      csv += cells.join(',') + '\n';
    }
    csv += '\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='schedules.csv'; a.click();
  URL.revokeObjectURL(a.href);
}
function exportWord(){
  const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„'); return; }
  const html = '<html><head><meta charset="utf-8"></head><body dir="rtl">' + out.innerHTML + '</body></html>';
  const blob = new Blob(['\ufeff', html], {type:'application/msword'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='schedules.doc'; a.click();
  URL.revokeObjectURL(a.href);
}
async function exportPDF(){
  const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„'); return; }
  if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
  if(typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  const canvas = await html2canvas(out, {scale:1.2,useCORS:true,backgroundColor:'#031022'});
  const img = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf || window.jspdf;
  const pdf = new jsPDF('l','mm','a4'); const w = pdf.internal.pageSize.getWidth(); const h = (canvas.height * w) / canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h); pdf.save('schedules.pdf');
}
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

/* ---------- initialization ---------- */
updateTotal();
renderTeachersUI();
// end of script
</script>
</body>
</html>
