<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ai_dali_nadjib_emploi_cem</title>
<style>
:root{
  --bg:#071018; --card:#0f1720; --accent:#5D5CDE; --muted:#94a3b8;
  --official:#90EE90; --remedial:#FFFF99; --project:#66c66b; --free:#ffffff; --break:#e2e8f0;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Tahoma,Arial;background:var(--bg);color:#fff;direction:rtl}
.wrap{max-width:1300px;margin:12px auto;padding:14px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
.small{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
button.ghost{background:#15303b}
.grid{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="number"],input[type="text"],select,textarea{width:100%;padding:8px;border-radius:8px;border:none;background:#071824;color:#fff}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #123040;padding:6px;text-align:center}
th{background:#071829;color:#fff}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.legend span{padding:6px 10px;border-radius:6px;font-weight:700;color:#000}
.official{background:var(--official)}
.remedial{background:var(--remedial)}
.project{background:var(--project)}
.free{background:var(--free)}
.break{background:var(--break)}
.notice{color:#fca5a5;font-weight:700;margin-top:8px}
.tabBtn{padding:8px 10px;border-radius:8px;background:#0b1220;color:var(--muted);cursor:pointer;border:1px solid #123040}
.outputArea{margin-top:12px}
.schedule-table{border-collapse:collapse;width:100%;margin:10px 0;background:#fff;color:#000}
.schedule-table th,.schedule-table td{border:1px solid #ccc;padding:6px;text-align:center}
.slot{min-width:120px}
.editable{outline: none}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.footer-note{margin-top:12px;color:var(--muted);font-size:13px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Ai_dali_nadjib_emploi_cem</h1>
        <div class="small">ูููุฏ ูุชูุฏู ูุงุณุชุนูุงู ุงูุฒูู โ ุงุถุบุท "ูุคุณุณุชู" ููุชุฌุฑุจุฉุ ุซู "ุชูููุฏ ุงูุฌุฏุงูู".</div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="imgInput" type="file" accept="image/*" style="display:none" onchange="loadAvatar(event)">
          <img id="avatar" class="avatar" src="" alt="profile" onerror="this.style.display='none'"/>
          <div style="text-align:right">
            <button class="ghost" onclick="document.getElementById('imgInput').click()">ุชุญููู ุงูุตูุฑุฉ</button>
            <div class="small">ุตูุฑุฉ ุงูููู ุงูุดุฎุตู (ุฏุงุฆุฑูุฉ)</div>
          </div>
        </div>
        <div id="userInfo" style="text-align:right">
          <div class="small">ุงููุคุณุณุฉ ุงููููุฐุฌูุฉ: <strong id="showInstitution">โ</strong></div>
          <div class="small">ุงูุฃุณุชุงุฐ ุงูุงูุชุฑุงุถู (ูุคุณุณุชู): <strong id="showTeacher">โ</strong></div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- left: settings -->
      <div>
        <div class="card">
          <h3>1. ุฅุนุฏุงุฏ ุงููุคุณุณุฉ</h3>
          <label>ุงุณู ุงููุคุณุณุฉ</label>
          <input id="institutionName" type="text" placeholder="ูุซุงู: ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด">
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>ุณูุฉ 1ู - ุนุฏุฏ ุงูุฃูุณุงู</label>
              <input id="lvl1" type="number" min="0" value="5" onchange="updateTotal()">
            </div>
            <div style="flex:1">
              <label>ุณูุฉ 2ู - ุนุฏุฏ ุงูุฃูุณุงู</label>
              <input id="lvl2" type="number" min="0" value="3" onchange="updateTotal()">
            </div>
            <div style="flex:1">
              <label>ุณูุฉ 3ู - ุนุฏุฏ ุงูุฃูุณุงู</label>
              <input id="lvl3" type="number" min="0" value="4" onchange="updateTotal()">
            </div>
            <div style="flex:1">
              <label>ุณูุฉ 4ู - ุนุฏุฏ ุงูุฃูุณุงู</label>
              <input id="lvl4" type="number" min="0" value="2" onchange="updateTotal()">
            </div>
          </div>
          <div style="margin-top:8px"><strong>ุฅุฌูุงูู ุงูุฃูุณุงู:</strong> <span id="totalClasses">13</span></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>2. ุฅุฏุงุฑุฉ ุงูุฃุณุงุชุฐุฉ (ูุงุจู ููุฒูุงุฏุฉ/ุงูุญุฐู)</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="tName" type="text" placeholder="ุงุณู ุงูุฃุณุชุงุฐ">
            <select id="tSubject">
              <option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>
              <option>ุฑูุงุถูุงุช</option><option>ุนุฑุจูุฉ</option><option>ูุฑูุณูุฉ</option><option>ุงูุฌููุฒูุฉ</option>
              <option>ุชุงุฑูุฎ ูุฌุบุฑุงููุง</option><option>ุชุฑุจูุฉ ูุฏููุฉ</option><option>ุนููู ุทุจูุนูุฉ</option>
              <option>ููุฒูุงุก</option><option>ุชุฑุจูุฉ ุงุณูุงููุฉ</option><option>ุฑูุงุถุฉ</option>
              <option>ุฅุนูุงู ุขูู</option><option>ุฑุณู</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="tSections" type="text" placeholder="ุงูุฃูุณุงู (ูุซุงู: 4ู1,3ู2)">
            <input id="tHours" type="number" min="1" max="20" placeholder="ุณุงุนุงุช/ุฃุณุจูุน" style="width:130px">
            <button onclick="addTeacher()" style="background:#10b981;padding:8px 10px;border-radius:8px">ุฅุถุงูุฉ</button>
          </div>

          <div style="margin-top:12px;max-height:240px;overflow:auto">
            <table id="teachersTable">
              <thead><tr><th>ุงูุฃุณุชุงุฐ</th><th>ุงููุงุฏุฉ</th><th>ุงูุฃูุณุงู</th><th>ุณุงุนุงุช</th><th>ุญุฐู</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="small" style="margin-top:8px;color:var(--muted)">ุฃุฏุฎู ุฃูุณุงููุง ุจุตูุบุฉ: 4ู1,3ู2 ... (ูุงุฑุบุฉ ุชุนูู: ุฌููุน ุงูุฃูุณุงู ุงูููููุฉ ูููุงุฏุฉ)</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button onclick="loadMyInstitution()">๐ซ ูุคุณุณุชู</button>
          <button onclick="resetAll()" class="ghost">๐ ุฅุนุงุฏุฉ ุงูุชุนููู</button>
          <button onclick="generateAll()" style="background:#06b6d4">โก ุชูููุฏ ุงูุฌุฏุงูู</button>
          <button onclick="copyOutput()" class="ghost">๐ ูุณุฎ HTML</button>
          <button onclick="exportPDF()" class="ghost">๐ ุชุตุฏูุฑ PDF</button>
          <button onclick="exportCSV()" class="ghost">๐ ุชุตุฏูุฑ Excel (CSV)</button>
          <button onclick="exportWord()" class="ghost">๐ ุชุตุฏูุฑ Word</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="legend">
            <span class="official">ุญุตุฉ ุฑุณููุฉ</span>
            <span class="remedial">ุงุณุชุฏุฑุงู</span>
            <span class="project">ุฃุนูุงู ููุฌูุฉ/ุชุทุจูููุฉ</span>
            <span class="free">ูุฑุงุบ</span>
            <span class="break">ุงุณุชุฑุงุญุฉ 12โ13</span>
          </div>
          <div class="notice">ุงูุฎูุงุฑุฒููุฉ ุชุญุชุฑู ุงูุฃูุงู ุงูุจูุฏุงุบูุฌูุฉุ ุชูุถูู ุงูุฑูุงุถูุงุช ุตุจุงุญูุงุ ูุชูููู ูุฑุงุบุงุช ุงูุฃุณุงุชุฐุฉ. ููููู ุชุญุฑูุฑ ุฃู ุฎููุฉ ูุฏููุงู ุซู ุชุตุฏูุฑ ุงููุชุงุฆุฌ.</div>
        </div>
      </div>

      <!-- right: quick info -->
      <div>
        <div class="card">
          <h3>ูุนูููุงุช ุณุฑูุนุฉ</h3>
          <div><strong>ุฃูุงู ุงูุนูู:</strong> ุงูุฃุญุฏุ ุงูุฅุซูููุ ุงูุซูุงุซุงุก (ูุตู ููู)ุ ุงูุฃุฑุจุนุงุกุ ุงูุฎููุณ</div>
          <div><strong>ุณุงุนุงุช ุงูุนูู ุงูุฑุณููุฉ:</strong> 08:00-15:00 (ุฑุงุญุฉ 12:00-13:00)</div>
          <div><strong>ุณุงุนุงุช ุงุณุชุฏุฑุงู:</strong> 15:00-16:00 (ุงุฎุชูุงุฑูุฉ)</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>ุฃูุงู ุจูุฏุงุบูุฌูุฉ (ูุงุจูุฉ ููุชุนุฏูู)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <label>ุฑูุงุถูุงุช<select id="pdMath"><option>ุงูุฎููุณ</option><option>ุงูุฃุญุฏ</option><option>ุงูุงุซููู</option></select></label>
            <label>ุนุฑุจูุฉ<select id="pdArabic"><option>ุงูุงุซููู</option><option>ุงูุฎููุณ</option></select></label>
            <label>ูุฑูุณูุฉ<select id="pdFrench"><option>ุงูุซูุงุซุงุก</option><option>ุงูุฌูุนุฉ</option></select></label>
            <label>ุงูุฌููุฒูุฉ<select id="pdEng"><option>ุงูุงุซููู</option><option>ุงูุซูุงุซุงุก</option></select></label>
            <label>ุนููู<select id="pdSci"><option>ุงูุฃุฑุจุนุงุก</option></select></label>
            <label>ููุฒูุงุก<select id="pdPhy"><option>ุงูุซูุงุซุงุก</option></select></label>
          </div>
        </div>

      </div>
    </div>

    <!-- Output area -->
    <div id="outputArea" class="outputArea"></div>

    <div class="footer-note">ููููู ุชุนุฏูู ุฃู ุฎููุฉ ูู ุงูุฌุฏุงูู ุจุงูููุฑ ูุงููุชุงุจุฉ โ ุซู ุงุถุบุท ุชุตุฏูุฑ ูุญูุธ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ.</div>
  </div>

<!-- Script -->
<script>
/* ===== Constants and default data ===== */
const DAYS = ['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
const BREAK = '12:00-13:00';
const MAX_TEACHER = 20;

// Subject weekly hours per level (1..4)
const subjHours = {
  'ุฑูุงุถูุงุช':{'1':4,'2':4,'3':5,'4':5},
  'ุนุฑุจูุฉ':{'1':4,'2':4,'3':4,'4':4},
  'ูุฑูุณูุฉ':{'1':3,'2':3,'3':3,'4':3},
  'ุงูุฌููุฒูุฉ':{'1':3,'2':3,'3':3,'4':3},
  'ุนููู ุทุจูุนูุฉ':{'1':3,'2':3,'3':3,'4':3},
  'ููุฒูุงุก':{'1':2,'2':2,'3':2,'4':2},
  'ุชุงุฑูุฎ ูุฌุบุฑุงููุง':{'1':2,'2':2,'3':2,'4':2},
  'ุชุฑุจูุฉ ูุฏููุฉ':{'1':1,'2':1,'3':1,'4':1},
  'ุชุฑุจูุฉ ุงุณูุงููุฉ':{'1':2,'2':2,'3':2,'4':2},
  'ุฑูุงุถุฉ':{'1':2,'2':2,'3':2,'4':2},
  'ุฅุนูุงู ุขูู':{'1':1,'2':1,'3':1,'4':0},
  'ุฑุณู':{'1':1,'2':1,'3':1,'4':1}
};

// default pedagogical days
let pedagogical = {
  'ุฑูุงุถูุงุช':'ุงูุฎููุณ','ุนุฑุจูุฉ':'ุงูุงุซููู','ูุฑูุณูุฉ':'ุงูุซูุงุซุงุก','ุงูุฌููุฒูุฉ':'ุงูุงูุงุซููู',
  'ุชุงุฑูุฎ ูุฌุบุฑุงููุง':'ุงูุฃุญุฏ','ุชุฑุจูุฉ ูุฏููุฉ':'ุงูุฃุญุฏ','ุชุฑุจูุฉ ุงุณูุงููุฉ':'ุงูุงุซููู',
  'ุนููู ุทุจูุนูุฉ':'ุงูุฃุฑุจุนุงุก','ููุฒูุงุก':'ุงูุซูุงุซุงุก','ุฑุณู':'ุงูุฎููุณ','ุฅุนูุงู ุขูู':'ุงูุฃุฑุจุนุงุก'
};

/* ===== State ===== */
let teachers = []; // {name,subject,sections:[],hours,totalAssigned}
let institution = {name:'', levels:{'1':5,'2':3,'3':4,'4':2} };

// UI helpers
function q(sel){ return document.querySelector(sel); }
function updateTotal(){
  institution.levels['1'] = parseInt(q('#lvl1').value||0);
  institution.levels['2'] = parseInt(q('#lvl2').value||0);
  institution.levels['3'] = parseInt(q('#lvl3').value||0);
  institution.levels['4'] = parseInt(q('#lvl4').value||0);
  const tot = Object.values(institution.levels).reduce((a,b)=>a+b,0);
  q('#totalClasses').innerText = tot;
}

/* ===== Teachers management ===== */
function addTeacher(){
  const name = q('#tName').value.trim();
  const subj = q('#tSubject').value;
  const secsRaw = q('#tSections').value.trim();
  const hours = parseInt(q('#tHours').value) || 18;
  if(!name || !subj){ alert('ุงููุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุฃุณุชุงุฐ ูุงููุงุฏุฉ'); return; }
  const secs = secsRaw ? secsRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
  teachers.push({name,subject:subj,sections:secs,hours,totalAssigned:0});
  q('#tName').value=''; q('#tSections').value=''; q('#tHours').value='';
  renderTeachers();
}
function renderTeachers(){
  const tbody = q('#teachersTable tbody'); tbody.innerHTML='';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td><td>${t.subject}</td><td>${t.sections.join(',')||'โ'}</td><td>${t.hours}</td><td><button onclick="delTeacher(${i})">ุญุฐู</button></td>`;
    tbody.appendChild(tr);
  });
}
function delTeacher(i){ teachers.splice(i,1); renderTeachers(); }

/* avatar loader */
function loadAvatar(e){
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const img = q('#avatar'); img.src = url; img.style.display='block';
}

/* ===== Load user's institution as requested ===== */
function loadMyInstitution(){
  resetAll();
  institution.name = 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด';
  q('#institutionName').value = institution.name;
  q('#lvl1').value=5; q('#lvl2').value=3; q('#lvl3').value=4; q('#lvl4').value=2; updateTotal();

  // teachers sample based on your provided list (balanced)
  teachers = [
    {name:'ูุฌูุจ',subject:'ุฑูุงุถูุงุช',sections:['1ู1','3ู1','4ู1'],hours:20,totalAssigned:0},
    {name:'ูููุฑุฉ',subject:'ุฑูุงุถูุงุช',sections:['1ู2','2ู1'],hours:18,totalAssigned:0},
    {name:'ุฑูุฒู',subject:'ุฑูุงุถูุงุช',sections:['1ู3','3ู2'],hours:18,totalAssigned:0},
    {name:'ุฃูุงู',subject:'ุฑูุงุถูุงุช',sections:['1ู4','2ู2'],hours:18,totalAssigned:0},

    {name:'ุตุจุฑููุฉ',subject:'ุนุฑุจูุฉ',sections:['1ู1','2ู1'],hours:18,totalAssigned:0},
    {name:'ูุฑูุฉ',subject:'ุนุฑุจูุฉ',sections:['1ู2','3ู1'],hours:18,totalAssigned:0},
    {name:'ุณุงุฑุฉ',subject:'ุนุฑุจูุฉ',sections:['1ู3','3ู2'],hours:18,totalAssigned:0},
    {name:'ูุญูุฏ',subject:'ุนุฑุจูุฉ',sections:['2ู2'],hours:16,totalAssigned:0},
    {name:'ุนุงูุฑ',subject:'ุนุฑุจูุฉ',sections:['4ู2'],hours:16,totalAssigned:0},

    {name:'ุงูุนูุฏ',subject:'ูุฑูุณูุฉ',sections:['1ู1','2ู1'],hours:16,totalAssigned:0},
    {name:'ุณููู',subject:'ูุฑูุณูุฉ',sections:['1ู2','3ู1'],hours:16,totalAssigned:0},
    {name:'ุณุงุฑุฉ_ู',subject:'ูุฑูุณูุฉ',sections:['2ู2'],hours:16,totalAssigned:0},

    {name:'ุจูุจูุฑ',subject:'ุงูุฌููุฒูุฉ',sections:['1ู1'],hours:12,totalAssigned:0},
    {name:'ูุดุงู',subject:'ุงูุฌููุฒูุฉ',sections:['2ู1'],hours:12,totalAssigned:0},
    {name:'ุฃูููุฉ_ุงู',subject:'ุงูุฌููุฒูุฉ',sections:['3ู1','4ู1'],hours:14,totalAssigned:0},

    {name:'ุนุงุฆุดุฉ',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:['1ู1','2ู1'],hours:12,totalAssigned:0},
    {name:'ูุงุทูุฉ',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:['3ู1'],hours:10,totalAssigned:0},
    {name:'ุฃูุงู_ุช',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:['4ู1'],hours:10,totalAssigned:0},

    {name:'ูุณููุฉ',subject:'ุนููู ุทุจูุนูุฉ',sections:['1ู1','2ู1'],hours:12,totalAssigned:0},
    {name:'ุทุงูุณ',subject:'ุนููู ุทุจูุนูุฉ',sections:['3ู1','4ู1'],hours:12,totalAssigned:0},

    {name:'ุนุจุฏ ุงูุฑุฒุงู',subject:'ููุฒูุงุก',sections:['4ู1','4ู2'],hours:12,totalAssigned:0},
    {name:'ุฃูููุฉ_ูู',subject:'ููุฒูุงุก',sections:['3ู2'],hours:10,totalAssigned:0},

    {name:'ุนูุงุก',subject:'ุฑูุงุถุฉ',sections:['1ู1','2ู1'],hours:8,totalAssigned:0},
    {name:'ุณููุฑ',subject:'ุฑูุงุถุฉ',sections:['3ู1','4ู2'],hours:8,totalAssigned:0},

    {name:'ุณุนูุฏ',subject:'ุฑุณู',sections:['4ู1','4ู2'],hours:6,totalAssigned:0},
    {name:'ุฃูููุฉ_ุงุนูุงู',subject:'ุฅุนูุงู ุขูู',sections:['1ู1','2ู1'],hours:6,totalAssigned:0},
    {name:'ูุนูู_ุงุณูุงูู',subject:'ุชุฑุจูุฉ ุงุณูุงููุฉ',sections:['1ู1','2ู1','3ู1','4ู1'],hours:8,totalAssigned:0}
  ];

  renderTeachers();
  // show institution and teacher default name (your name)
  q('#showInstitution').innerText = institution.name;
  q('#showTeacher').innerText = 'ุฏุงูู ูุฌูุจ โ ุฑูุงุถูุงุช';
}

/* reset all */
function resetAll(){
  teachers = []; renderTeachers();
  institution = {levels:{'1':0,'2':0,'3':0,'4':0}, name:''};
  q('#institutionName').value=''; q('#lvl1').value=0; q('#lvl2').value=0; q('#lvl3').value=0; q('#lvl4').value=0;
  updateTotal();
  q('#outputArea').innerHTML='';
  q('#showInstitution').innerText = 'โ';
  q('#showTeacher').innerText = 'โ';
}

/* ===== Scheduling algorithm (improved greedy with retries) ===== */
function generateAll(){
  // read levels and name
  institution.levels['1'] = parseInt(q('#lvl1').value||0);
  institution.levels['2'] = parseInt(q('#lvl2').value||0);
  institution.levels['3'] = parseInt(q('#lvl3').value||0);
  institution.levels['4'] = parseInt(q('#lvl4').value||0);
  institution.name = q('#institutionName').value || 'ูุคุณุณุฉ ูููุฐุฌูุฉ';

  // update pedagogical from selects
  pedagogical['ุฑูุงุถูุงุช'] = q('#pdMath')?.value || pedagogical['ุฑูุงุถูุงุช'];
  pedagogical['ุนุฑุจูุฉ'] = q('#pdArabic')?.value || pedagogical['ุนุฑุจูุฉ'];
  pedagogical['ูุฑูุณูุฉ'] = q('#pdFrench')?.value || pedagogical['ูุฑูุณูุฉ'];
  pedagogical['ุงูุฌููุฒูุฉ'] = q('#pdEng')?.value || pedagogical['ุงูุฌููุฒูุฉ'];
  pedagogical['ุนููู ุทุจูุนูุฉ'] = q('#pdSci')?.value || pedagogical['ุนููู ุทุจูุนูุฉ'];
  pedagogical['ููุฒูุงุก'] = q('#pdPhy')?.value || pedagogical['ููุฒูุงุก'];

  // build sections
  const sections = [];
  Object.entries(institution.levels).forEach(([lvl,cnt])=>{
    for(let i=1;i<=cnt;i++) sections.push(`${lvl}ู${i}`);
  });
  if(sections.length===0){ alert('ูู ุชูุนุฑูู ุฃู ุฃูุณุงูุ ุฑุฌุงุกู ุนุฑูู ุงูุฃูุณุงู ุฃู ุงุถุบุท "ูุคุณุณุชู".'); return; }
  if(teachers.length===0){ if(!confirm('ูุงุฆูุฉ ุงูุฃุณุงุชุฐุฉ ูุงุฑุบุฉ. ูู ุชุฑูุฏ ุชุญููู ุจูุงูุงุช ูุคุณุณุชูุ')) { return; } loadMyInstitution(); }

  // build class requirements
  const classReq = {};
  sections.forEach(sec=>{
    const level = sec.charAt(0);
    classReq[sec] = {};
    for(const subj in subjHours){
      const hrs = subjHours[subj] && subjHours[subj][level] ? subjHours[subj][level] : 0;
      if(hrs>0) classReq[sec][subj] = hrs;
    }
    // 4ู: remove ุฅุนูุงู ุขูู, ensure ุฑุณู present
    if(level==='4'){
      if(classReq[sec]['ุฅุนูุงู ุขูู']) delete classReq[sec]['ุฅุนูุงู ุขูู'];
      if(!classReq[sec]['ุฑุณู']) classReq[sec]['ุฑุณู']=1;
    }
  });

  // teachersBySubject index
  const teachersBySubject = {};
  teachers.forEach(t=>{
    if(!teachersBySubject[t.subject]) teachersBySubject[t.subject]=[];
    teachersBySubject[t.subject].push(t);
    t.totalAssigned = 0;
  });

  // schedule data structure
  const schedule = {};
  sections.forEach(sec=>{ schedule[sec]={}; DAYS.forEach(d=>{ schedule[sec][d] = {}; SLOTS.forEach(s=> schedule[sec][d][s]=null); }); });

  // teacherBusy map
  const teacherBusy = {};
  teachers.forEach(t=>{ teacherBusy[t.name] = {}; DAYS.forEach(d=>{ teacherBusy[t.name][d] = {}; SLOTS.forEach(s=>teacherBusy[t.name][d][s]=false); }); });

  // helpers
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
  function slotList(day, preferMath=false){
    let arr = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
    if(day==='ุงูุซูุงุซุงุก') arr = arr.slice(0,4);
    if(preferMath) arr = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'].filter(s=>!(day==='ุงูุซูุงุซุงุก' && ['13:00-14:00','14:00-15:00','15:00-16:00'].includes(s)));
    return arr;
  }
  function candidateTeachers(subj, section){
    const list = (teachersBySubject[subj] || []).slice();
    list.sort((a,b)=>{
      const aHas = a.sections && a.sections.includes(section);
      const bHas = b.sections && b.sections.includes(section);
      if(aHas && !bHas) return -1;
      if(!aHas && bHas) return 1;
      return (a.totalAssigned||0) - (b.totalAssigned||0);
    });
    return list;
  }
  function tryPlace(section, subj, day, slot, preferRemedial=false){
    if(pedagogical[subj] && pedagogical[subj]===day) return false;
    if(slot===BREAK) return false;
    if(schedule[section][day][slot]) return false;
    if(day==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) return false;
    const sameDayCount = SLOTS.reduce((acc,s)=> acc + (schedule[section][day][s] && schedule[section][day][s].subj===subj ? 1:0), 0);
    if(sameDayCount>=2) return false;
    const cands = candidateTeachers(subj, section);
    for(const cand of cands){
      if((cand.totalAssigned||0) >= cand.hours) continue;
      if((cand.totalAssigned||0) >= MAX_TEACHER) continue;
      if(teacherBusy[cand.name][day][slot]) continue;
      // assign
      schedule[section][day][slot] = {subj, teacher: cand.name, type: preferRemedial ? 'remedial' : 'official'};
      cand.totalAssigned = (cand.totalAssigned||0) + 1;
      teacherBusy[cand.name][day][slot] = true;
      return true;
    }
    return false;
  }

  // attempt placements with retries
  const MAX_ATTEMPTS = 12;
  let success = false;
  for(let attempt=0; attempt<MAX_ATTEMPTS && !success; attempt++){
    // reset
    sections.forEach(sec=> DAYS.forEach(d=> SLOTS.forEach(s=> schedule[sec][d][s]=null)));
    teachers.forEach(t=> t.totalAssigned=0);
    teachers.forEach(t=> DAYS.forEach(d=> SLOTS.forEach(s=> teacherBusy[t.name][d][s]=false)));

    const classOrder = shuffle(sections.slice());
    let failed = false;

    for(const section of classOrder){
      const level = section.charAt(0);
      const subjects = Object.keys(classReq[section]||{}).sort((a,b)=> (classReq[section][b] - classReq[section][a]));
      for(const subj of subjects){
        let remaining = classReq[section][subj];
        let trials = 0;
        while(remaining>0){
          trials++; if(trials>500){ failed=true; break; }
          const daysPool = shuffle(DAYS.slice());
          let placed=false;
          for(const day of daysPool){
            if(pedagogical[subj] && pedagogical[subj]===day) continue;
            const preferMath = (subj==='ุฑูุงุถูุงุช');
            let slots = slotList(day, preferMath);
            slots = shuffle(slots.slice());
            for(const slot of slots){
              if(slot===BREAK) continue;
              if(slot==='15:00-16:00' && Math.random()>0.6) continue; // deprioritize remedial
              if(tryPlace(section, subj, day, slot, slot==='15:00-16:00')){ remaining--; placed=true; break; }
            }
            if(placed) break;
          }
          if(!placed){
            // try remedial more aggressively except Tuesday
            let remedialPlaced=false;
            for(const day of DAYS){
              if(pedagogical[subj] && pedagogical[subj]===day) continue;
              if(day==='ุงูุซูุงุซุงุก') continue;
              if(tryPlace(section, subj, day, '15:00-16:00', true)){ remaining--; remedialPlaced=true; break; }
            }
            if(!remedialPlaced){ failed=true; break; }
          }
        }
        if(failed) break;
      }
      if(failed) break;
    }

    // verify
    const over = teachers.some(t=> (t.totalAssigned||0) > MAX_TEACHER );
    let allSatisfied = true;
    for(const sec of sections){
      for(const subj in classReq[sec]){
        const count = DAYS.reduce((acc,d)=> acc + SLOTS.reduce((a,s)=> a + (schedule[sec][d][s] && schedule[sec][d][s].subj===subj ? 1:0), 0), 0);
        if(count < classReq[sec][subj]) { allSatisfied=false; break; }
      }
      if(!allSatisfied) break;
    }
    if(!failed && !over && allSatisfied){ success=true; break; }
    // else next attempt with new randomness
  }

  if(!success) alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุญู ูุงูู ุฎูุงู ุงููุญุงููุงุชุ ุชู ุนุฑุถ ุญู ุฌุฒุฆู ุฅู ููุฌุฏ. ูุฏ ุชุญุชุงุฌ ูุฒูุงุฏุฉ ุฃุณุงุชุฐุฉ/ุณุงุนุงุช ูููุงุฏ ูุงูุตุฉ.');
  renderResult(schedule, sections);
}

/* ===== Rendering functions ===== */
function renderResult(schedule, sections){
  const out = q('#outputArea'); out.innerHTML='';

  // Header summary
  const instCard = document.createElement('div'); instCard.className='card';
  instCard.innerHTML = `<h3>๐ ุฌุฏูู ุงููุคุณุณุฉ โ ${institution.name}</h3><div class="small">ุงูุฃูุณุงู: ${sections.join(', ')}</div>`;
  out.appendChild(instCard);

  // Institution compact per day
  const instTableCard = document.createElement('div'); instTableCard.className='card';
  let instHTML = '<h4>ููุฎุต ุงููุคุณุณุฉ (ุงูููู ร ุงูุณุงุนุฉ ร ุงููุณู)</h4>';
  for(const day of DAYS){
    instHTML += `<h5 style="margin:6px 0">${day}</h5><table class="schedule-table"><tr><th>ุงูุณุงุนุฉ</th>`;
    sections.forEach(sec=> instHTML += `<th class="slot">${sec}</th>`);
    instHTML += '</tr>';
    SLOTS.forEach(slot=>{
      instHTML += `<tr><td>${slot}</td>`;
      sections.forEach(sec=>{
        const cell = schedule[sec][day][slot];
        if(cell){
          const cls = cell.type==='remedial' ? 'remedial' : 'official';
          instHTML += `<td contenteditable="true" class="editable ${cls}">${cell.subj}<br/><span class="small">${cell.teacher}</span></td>`;
        } else {
          if(slot==='13:00-14:00') instHTML += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
          else if(day==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) instHTML += `<td contenteditable="true" class="free">โ</td>`;
          else instHTML += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
        }
      });
      instHTML += `</tr>`;
    });
    instHTML += `</table>`;
  }
  instTableCard.innerHTML = instHTML;
  out.appendChild(instTableCard);

  // Student schedules per class
  const studentsCard = document.createElement('div'); studentsCard.className='card';
  let studsHTML = '<h4>ุฌุฏุงูู ุงูุชูุงููุฐ ููู ูุณู</h4>';
  sections.forEach(sec=>{
    studsHTML += `<h5 style="margin:6px 0">${sec}</h5><table class="schedule-table"><tr><th>ุงูุณุงุนุฉ</th>`;
    DAYS.forEach(d=> studsHTML += `<th>${d}</th>`);
    studsHTML += '</tr>';
    SLOTS.forEach(slot=>{
      studsHTML += `<tr><td>${slot}</td>`;
      DAYS.forEach(day=>{
        const cell = schedule[sec][day][slot];
        if(cell){
          const cls = (cell.type==='remedial') ? 'remedial' : 'official';
          studsHTML += `<td contenteditable="true" class="editable ${cls}">${cell.subj}<br><span class="small">${cell.teacher}</span></td>`;
        } else {
          if(slot==='13:00-14:00') studsHTML += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
          else if(day==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) studsHTML += `<td contenteditable="true" class="free">โ</td>`;
          else studsHTML += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
        }
      });
      studsHTML += '</tr>';
    });
    studsHTML += '</table>';
  });
  studentsCard.innerHTML = studsHTML;
  out.appendChild(studentsCard);

  // Teachers schedules
  const teachCard = document.createElement('div'); teachCard.className='card';
  let teachHTML = '<h4>ุฌุฏุงูู ุงูุฃุณุงุชุฐุฉ</h4>';
  teachers.forEach(t=>{
    teachHTML += `<h5 style="margin:6px 0">${t.name} โ ${t.subject} (ุณุงุนุงุช ููุชุฑุถุฉ: ${t.hours})</h5><table class="schedule-table"><tr><th>ุงูุณุงุนุฉ</th>`;
    DAYS.forEach(d=> teachHTML += `<th>${d}</th>`);
    teachHTML += '</tr>';
    SLOTS.forEach(slot=>{
      teachHTML += `<tr><td>${slot}</td>`;
      DAYS.forEach(day=>{
        let found = null;
        for(const sec of sections){
          const c = schedule[sec][day][slot];
          if(c && c.teacher===t.name){ found={sec,c}; break; }
        }
        if(found){
          const cls = (found.c.type==='remedial') ? 'remedial' : 'official';
          teachHTML += `<td contenteditable="true" class="editable ${cls}">${found.sec}<br/><span class="small">${found.c.subj}</span></td>`;
        } else {
          if(slot==='13:00-14:00') teachHTML += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
          else if(day==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) teachHTML += `<td contenteditable="true" class="free">โ</td>`;
          else teachHTML += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
        }
      });
      teachHTML += `</tr>`;
    });
    teachHTML += `</table>`;
  });
  teachCard.innerHTML = teachHTML;
  out.appendChild(teachCard);

  // scroll
  setTimeout(()=> window.scrollTo({ top: out.offsetTop - 20, behavior: 'smooth' }), 50);
}

/* ===== Export functions ===== */
function copyOutput(){
  const html = q('#outputArea').innerHTML;
  navigator.clipboard.writeText(html).then(()=> alert('ุชู ูุณุฎ ูุญุชูู ุงูุฌุฏุงูู (HTML) ุฅูู ุงูุญุงูุธุฉ'));
}

async function exportPDF(){
  if(!window.html2canvas || !window.jspdf){ alert('ุชุชุทูุจ html2canvas ู jsPDF ุนุจุฑ CDN. ุชุฃูุฏ ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช.'); return; }
  const el = q('#outputArea');
  const canvas = await html2canvas(el, {scale:1.2, useCORS:true, backgroundColor: '#071018'});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','mm','a4');
  const pdfW = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfH = (imgProps.height * pdfW) / imgProps.width;
  pdf.addImage(imgData,'PNG',0,0,pdfW,pdfH);
  pdf.save('Ai_dali_nadjib_emploi_cem_schedule.pdf');
}

function exportCSV(){
  // Build CSV for institution summary: take first institution table found
  const out = q('#outputArea');
  if(!out.innerHTML.trim()){ alert('ูุง ุชูุฌุฏ ุฌุฏุงูู ููุชุตุฏูุฑ ุจุนุฏ.'); return; }
  // We'll export students tables concatenated: for each class, produce a CSV block
  let csvParts = [];
  // find all schedule-table elements
  const tables = out.querySelectorAll('.schedule-table');
  tables.forEach((table, idx)=>{
    // caption or header
    const title = table.previousElementSibling ? table.previousElementSibling.textContent.trim() : `Table${idx+1}`;
    csvParts.push(`"${title}"`);
    // read rows
    for(const row of table.rows){
      const cells = [];
      for(const cell of row.cells){
        // replace line breaks
        cells.push('"' + cell.innerText.replace(/\n/g,' / ').replace(/"/g,'""') + '"');
      }
      csvParts.push(cells.join(','));
    }
    csvParts.push(''); // blank line between tables
  });
  const csvContent = csvParts.join('\n');
  const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'schedules.csv'; a.click(); URL.revokeObjectURL(url);
}

function exportWord(){
  const content = q('#outputArea').innerHTML;
  if(!content.trim()){ alert('ูุง ุชูุฌุฏ ุฌุฏุงูู ููุชุตุฏูุฑ.'); return; }
  const header = `<html><head><meta charset="utf-8"><title>ุชูุฑูุฑ ุฌุฏุงูู</title></head><body dir="rtl">${content}</body></html>`;
  const blob = new Blob(['\ufeff', header], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'schedules.doc'; a.click(); URL.revokeObjectURL(url);
}

/* ===== Utilities ===== */
function renderTeachers(){ renderTeachersUI(); }
function renderTeachersUI(){
  const tbody = q('#teachersTable tbody'); tbody.innerHTML='';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td><td>${t.subject}</td><td>${t.sections.join(',')||'โ'}</td><td>${t.hours}</td><td><button onclick="delTeacher(${i})">ุญุฐู</button></td>`;
    tbody.appendChild(tr);
  });
}

/* Expose some functions to window for buttons used earlier */
window.loadMyInstitution = loadMyInstitution;
window.resetAll = resetAll;
window.addTeacher = addTeacher;
window.renderTeachers = renderTeachers;
window.generateAll = generateAll;
window.copyOutput = copyOutput;
window.exportPDF = exportPDF;
window.exportCSV = exportCSV;
window.exportWord = exportWord;
window.loadAvatar = loadAvatar;

/* initial UI */
updateTotal();
renderTeachersUI();
q('#showInstitution').innerText = 'โ';
q('#showTeacher').innerText = 'โ';
</script>

<!-- include html2canvas and jsPDF CDN for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
