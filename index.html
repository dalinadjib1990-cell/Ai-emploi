<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ai_dali_nadjib_emploi_cem โ ููุงุฆู</title>

  <!-- Tailwind Play CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background: linear-gradient(180deg,#060617,#0b1220); color: #e6eef6; }
    /* Small overrides for table readability in dark */
    table { border-collapse: collapse; }
    th, td { border: 1px solid rgba(255,255,255,0.08); padding: 8px; text-align: center; }
    .editable:focus { outline: 2px dashed rgba(255,255,255,0.12); }
    .avatar { width:64px; height:64px; border-radius:9999px; object-fit:cover; border:3px solid #fff9; }
  </style>
</head>
<body class="antialiased">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between gap-6 mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-indigo-300">Ai_dali_nadjib_emploi_cem</h1>
        <p class="text-sm text-slate-300 mt-1">ูููุฏ ูุชูุฏู ูุงุณุชุนูุงู ุงูุฒูู โ ุงุถุบุท ยซูุคุณุณุชูยป ุซู ยซุชูููุฏยป โ ูู ุชูููุฏ ูุนุทู ุงุญุชูุงููุง ุฌุฏูุฏูุง.</p>
      </div>
      <div class="text-right flex items-center gap-4">
        <div class="text-sm">
          <div>ุงููุคุณุณุฉ: <strong id="showInstitution">โ</strong></div>
          <div>ุงูุฃุณุชุงุฐ (ูููุฐุฌู): <strong id="showTeacher">โ</strong></div>
        </div>
        <div>
          <img id="avatar" src="" alt="avatar" class="avatar hidden">
          <div class="text-sm mt-2">
            <input id="imgFile" type="file" accept="image/*" class="hidden" />
            <button id="btnUpload" class="px-3 py-1 rounded bg-slate-600 hover:bg-slate-500 text-white text-sm">ุชุญููู ุตูุฑุฉ</button>
          </div>
        </div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left column: controls -->
      <section class="lg:col-span-1 space-y-4">
        <div class="bg-slate-800 p-4 rounded shadow">
          <h2 class="font-bold text-lg text-indigo-200">1. ุฅุนุฏุงุฏ ุงููุคุณุณุฉ</h2>
          <label class="block mt-2 text-sm text-slate-300">ุงุณู ุงููุคุณุณุฉ</label>
          <input id="institutionName" class="mt-1 w-full p-2 rounded bg-slate-700 text-white" placeholder="ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด" />

          <div class="grid grid-cols-2 gap-2 mt-3">
            <label class="text-sm">ุณูุฉ 1ู - ุฃูุณุงู<input id="lvl1" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="5"></label>
            <label class="text-sm">ุณูุฉ 2ู - ุฃูุณุงู<input id="lvl2" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="4"></label>
            <label class="text-sm">ุณูุฉ 3ู - ุฃูุณุงู<input id="lvl3" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="3"></label>
            <label class="text-sm">ุณูุฉ 4ู - ุฃูุณุงู<input id="lvl4" type="number" min="0" class="mt-1 p-2 rounded bg-slate-700" value="2"></label>
          </div>
          <div class="mt-2 text-sm text-slate-300">ุฅุฌูุงูู ุงูุฃูุณุงู: <strong id="totalClasses">14</strong></div>
        </div>

        <div class="bg-slate-800 p-4 rounded shadow">
          <h2 class="font-bold text-lg text-indigo-200">2. ุงูุฃุณุงุชุฐุฉ (ูุงุจูุฉ ููุชุนุฏูู)</h2>
          <p class="text-sm text-slate-300">ุงุถุบุท ยซูุคุณุณุชูยป ูููุก ุฃูุซูุฉ ุฌุงูุฒุฉ. ููููู ุญุฐู ุฃู ุชุนุฏูู. (ุงููุตุงุจ ุงูุฃูุตู: 20)</p>

          <div class="mt-3 max-h-56 overflow-auto">
            <table id="teachersTable" class="min-w-full text-sm">
              <thead><tr class="text-left text-slate-400"><th>ุฃุณุชุงุฐ</th><th>ูุงุฏุฉ</th><th>ุฃูุณุงู</th><th>ุณุงุนุงุช</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnMyInst" class="px-3 py-2 rounded bg-emerald-600">๐ซ ูุคุณุณุชู</button>
            <button id="btnReset" class="px-3 py-2 rounded bg-slate-600">๐ ุฅุนุงุฏุฉ ุงูุชุนููู</button>
            <button id="btnGenerate" class="px-3 py-2 rounded bg-indigo-600">โก ุชูููุฏ ุงูุฌุฏุงูู</button>
            <button id="btnRegen" class="px-3 py-2 rounded bg-indigo-500">๐ ุฅุนุงุฏุฉ ุชูููุฏ</button>
          </div>

          <div class="mt-3 text-xs text-slate-300 space-y-1">
            <div>ุฃููุงู: <span class="px-2 py-1 rounded bg-green-200 text-black">ุฑุณููุฉ</span> <span class="px-2 py-1 rounded bg-yellow-200 text-black">ุงุณุชุฏุฑุงู</span> <span class="px-2 py-1 rounded bg-violet-200 text-black">ูุฑุงุบ</span> <span class="px-2 py-1 rounded bg-amber-200 text-black">ุฑุงุญุฉ</span></div>
            <div class="text-amber-200 font-semibold">ููุงุญุธุฉ: ุงูุฎูุงุฑุฒููุฉ ุชุญุงูู ููุก ุงูุฌุฏุงูู ุจุฏูู ุชุนุงุฑุถุงุช ูุชูููู ุงููุฑุงุบุงุช.</div>
          </div>
        </div>

        <div class="bg-slate-800 p-4 rounded shadow">
          <h2 class="font-bold text-lg text-indigo-200">3. ุฅุนุฏุงุฏุงุช ุจูุฏุงุบูุฌูุฉ</h2>
          <div class="grid grid-cols-2 gap-2 text-sm mt-2">
            <label>ุฑูุงุถูุงุช<select id="pdMath" class="p-2 rounded bg-slate-700"><option>ุงูุฎููุณ</option><option>ุงูุงุซููู</option></select></label>
            <label>ุนุฑุจูุฉ<select id="pdArabic" class="p-2 rounded bg-slate-700"><option>ุงูุงุซููู</option><option>ุงูุฎููุณ</option></select></label>
            <label>ูุฑูุณูุฉ<select id="pdFrench" class="p-2 rounded bg-slate-700"><option>ุงูุซูุงุซุงุก</option></select></label>
            <label>ุงูุฌููุฒูุฉ<select id="pdEng" class="p-2 rounded bg-slate-700"><option>ุงูุงุซููู</option></select></label>
            <label>ุนููู<select id="pdSci" class="p-2 rounded bg-slate-700"><option>ุงูุฃุฑุจุนุงุก</option></select></label>
            <label>ููุฒูุงุก<select id="pdPhy" class="p-2 rounded bg-slate-700"><option>ุงูุซูุงุซุงุก</option></select></label>
          </div>
        </div>

        <div class="bg-slate-800 p-4 rounded shadow text-sm">
          <h3 class="font-semibold text-indigo-200">ุญุงูุฉ ุงูุชูููุฏ</h3>
          <pre id="diagnostic" class="text-xs text-amber-200 min-h-[70px]">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ.</pre>
          <div class="mt-2 flex gap-2">
            <button id="btnCopy" class="px-3 py-2 rounded bg-sky-600">๐ ูุณุฎ HTML</button>
            <button id="btnCSV" class="px-3 py-2 rounded bg-sky-700">๐ Excel (CSV)</button>
            <button id="btnWord" class="px-3 py-2 rounded bg-sky-500">๐ Word</button>
            <button id="btnPDF" class="px-3 py-2 rounded bg-sky-400">๐ PDF</button>
          </div>
        </div>
      </section>

      <!-- Middle: output -->
      <section class="lg:col-span-2 space-y-4">
        <div id="outputArea" class="bg-slate-900 p-4 rounded shadow min-h-[160px]">
          <p class="text-slate-400">ุงููุชุงุฆุฌ ุณุชุธูุฑ ููุง ุจุนุฏ ุงูุถุบุท ุนูู ยซุชูููุฏ ุงูุฌุฏุงููยป.</p>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-400">
      ููููู ุชุนุฏูู ุฃู ุฎููุฉ ุจุนุฏ ุงูุชูููุฏ (ุงููุฑ ูุงูุชุจ). ุนูุฏ ุชุนุฏูู ูุฏูู ุงุณุชุฎุฏู ุฒุฑ ุงูุชุตุฏูุฑ ูุญูุธ ุงููุณุฎุฉ ุงูููุงุฆูุฉ. ุฅุฐุง ูุฌุฏ ุฎุทุฃ ูู ุงููุตุงุจ ุฃู ุชูุฑุงุฑ ุณุงุนุชู ููุณ ุงููุงุฏุฉ ูููุงู ูุณุชุธูุฑ ุฑุณุงูุฉ ูู ุฎุงูุฉ ุงูุญุงูุฉ.
    </footer>
  </div>

  <!-- Libraries for PDF (dynamic load when needed) -->
  <script>
  /* ========== ุจูุงูุงุช ุซุงุจุชุฉ ูููุงุนุฏ ==========
     - ุณุงุนุงุช: 08:00-09:00 ... 15:00-16:00
     - ุงุณุชุฑุงุญุฉ 12:00-13:00
     - ุงูุซูุงุซุงุก ูุตู ููู (ุจุนุฏ 12:00 ูุตูู ูุตูุฑุฉ)
     - ุงูุฑูุงุถูุงุช ููุถูุฉ ุตุจุงุญูุง
     - ูุตุงุจ ุงูุฃุณุชุงุฐ ุงูุฃูุตู 20
     - ุฎูุงุฑุฒููุฉ: ูุญุงููุงุช ุนุดูุงุฆูุฉ + backtracking ูุญู ูููุฏู
  ========== */

  const DAYS = ['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ'];
  const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
  const BREAK = '12:00-13:00';
  const MAX_TEACHER = 20;

  // ุณุงุนุงุช ุฑุณููุฉ ุชูุฑูุจูุฉ ุจุงููุณุชููุงุช: subjectHours[subject][level]
  const subjectHours = {
    'ุฑูุงุถูุงุช': {'1':4,'2':4,'3':5,'4':5},
    'ุนุฑุจูุฉ': {'1':4,'2':4,'3':4,'4':4},
    'ูุฑูุณูุฉ': {'1':3,'2':3,'3':3,'4':3},
    'ุงูุฌููุฒูุฉ': {'1':3,'2':3,'3':3,'4':3},
    'ุนููู ุทุจูุนูุฉ': {'1':3,'2':3,'3':3,'4':3},
    'ููุฒูุงุก': {'1':2,'2':2,'3':2,'4':2},
    'ุชุงุฑูุฎ ูุฌุบุฑุงููุง': {'1':2,'2':2,'3':2,'4':2},
    'ุชุฑุจูุฉ ูุฏููุฉ': {'1':1,'2':1,'3':1,'4':1},
    'ุชุฑุจูุฉ ุงุณูุงููุฉ': {'1':2,'2':2,'3':2,'4':2},
    'ุฑูุงุถุฉ': {'1':2,'2':2,'3':2,'4':2},
    'ุฅุนูุงู ุขูู': {'1':1,'2':1,'3':1,'4':0},
    'ุฑุณู': {'1':1,'2':1,'3':1,'4':1}
  };

  // pedagogical default
  let pedagogicalDays = {
    'ุฑูุงุถูุงุช':'ุงูุฎููุณ','ุนุฑุจูุฉ':'ุงูุงุซููู','ูุฑูุณูุฉ':'ุงูุซูุงุซุงุก','ุงูุฌููุฒูุฉ':'ุงูุงุซููู','ุนููู ุทุจูุนูุฉ':'ุงูุฃุฑุจุนุงุก','ููุฒูุงุก':'ุงูุซูุงุซุงุก','ุฑุณู':'ุงูุฎููุณ','ุฅุนูุงู ุขูู':'ุงูุฃุฑุจุนุงุก'
  };

  // current state
  let teachers = []; // array of {name,subject,sections:[],hours,totalAssigned}
  let institution = { name:'', levels: {1:5,2:4,3:3,4:2} };
  let lastSchedule = null;

  // Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
  function deepClone(v){ return JSON.parse(JSON.stringify(v)); }

  // UI wiring
  $('#btnUpload').addEventListener('click',()=> $('#imgFile').click());
  $('#imgFile').addEventListener('change',(e)=> {
    const f = e.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f); $('#avatar').src = url; $('#avatar').classList.remove('hidden');
  });

  $('#lvl1').addEventListener('change',updateTotal);
  $('#lvl2').addEventListener('change',updateTotal);
  $('#lvl3').addEventListener('change',updateTotal);
  $('#lvl4').addEventListener('change',updateTotal);

  $('#btnMyInst').addEventListener('click', loadMyInstitution);
  $('#btnReset').addEventListener('click', ()=> { if(confirm('ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุงูุชุนููู (ุชูุฑูุบ ุงููุฏุฎูุงุช ูุงูุฌุฏุงูู)ุ')) resetAll(); });
  $('#btnGenerate').addEventListener('click', ()=> generateAll());
  $('#btnRegen').addEventListener('click', ()=> regenerate());
  $('#btnCopy').addEventListener('click', copyHTML);
  $('#btnCSV').addEventListener('click', exportCSV);
  $('#btnWord').addEventListener('click', exportWord);
  $('#btnPDF').addEventListener('click', exportPDF);

  updateTotal();
  renderTeachersUI();

  // build sections list from levels
  function buildSections(){
    const arr = [];
    const l1 = parseInt($('#lvl1').value||0);
    const l2 = parseInt($('#lvl2').value||0);
    const l3 = parseInt($('#lvl3').value||0);
    const l4 = parseInt($('#lvl4').value||0);
    for(let i=1;i<=l1;i++) arr.push(`1ู${i}`);
    for(let i=1;i<=l2;i++) arr.push(`2ู${i}`);
    for(let i=1;i<=l3;i++) arr.push(`3ู${i}`);
    for(let i=1;i<=l4;i++) arr.push(`4ู${i}`);
    return arr;
  }

  function updateTotal(){
    const total = ['#lvl1','#lvl2','#lvl3','#lvl4'].reduce((acc,sel)=> acc + (parseInt($(sel).value||0)),0);
    $('#totalClasses').innerText = total;
  }

  // render teachers table
  function renderTeachersUI(){
    const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
    teachers.forEach((t,i)=>{
      const tr = document.createElement('tr');
      tr.className = 'align-top';
      const secs = (t.sections && t.sections.length) ? t.sections.join(',') : 'โ';
      tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${secs}</td><td class="p-2">${t.hours}</td><td class="p-2"><button class="px-2 py-1 bg-red-600 rounded text-xs" onclick="deleteTeacher(${i})">ุญุฐู</button></td>`;
      tbody.appendChild(tr);
    });
  }

  window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); }

  // load your institution defaults
  function loadMyInstitution(){
    resetAll(false);
    institution.name = 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด';
    $('#institutionName').value = institution.name;
    $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2;
    updateTotal();

    teachers = [
      {name:'ูุฌูุจ',subject:'ุฑูุงุถูุงุช',sections:[],hours:20,totalAssigned:0},
      {name:'ูููุฑุฉ',subject:'ุฑูุงุถูุงุช',sections:[],hours:18,totalAssigned:0},
      {name:'ุฑูุฒู',subject:'ุฑูุงุถูุงุช',sections:[],hours:18,totalAssigned:0},
      {name:'ุฃูุงู',subject:'ุฑูุงุถูุงุช',sections:[],hours:18,totalAssigned:0},

      {name:'ุตุจุฑููุฉ',subject:'ุนุฑุจูุฉ',sections:[],hours:18,totalAssigned:0},
      {name:'ูุฑูุฉ',subject:'ุนุฑุจูุฉ',sections:[],hours:18,totalAssigned:0},
      {name:'ุณุงุฑุฉ',subject:'ุนุฑุจูุฉ',sections:[],hours:18,totalAssigned:0},
      {name:'ูุญูุฏ',subject:'ุนุฑุจูุฉ',sections:[],hours:16,totalAssigned:0},
      {name:'ุนุงูุฑ',subject:'ุนุฑุจูุฉ',sections:[],hours:16,totalAssigned:0},

      {name:'ุงูุนูุฏ',subject:'ูุฑูุณูุฉ',sections:[],hours:16,totalAssigned:0},
      {name:'ุณููู',subject:'ูุฑูุณูุฉ',sections:[],hours:16,totalAssigned:0},
      {name:'ุณุงุฑุฉ_ู',subject:'ูุฑูุณูุฉ',sections:[],hours:16,totalAssigned:0},

      {name:'ุจูุจูุฑ',subject:'ุงูุฌููุฒูุฉ',sections:[],hours:12,totalAssigned:0},
      {name:'ูุดุงู',subject:'ุงูุฌููุฒูุฉ',sections:[],hours:12,totalAssigned:0},
      {name:'ุฃูููุฉ_ุงู',subject:'ุงูุฌููุฒูุฉ',sections:[],hours:14,totalAssigned:0},

      {name:'ุนุงุฆุดุฉ',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:[],hours:12,totalAssigned:0},
      {name:'ูุงุทูุฉ',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:[],hours:10,totalAssigned:0},
      {name:'ุฃูุงู_ุช',subject:'ุชุงุฑูุฎ ูุฌุบุฑุงููุง',sections:[],hours:10,totalAssigned:0},

      {name:'ูุณููุฉ',subject:'ุนููู ุทุจูุนูุฉ',sections:[],hours:12,totalAssigned:0},
      {name:'ุทุงูุณ',subject:'ุนููู ุทุจูุนูุฉ',sections:[],hours:12,totalAssigned:0},

      {name:'ุนุจุฏ ุงูุฑุฒุงู',subject:'ููุฒูุงุก',sections:[],hours:12,totalAssigned:0},
      {name:'ุฃูููุฉ_ูู',subject:'ููุฒูุงุก',sections:[],hours:10,totalAssigned:0},

      {name:'ุนูุงุก',subject:'ุฑูุงุถุฉ',sections:[],hours:8,totalAssigned:0},
      {name:'ุณููุฑ',subject:'ุฑูุงุถุฉ',sections:[],hours:8,totalAssigned:0},

      {name:'ุณุนูุฏ',subject:'ุฑุณู',sections:[],hours:6,totalAssigned:0},
      {name:'ุฃูููุฉ_ุงุนูุงู',subject:'ุฅุนูุงู ุขูู',sections:[],hours:6,totalAssigned:0},
      {name:'ูุนูู_ุงุณูุงูู',subject:'ุชุฑุจูุฉ ุงุณูุงููุฉ',sections:[],hours:8,totalAssigned:0}
    ];

    $('#showInstitution').innerText = institution.name;
    $('#showTeacher').innerText = 'ุฏุงูู ูุฌูุจ โ ุฑูุงุถูุงุช';
    renderTeachersUI();
    $('#diagnostic').innerText = 'ุชู ุชุญููู ุจูุงูุงุช ูุคุณุณุชู ุงููููุฐุฌูุฉ. ุงุถุบุท ุชูููุฏ.';
  }

  // reset UI & data
  function resetAll(clearUI=true){
    teachers = [];
    institution = { name:'', levels:{1:0,2:0,3:0,4:0} };
    $('#institutionName').value = '';
    $('#lvl1').value='0'; $('#lvl2').value='0'; $('#lvl3').value='0'; $('#lvl4').value='0';
    updateTotal();
    $('#showInstitution').innerText = 'โ';
    $('#showTeacher').innerText = 'โ';
    $('#outputArea').innerHTML = '<p class="text-slate-400">ุงููุชุงุฆุฌ ุณุชุธูุฑ ููุง ุจุนุฏ ุงูุชูููุฏ.</p>';
    $('#diagnostic').innerText = 'ุชู ุงูุชูุฑูุบ.';
    if(clearUI) renderTeachersUI();
  }

  // core generator: randomized multi-trial + backtracking heuristic
  function generateAll(){
    // read settings
    institution.name = $('#institutionName').value || 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด';
    pedagogicalDays['ุฑูุงุถูุงุช'] = $('#pdMath').value || pedagogicalDays['ุฑูุงุถูุงุช'];
    pedagogicalDays['ุนุฑุจูุฉ'] = $('#pdArabic').value || pedagogicalDays['ุนุฑุจูุฉ'];
    pedagogicalDays['ูุฑูุณูุฉ'] = $('#pdFrench').value || pedagogicalDays['ูุฑูุณูุฉ'];
    pedagogicalDays['ุงูุฌููุฒูุฉ'] = $('#pdEng').value || pedagogicalDays['ุงูุฌููุฒูุฉ'];
    pedagogicalDays['ุนููู ุทุจูุนูุฉ'] = $('#pdSci').value || pedagogicalDays['ุนููู ุทุจูุนูุฉ'];
    pedagogicalDays['ููุฒูุงุก'] = $('#pdPhy').value || pedagogicalDays['ููุฒูุงุก'];

    const sections = buildSections();
    if(sections.length===0){ alert('ูุง ุฃูุณุงู ูุญุฏุฏุฉ. ุงุถุบุท ูุคุณุณุชู ุฃู ุฃุฏุฎู ุนุฏุฏ ุงูุฃูุณุงู.'); return; }
    if(teachers.length===0){ if(confirm('ูุงุฆูุฉ ุงูุฃุณุงุชุฐุฉ ูุงุฑุบุฉ. ุชุญููู ูุคุณุณุชูุ')) loadMyInstitution(); else return; }

    // compute requirements per section
    const req = {};
    sections.forEach(sec=>{
      const lvl = sec.charAt(0);
      req[sec] = {};
      for(const subj in subjectHours){
        const h = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
        if(h>0) req[sec][subj] = h;
      }
      // special: 4th grade no info sys
      if(sec.startsWith('4') && req[sec]['ุฅุนูุงู ุขูู']) delete req[sec]['ุฅุนูุงู ุขูู'];
      if(sec.startsWith('4') && !req[sec]['ุฑุณู']) req[sec]['ุฑุณู'] = 1;
    });

    // teacher index snapshot
    const MAX_TRIALS = 500;
    let best = null;
    let diag = '';

    // schedule template
    function makeSchedule() {
      const S = {};
      sections.forEach(sec=>{
        S[sec] = {};
        for(const d of DAYS){ S[sec][d] = {}; for(const s of SLOTS) S[sec][d][s] = null; }
      });
      return S;
    }

    // teacher busy map
    function makeBusy() {
      const busy = {};
      teachers.forEach(t=>{ busy[t.name] = {}; for(const d of DAYS){ busy[t.name][d] = {}; for(const s of SLOTS) busy[t.name][d][s] = false; } });
      return busy;
    }

    // candidate teachers selection
    function candidateTeachers(subject, section, tstate){
      const cand = tstate.filter(x=> x.subject === subject);
      // prefer those assigned to the section (if sections set) or with less assigned
      cand.sort((a,b)=>{
        const aHas = a.sections && a.sections.includes(section);
        const bHas = b.sections && b.sections.includes(section);
        if(aHas && !bHas) return -1;
        if(!aHas && bHas) return 1;
        return (a.totalAssigned||0) - (b.totalAssigned||0);
      });
      return cand;
    }

    // trial loop
    const sectionsShuffledBase = sections.slice();
    outer:
    for(let trial=0; trial<MAX_TRIALS; trial++){
      // prepare
      const schedule = makeSchedule();
      const tstate = teachers.map(t=> ({...t, totalAssigned:0}));
      const busy = makeBusy();
      shuffle(sectionsShuffledBase);
      let failed = false;

      // allocate per section
      for(const sec of sectionsShuffledBase){
        const lvl = sec.charAt(0);
        // subject order by need desc
        const subjects = Object.keys(req[sec]).sort((a,b)=> req[sec][b] - req[sec][a]);
        // recursive assignment per subject
        function assignSubject(idx){
          if(idx>=subjects.length) return true;
          const subj = subjects[idx];
          let need = req[sec][subj];
          // build candidate slots: respect pedagogy and Tuesday half day and break
          const slotCandidates = [];
          for(const d of DAYS){
            if(pedagogicalDays[subj] && pedagogicalDays[subj] === d) continue;
            const orderSlots = (subj==='ุฑูุงุถูุงุช') ? ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'] : SLOTS.slice();
            for(const s of orderSlots){
              if(d==='ุงูุซูุงุซุงุก' && ['13:00-14:00','14:00-15:00','15:00-16:00'].includes(s)) continue;
              if(s===BREAK) continue;
              slotCandidates.push({d,s});
            }
          }
          shuffle(slotCandidates);

          const chosen = [];
          function placeOne(k){
            if(k>=need) return true;
            for(const ds of slotCandidates){
              const {d,s} = ds;
              if(schedule[sec][d][s]) continue; // slot taken for this section
              // avoid >2 same subj in same day for same section
              const sameDay = SLOTS.reduce((a,sl)=> a + (schedule[sec][d][sl] && schedule[sec][d][sl].subj===subj ? 1:0), 0);
              if(sameDay>=2) continue;
              // find teacher
              const cands = candidateTeachers(subj, sec, tstate);
              shuffle(cands);
              for(const cand of cands){
                if(cand.totalAssigned >= cand.hours) continue;
                if(cand.totalAssigned >= MAX_TEACHER) continue;
                if(busy[cand.name][d][s]) continue;
                // assign
                schedule[sec][d][s] = { subj, teacher: cand.name, type: 'official' };
                cand.totalAssigned++;
                busy[cand.name][d][s] = true;
                chosen.push({d,s,cand:cand.name});
                if(placeOne(k+1)) return true;
                // backtrack
                const r = chosen.pop();
                schedule[sec][r.d][r.s] = null;
                const t = tstate.find(x=>x.name===r.cand); if(t) t.totalAssigned--;
                busy[r.cand][r.d][r.s] = false;
              }
            }
            return false;
          }
          const ok = placeOne(0);
          if(!ok) return false;
          return assignSubject(idx+1);
        }

        const ok = assignSubject(0);
        if(!ok){ failed = true; break; }
      } // end sections

      if(!failed){
        // verify all needs met & no teacher > MAX
        let okAll = true;
        for(const sec of sections){
          for(const subj in req[sec]){
            const need = req[sec][subj];
            const got = DAYS.reduce((a,d)=> a + SLOTS.reduce((x,s)=> x + (schedule[sec][d][s] && schedule[sec][d][s].subj===subj ? 1:0),0), 0);
            if(got < need){ okAll = false; break; }
          }
          if(!okAll) break;
        }
        if(!okAll) continue;
        if(tstate.some(t=> t.totalAssigned > MAX_TEACHER)){ continue; }
        // success
        best = schedule;
        // update teachers assigned counts
        teachers.forEach(t=> t.totalAssigned = 0);
        for(const sec of sections){
          for(const d of DAYS) for(const s of SLOTS){
            const c = best[sec][d][s];
            if(c){
              const t = teachers.find(x=> x.name===c.teacher);
              if(t) t.totalAssigned = (t.totalAssigned||0) + 1;
            }
          }
        }
        break outer;
      }
    } // end trials

    if(!best){
      $('#diagnostic').innerText = 'ูุดู ุฅูุฌุงุฏ ุญู ูุงูู ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช. ุญุงูู ุฅุถุงูุฉ ุฃุณุงุชุฐุฉ ุฃู ุชูููู ุงููุตุงุจ ุฃู ุฒูุงุฏุฉ ุงูุฃุณุงุชุฐุฉ ูู ุงูููุงุฏ ุงููุนููุฉ.';
      renderResult(null, buildSections());
      return;
    }

    lastSchedule = best;
    $('#diagnostic').innerText = 'ุชู ุงูุชูููุฏ ุจูุฌุงุญ. ุงุถุบุท ุฅุนุงุฏุฉ ุชูููุฏ (๐) ููุญุตูู ุนูู ุญู ุขุฎุฑ.';
    renderResult(best, buildSections());
  }

  function regenerate(){ generateAll(); }

  // render results
  function renderResult(schedule, sections){
    const out = $('#outputArea');
    out.innerHTML = '';
    const header = document.createElement('div');
    header.innerHTML = `<div class="flex items-center justify-between mb-3"><div><h2 class="text-xl text-indigo-300 font-semibold">${$('#institutionName').value || 'ูุชูุณุทุฉ ูุดูุชู ูุญูุฏ ุงูุทุงูุฑ - ุชููุงุด'}</h2><div class="text-sm text-slate-300">ุฃูุณุงู: ${sections.join(', ')}</div></div><div class="text-sm"><button class="px-3 py-1 rounded bg-green-600" onclick="document.getElementById('btnCSV').click()">ุงุณุชุฎุฑุงุฌ CSV</button></div></div>`;
    out.appendChild(header);

    if(!schedule){
      const p = document.createElement('p'); p.className='text-slate-300'; p.textContent = 'ูู ููููููุฏ ุฌุฏูู ุจุนุฏ ุฃู ูู ููุนุซุฑ ุนูู ุญู.'; out.appendChild(p); return;
    }

    // institution summary (per day)
    for(const d of DAYS){
      const dayTitle = document.createElement('h3'); dayTitle.className = 'text-lg mt-4 text-indigo-200'; dayTitle.textContent = d; out.appendChild(dayTitle);
      const tableWrap = document.createElement('div'); tableWrap.className = 'overflow-auto';
      let html = `<table class="schedule-table w-full bg-white text-black"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
      sections.forEach(s=> html += `<th class="slot">${s}</th>`);
      html += `</tr></thead><tbody>`;
      for(const slot of SLOTS){
        html += `<tr><td>${slot}</td>`;
        for(const sec of sections){
          const cell = schedule[sec] && schedule[sec][d] ? schedule[sec][d][slot] : null;
          if(cell){
            html += `<td contenteditable="true" class="editable" data-sec="${sec}" data-day="${d}" data-slot="${slot}"><strong>${cell.subj}</strong><br/><small>${cell.teacher}</small></td>`;
          } else {
            if(slot==='13:00-14:00') html += `<td contenteditable="true" class="editable">ุฑุงุญุฉ</td>`;
            else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) html += `<td contenteditable="true">โ</td>`;
            else html += `<td contenteditable="true" class="editable">ูุฑุงุบ</td>`;
          }
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
      out.appendChild(tableWrap);
    }

    // students per section (compact)
    const sectionsDiv = document.createElement('div'); sectionsDiv.className='mt-6';
    sectionsDiv.innerHTML = `<h3 class="text-lg text-indigo-200">ุฌุฏุงูู ุงูุชูุงููุฐ (ุฃูุณุงู)</h3>`;
    for(const sec of sections){
      let secHTML = `<h4 class="mt-2 font-semibold">${sec}</h4><div class="overflow-auto"><table class="schedule-table w-full bg-white text-black"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
      DAYS.forEach(d=> secHTML += `<th>${d}</th>`);
      secHTML += `</tr></thead><tbody>`;
      for(const slot of SLOTS){
        secHTML += `<tr><td>${slot}</td>`;
        for(const d of DAYS){
          const cell = schedule[sec] && schedule[sec][d] ? schedule[sec][d][slot] : null;
          if(cell) secHTML += `<td contenteditable="true" class="editable official">${cell.subj}<br/><small>${cell.teacher}</small></td>`;
          else {
            if(slot==='13:00-14:00') secHTML += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
            else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(slot)>=4) secHTML += `<td contenteditable="true">โ</td>`;
            else secHTML += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
          }
        }
        secHTML += `</tr>`;
      }
      secHTML += `</tbody></table></div>`;
      sectionsDiv.insertAdjacentHTML('beforeend', secHTML);
    }
    out.appendChild(sectionsDiv);

    // teachers schedules
    const teachDiv = document.createElement('div'); teachDiv.className = 'mt-6';
    teachDiv.innerHTML = `<h3 class="text-lg text-indigo-200">ุฌุฏุงูู ุงูุฃุณุงุชุฐุฉ</h3>`;
    for(const t of teachers){
      let tHTML = `<h4 class="mt-2 font-semibold">${t.name} โ ${t.subject} (ูุตุงุจ: ${t.hours})</h4><div class="overflow-auto"><table class="schedule-table w-full bg-white text-black"><thead><tr><th>ุงูุณุงุนุฉ</th>`;
      DAYS.forEach(d=> tHTML += `<th>${d}</th>`); tHTML += `</tr></thead><tbody>`;
      for(const s of SLOTS){
        tHTML += `<tr><td>${s}</td>`;
        for(const d of DAYS){
          // search if this teacher teaches any section at this day & slot
          let found = null;
          for(const sec of sections){
            const c = schedule[sec] && schedule[sec][d] ? schedule[sec][d][s] : null;
            if(c && c.teacher === t.name){ found = {sec,c}; break; }
          }
          if(found) tHTML += `<td contenteditable="true" class="editable official">${found.sec}<br/><small>${found.c.subj}</small></td>`;
          else {
            if(s==='13:00-14:00') tHTML += `<td contenteditable="true" class="break">ุฑุงุญุฉ</td>`;
            else if(d==='ุงูุซูุงุซุงุก' && SLOTS.indexOf(s)>=4) tHTML += `<td contenteditable="true">โ</td>`;
            else tHTML += `<td contenteditable="true" class="free">ูุฑุงุบ</td>`;
          }
        }
        tHTML += `</tr>`;
      }
      tHTML += `</tbody></table></div>`;
      teachDiv.insertAdjacentHTML('beforeend', tHTML);
    }
    out.appendChild(teachDiv);

    // scroll to output
    setTimeout(()=> window.scrollTo({top: out.offsetTop - 20, behavior:'smooth'}), 60);
  }

  // simple copy html
  function copyHTML(){
    const out = $('#outputArea');
    navigator.clipboard.writeText(out.innerHTML).then(()=> alert('ุชู ูุณุฎ HTML'));
  }

  // export CSV (concatenate tables)
  function exportCSV(){
    const out = $('#outputArea');
    if(!out.innerHTML.trim()){ alert('ูุง ุฌุฏุงูู ููุชุตุฏูุฑ'); return; }
    const tables = out.querySelectorAll('.schedule-table');
    let csv = '';
    tables.forEach((table,idx)=>{
      const caption = table.previousElementSibling ? table.previousElementSibling.innerText.replace(/\n/g,' ') : `Table ${idx+1}`;
      csv += `"${caption}"\n`;
      for(const row of table.rows){
        const cells = Array.from(row.cells).map(c => '"' + c.innerText.replace(/"/g,'""').replace(/\n/g,' / ') + '"');
        csv += cells.join(',') + '\n';
      }
      csv += '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schedules.csv'; a.click();
    URL.revokeObjectURL(a.href);
  }

  // export Word (simple HTML -> doc)
  function exportWord(){
    const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('ูุง ุฌุฏุงูู ููุชุตุฏูุฑ'); return; }
    const html = '<html><head><meta charset="utf-8"></head><body dir="rtl">' + out.innerHTML + '</body></html>';
    const blob = new Blob(['\ufeff', html], {type:'application/msword'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'schedules.doc'; a.click();
    URL.revokeObjectURL(a.href);
  }

  // export PDF using html2canvas + jsPDF (load if needed)
  async function exportPDF(){
    const out = $('#outputArea'); if(!out.innerHTML.trim()){ alert('ูุง ุฌุฏุงูู ููุชุตุฏูุฑ'); return; }
    if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    if(typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const canvas = await html2canvas(out, { scale: 1.2, logging:false, useCORS:true, backgroundColor:'#0b1220' });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf || window.jspdf;
    const pdf = new jsPDF('l','mm','a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(imgData,'PNG',0,0,w,h);
    pdf.save('schedules.pdf');
  }

  function loadScript(src){
    return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); });
  }

  // regenerate wrapper
  window.regenerate = regenerate;
  function regenerate(){ generateAll(); }

  // attach to global for buttons
  window.loadMyInstitution = loadMyInstitution;
  window.resetAll = resetAll;
  window.generateAll = generateAll;
  window.copyHTML = copyHTML;
  window.exportCSV = exportCSV;
  window.exportWord = exportWord;
  window.exportPDF = exportPDF;

  // Expose functions to inline buttons
  // minimal global binding for deleteTeacher used in generated rows
  window.deleteTeacher = function(){};

  // initial small helper to render empty message
  (function init(){
    $('#outputArea').innerHTML = '<p class="text-slate-400">ุงููุชุงุฆุฌ ุณุชุธูุฑ ููุง ุจุนุฏ ุงูุถุบุท ุนูู ยซุชูููุฏ ุงูุฌุฏุงููยป.</p>';
    $('#diagnostic').innerText = 'ุฌุงูุฒ';
  })();

  </script>
</body>
</html>
