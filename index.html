<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ai_dali_nadjib_emploi_cem â€” Ù†Ù‡Ø§Ø¦ÙŠ Ø°ÙƒÙŠ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#061021; --card:#0d1724; --accent:#6d28d9; --muted:#93c5fd;
      --text-dark:#071223;
    }
    body{background:linear-gradient(180deg,#04102a,#061021);color:#e6eef6;font-family:Inter,Segoe UI,Arial}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.6)}
    table{border-collapse:collapse}
    th,td{border:1px solid rgba(255,255,255,0.06);padding:6px;text-align:center}
    .editable{outline:none}
    .avatar{width:64px;height:64px;border-radius:9999px;object-fit:cover;border:3px solid rgba(255,255,255,.08)}
    .tag{padding:6px 8px;border-radius:8px;font-weight:700}
    .official{background:#c8e6c9;color:#081018}
    .remedial{background:#fff59d;color:#081018}
    .project{background:#a5d6a7;color:#081018}
    .free{background:#d1c4e9;color:#081018}
    .break{background:#ffe082;color:#081018}
    .small{font-size:13px;color:#9fb7d9}
    .danger{color:#ffb4b4}
    .success{color:#b8f3c2}
    .btn{padding:8px 12px;border-radius:8px;font-weight:700}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-extrabold text-indigo-300">Ai_dali_nadjib_emploi_cem â€” Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø²Ù…Ù†</h1>
        <div class="small mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>Ù…Ø¤Ø³Ø³ØªÙŠ</strong> Ù„Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø«Ù… <strong>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</strong>. ÙƒÙ„ ØªÙˆÙ„ÙŠØ¯ ÙŠØ¹Ø·ÙŠ Ø§Ø­ØªÙ…Ø§Ù„Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.</div>
      </div>
      <div class="text-right flex items-center gap-4">
        <div class="text-right">
          <div>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: <strong id="showInstitution">â€”</strong></div>
          <div>Ø£Ø³ØªØ§Ø° Ù†Ù…ÙˆØ°Ø¬ÙŠ: <strong id="showTeacher">â€”</strong></div>
        </div>
        <div>
          <img id="avatar" class="avatar hidden" alt="profile">
          <div class="mt-2">
            <input id="imgFile" type="file" accept="image/*" class="hidden">
            <button id="btnUpload" class="btn bg-slate-600" title="ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Controls column -->
      <div class="lg:col-span-1 space-y-4">
        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h2>
          <label class="block small mt-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <input id="institutionName" class="w-full p-2 rounded bg-slate-800 text-white" placeholder="Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´">

          <div class="grid grid-cols-2 gap-2 mt-3">
            <label class="small">Ø³Ù†Ø© 1Ù…: <input id="lvl1" type="number" min="0" value="5" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">Ø³Ù†Ø© 2Ù…: <input id="lvl2" type="number" min="0" value="4" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">Ø³Ù†Ø© 3Ù…: <input id="lvl3" type="number" min="0" value="3" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
            <label class="small">Ø³Ù†Ø© 4Ù…: <input id="lvl4" type="number" min="0" value="2" class="p-2 mt-1 w-full rounded bg-slate-800"></label>
          </div>
          <div class="mt-2 small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: <strong id="totalClasses">14</strong></div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">2. Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h2>
          <div class="small">Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø¤Ø³Ø³ØªÙŠ) Ø«Ù… ØªØ¹Ø¯ÙŠÙ„. Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†ØµØ§Ø¨: <strong>20</strong> Ø³Ø§Ø¹Ø©.</div>
          <div class="mt-2 overflow-auto" style="max-height:240px">
            <table id="teachersTable" class="w-full text-sm">
              <thead><tr class="text-slate-300"><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</th><th>Ø³Ø§Ø¹Ø§Øª</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnMyInst" class="btn bg-emerald-600">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ</button>
            <button id="btnReset" class="btn bg-slate-600">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
            <button id="btnGenerate" class="btn bg-indigo-600">âš¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
            <button id="btnRegen" class="btn bg-indigo-500">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯</button>
          </div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">3. Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h2>
          <div class="mt-2">
            <button id="viewInstitution" class="btn bg-blue-600 w-full mb-2">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</button>
            <div class="flex gap-2">
              <select id="teacherSelector" class="w-full p-2 rounded bg-slate-800"></select>
              <button id="viewTeacherBtn" class="btn bg-blue-500">Ø¹Ø±Ø¶</button>
            </div>
            <div class="mt-2 flex gap-2">
              <select id="classSelector" class="w-full p-2 rounded bg-slate-800"></select>
              <button id="viewClassBtn" class="btn bg-blue-500">Ø¹Ø±Ø¶</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="text-lg font-bold text-indigo-200">4. ØªØµØ¯ÙŠØ± / Ù†Ø³Ø®</h2>
          <div class="flex gap-2 flex-wrap mt-2">
            <button id="btnCopy" class="btn bg-sky-600">ğŸ“‹ Ù†Ø³Ø® HTML</button>
            <button id="btnCSV" class="btn bg-sky-700">ğŸ“Š Excel (CSV)</button>
            <button id="btnWord" class="btn bg-sky-500">ğŸ“ƒ Word</button>
            <button id="btnPDF" class="btn bg-sky-400">ğŸ“„ PDF</button>
          </div>
          <div class="mt-3 small text-amber-200" id="diagnostic">Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯.</div>
        </div>
      </div>

      <!-- Output area (wide) -->
      <div class="lg:col-span-3 space-y-4">
        <div class="card" id="outputArea" style="min-height:280px">
          <p class="small text-slate-300">Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Â«ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„Â» Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù‡Ù†Ø§. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø®Ù„ÙŠØ© (Ø§Ù†Ù‚Ø± ÙˆØ§ÙƒØªØ¨).</p>
        </div>
      </div>
    </div>

    <footer class="text-sm text-slate-400">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆÙØ± Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø­Ù„Ù‹Ø§ Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹ ÙˆÙÙ‚ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª. Ø¥Ù† Ù„Ù… ÙŠØ¹Ø«Ø± Ø§Ù„Ø­Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ø³ÙŠÙØ¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø­Ù„ Ø¬Ø²Ø¦ÙŠ Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</footer>
  </div>

<script>
/* =========== Ø«ÙˆØ§Ø¨Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯ =========== */
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'];
const BREAK = '12:00-13:00';
const MAX_TEACHER = 20;

// Ù†ØµØ§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ù‚ÙŠØ§Ø³ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ) subjectHours[subject][level]
const subjectHours = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª': {'1':4,'2':4,'3':5,'4':5},
  'Ø¹Ø±Ø¨ÙŠØ©': {'1':4,'2':4,'3':4,'4':4},
  'ÙØ±Ù†Ø³ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©': {'1':3,'2':3,'3':3,'4':3},
  'ÙÙŠØ²ÙŠØ§Ø¡': {'1':2,'2':2,'3':2,'4':2},
  'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§': {'1':2,'2':2,'3':2,'4':2},
  'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©': {'1':1,'2':1,'3':1,'4':1},
  'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©': {'1':2,'2':2,'3':2,'4':2},
  'Ø±ÙŠØ§Ø¶Ø©': {'1':2,'2':2,'3':2,'4':2},
  'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ': {'1':1,'2':1,'3':1,'4':0},
  'Ø±Ø³Ù…': {'1':1,'2':1,'3':1,'4':1}
};

// Ø£ÙŠØ§Ù… Ø¨ÙŠØ¯Ø§ØºÙˆØ¬ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
let pedagogicalDays = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¹Ø±Ø¨ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','ÙØ±Ù†Ø³ÙŠØ©':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','ÙÙŠØ²ÙŠØ§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø±Ø³Ù…':'Ø§Ù„Ø®Ù…ÙŠØ³','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'
};

/* =========== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =========== */
let teachers = []; // ÙƒÙ„ Ø¹Ù†ØµØ±: {name, subject, sections:[], hours, totalAssigned}
let institution = { name:'', levels: {1:5,2:4,3:3,4:2} };
let lastSchedule = null; // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (schedule object)
let currentView = 'institution'; // Ø£Ùˆ 'teacher' Ø£Ùˆ 'class'
let lastSections = []; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©

/* =========== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª DOM =========== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

/* =========== Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© =========== */
$('#btnUpload').addEventListener('click', ()=> $('#imgFile').click());
$('#imgFile').addEventListener('change', function(e){ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); $('#avatar').src=url; $('#avatar').classList.remove('hidden'); });

$('#lvl1').addEventListener('change', updateTotal);
$('#lvl2').addEventListener('change', updateTotal);
$('#lvl3').addEventListener('change', updateTotal);
$('#lvl4').addEventListener('change', updateTotal);

$('#btnMyInst').addEventListener('click', loadMyInstitution);
$('#btnReset').addEventListener('click', ()=> { if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† ÙˆØªÙØ±ÙŠØº ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ')) resetAll(); });
$('#btnGenerate').addEventListener('click', ()=> { generateAll(); });
$('#btnRegen').addEventListener('click', ()=> { generateAll(true); }); // true => force new trial
$('#viewInstitution').addEventListener('click', ()=> showInstitutionTable());
$('#viewTeacherBtn').addEventListener('click', ()=> showTeacherTable($('#teacherSelector').value));
$('#viewClassBtn').addEventListener('click', ()=> showClassTable($('#classSelector').value));

$('#btnCopy').addEventListener('click', copyHTML);
$('#btnCSV').addEventListener('click', exportCSV);
$('#btnWord').addEventListener('click', exportWord);
$('#btnPDF').addEventListener('click', exportPDF);

/* =========== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© Ø£Ø³Ø§Ø³ÙŠØ© =========== */
function updateTotal(){
  const total = (parseInt($('#lvl1').value||0) + parseInt($('#lvl2').value||0) + parseInt($('#lvl3').value||0) + parseInt($('#lvl4').value||0));
  $('#totalClasses').innerText = total;
}

/* =========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© UI =========== */
function renderTeachersUI(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML = '';
  teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td><td class="p-2">${(t.sections.length? t.sections.join(',') : 'â€”')}</td><td class="p-2">${t.hours}</td><td class="p-2"><button onclick="deleteTeacher(${i})" class="px-2 py-1 bg-red-600 rounded text-xs">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  // ØªØ­Ø¯ÙŠØ« selectors
  const teacherSel = $('#teacherSelector'); teacherSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°</option>';
  teachers.forEach(t => { const o=document.createElement('option'); o.value=t.name; o.textContent = `${t.name} â€” ${t.subject}`; teacherSel.appendChild(o); });
  const classSel = $('#classSelector'); classSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…</option>';
  lastSections.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; classSel.appendChild(o); });
}

window.deleteTeacher = function(i){ teachers.splice(i,1); renderTeachersUI(); }

/* =========== Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© =========== */
function loadMyInstitution(){
  resetAll(false);
  institution.name = 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  $('#institutionName').value = institution.name;
  $('#lvl1').value=5; $('#lvl2').value=4; $('#lvl3').value=3; $('#lvl4').value=2;
  updateTotal();

  teachers = [
    {name:'Ù†Ø¬ÙŠØ¨',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:20,totalAssigned:0},
    {name:'Ù…Ù†ÙŠØ±Ø©',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
    {name:'Ø±Ù…Ø²ÙŠ',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},
    {name:'Ø£Ù…Ø§Ù„',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],hours:18,totalAssigned:0},

    {name:'ØµØ¨Ø±ÙŠÙ†Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'Ù…Ø±ÙˆØ©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'Ø³Ø§Ø±Ø©',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:18,totalAssigned:0},
    {name:'ÙˆØ­ÙŠØ¯',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø¹Ø§Ù…Ø±',subject:'Ø¹Ø±Ø¨ÙŠØ©',sections:[],hours:16,totalAssigned:0},

    {name:'Ø§Ù„Ø¹ÙŠØ¯',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø³Ù„Ù…Ù‰',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},
    {name:'Ø³Ø§Ø±Ø©_Ù',subject:'ÙØ±Ù†Ø³ÙŠØ©',sections:[],hours:16,totalAssigned:0},

    {name:'Ø¨ÙˆØ¨ÙƒØ±',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ù‡Ø´Ø§Ù…',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ù†',subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',sections:[],hours:14,totalAssigned:0},

    {name:'Ø¹Ø§Ø¦Ø´Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:12,totalAssigned:0},
    {name:'ÙØ§Ø·Ù…Ø©',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},
    {name:'Ø£Ù…Ø§Ù„_Øª',subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§',sections:[],hours:10,totalAssigned:0},

    {name:'ÙˆØ³ÙŠÙ„Ø©',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},
    {name:'Ø·Ø§ÙˆØ³',subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©',sections:[],hours:12,totalAssigned:0},

    {name:'Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:12,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_ÙÙŠ',subject:'ÙÙŠØ²ÙŠØ§Ø¡',sections:[],hours:10,totalAssigned:0},

    {name:'Ø¹Ù„Ø§Ø¡',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},
    {name:'Ø³Ù…ÙŠØ±',subject:'Ø±ÙŠØ§Ø¶Ø©',sections:[],hours:8,totalAssigned:0},

    {name:'Ø³Ø¹ÙŠØ¯',subject:'Ø±Ø³Ù…',sections:[],hours:6,totalAssigned:0},
    {name:'Ø£Ù…ÙŠÙ†Ø©_Ø§Ø¹Ù„Ø§Ù…',subject:'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ',sections:[],hours:6,totalAssigned:0},
    {name:'Ù…Ø¹Ù„Ù…_Ø§Ø³Ù„Ø§Ù…ÙŠ',subject:'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©',sections:[],hours:8,totalAssigned:0}
  ];

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„
  lastSections = buildSections();
  $('#showInstitution').innerText = institution.name;
  $('#showTeacher').innerText = 'Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨ â€” Ø±ÙŠØ§Ø¶ÙŠØ§Øª';
  renderTeachersUI();
  $('#diagnostic').innerText = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.';
}

/* =========== ØªÙØ±ÙŠØº =========== */
function resetAll(clearUI=true){
  teachers = [];
  institution = { name:'', levels:{1:0,2:0,3:0,4:0} };
  $('#institutionName').value='';
  $('#lvl1').value=0; $('#lvl2').value=0; $('#lvl3').value=0; $('#lvl4').value=0;
  updateTotal();
  $('#showInstitution').innerText = 'â€”';
  $('#showTeacher').innerText = 'â€”';
  $('#outputArea').innerHTML = '<p class="small text-slate-300">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.</p>';
  $('#diagnostic').innerText = 'ØªÙØ±ÙŠØº ÙƒØ§Ù…Ù„.';
  lastSchedule = null; lastSections = [];
  if(clearUI) renderTeachersUI();
}

/* =========== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ===========
   ØµÙŠØºØ©: "1Ù…1", "1Ù…2", ... Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯Ø®Ù„ */
function buildSections(){
  const arr=[];
  const l1 = parseInt($('#lvl1').value||0);
  const l2 = parseInt($('#lvl2').value||0);
  const l3 = parseInt($('#lvl3').value||0);
  const l4 = parseInt($('#lvl4').value||0);
  for(let i=1;i<=l1;i++) arr.push(`1Ù…${i}`);
  for(let i=1;i<=l2;i++) arr.push(`2Ù…${i}`);
  for(let i=1;i<=l3;i++) arr.push(`3Ù…${i}`);
  for(let i=1;i<=l4;i++) arr.push(`4Ù…${i}`);
  lastSections = arr;
  renderTeachersUI();
  return arr;
}

/* =========== Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© (ØªÙˆÙ„ÙŠØ¯) ===========
   - ØªØ­Ø§ÙˆÙ„ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
   - ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ù„ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¯Ø§Ù„Ø© score
   - ØªØ³Ù…Ø­ Ø¨Ù…Ø±ÙˆÙ†Ø©: ØªÙ‚Ø¨Ù„ Ø­Ù„ Ø¬Ø²Ø¦ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± Ø§Ù„ÙƒØ§Ù…Ù„
*/
function generateAll(forceNew=false){
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
  institution.name = $('#institutionName').value || institution.name || 'Ù…ØªÙˆØ³Ø·Ø© Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø± - ØªÙŠÙØ§Ø´';
  $('#showInstitution').innerText = institution.name;
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  const sections = buildSections();
  if(sections.length===0){ alert('Ù„Ù… ØªÙØ¹Ø±Ù‘Ù Ø£Ù‚Ø³Ø§Ù…. Ø§Ø¶ØºØ· "Ù…Ø¤Ø³Ø³ØªÙŠ" Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….'); return; }
  if(teachers.length===0){ if(confirm('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙØ§Ø±ØºØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙŠØŸ')) loadMyInstitution(); else return; }

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„ Ù‚Ø³Ù…
  const req = {};
  for(const sec of sections){
    const lvl = sec.charAt(0);
    req[sec] = {};
    for(const subj in subjectHours){
      const h = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(h>0) req[sec][subj] = h;
    }
    // ØªÙƒÙŠÙŠÙØ§Øª Ø®Ø§ØµØ©
    if(sec.startsWith('4') && req[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']) delete req[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ'];
    if(sec.startsWith('4') && !req[sec]['Ø±Ø³Ù…']) req[sec]['Ø±Ø³Ù…'] = 1;
  }

  // ÙˆØ¸ÙŠÙØ© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ù„: Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø£ÙØ¶Ù„
  function scoreSolution(schedule){
    // Ø£Ù‡Ø¯Ø§Ù: Ø£Ù‚Ù„ ÙØ±Ø§ØºØ§ØªØŒ Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØµØ¨Ø§Ø­Ù‹Ø§ (ÙˆØ®Ø§ØµØ© 4Ù…)ØŒ Ø£Ù‚Ù„ ÙØ±Ø§ØºØ§Øª Ø£Ø³Ø§ØªØ°Ø©
    let score = 0;
    let emptyCount = 0;
    let mathMorningCount = 0;
    let mathTotal = 0;
    let teacherGaps = 0;
    const teacherAssigned = {};
    for(const sec of sections){
      for(const d of DAYS){
        for(const s of SLOTS){
          const c = schedule[sec][d][s];
          if(!c){ // ÙØ±Ø§Øº
            if(!(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4)) emptyCount++;
          } else {
            // Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØµØ¨Ø§Ø­ÙŠ
            if(c.subj === 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª'){
              mathTotal++;
              const hour = parseInt(s.split(':')[0]);
              if(hour < 12) mathMorningCount++;
              if(sec.startsWith('4') && hour < 12) score += 2; // Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ø¨Ø¶Ø§Ø¹Ø© 4Ù… ÙÙŠ Ø§Ù„ØµØ¨Ø§Ø­
            }
            // Ø¹Ø¯ Ø­ØµØµ Ø§Ù„Ø£Ø³ØªØ§Ø°
            teacherAssigned[c.teacher] = (teacherAssigned[c.teacher]||0) + 1;
          }
        }
      }
    }
    // Ø­Ø³Ø§Ø¨ ÙØ±ÙˆÙ‚Ø§Øª Ø£Ø³Ø§ØªØ°Ø© (ÙØ±Ø§ØºØ§Øª/ØªÙˆØ²ÙŠØ¹): Ù†Ø¹Ø§Ù‚Ø¨ ØªÙˆØ²ÙŠØ¹ Ø³ÙŠØ¡ (ÙØ±Ø§ØºØ§Øª ÙƒØ«ÙŠØ±Ø©)
    for(const t of teachers){
      const assigned = teacherAssigned[t.name]||0;
      const gapPenalty = Math.max(0, (t.hours - assigned)); // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± Ù„Ù‡Ù… Ø­ØµØµ ÙƒØ§ÙÙŠØ© (Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø®Ø·Ø£ Ù„Ùˆ Ù„ÙŠØ³ Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¬Ø©)
      teacherGaps += gapPenalty;
      if(assigned > MAX_TEACHER) score -= 1000 * (assigned - MAX_TEACHER);
    }
    // ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ù†Ù‚Ø§Ø·
    score += -emptyCount * 1;
    score += mathMorningCount * 2;
    score += -teacherGaps * 0.5;
    // Ù…ÙƒØ§ÙØ£Ø© Ø¥Ø°Ø§ Ø§Ø³ØªÙˆÙØª ÙƒÙ„ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
    let allMet = true;
    for(const sec of sections){
      for(const subj in req[sec]){
        const need = req[sec][subj];
        let got = 0;
        for(const d of DAYS) for(const s of SLOTS) if(schedule[sec][d][s] && schedule[sec][d][s].subj===subj) got++;
        if(got < need) { allMet = false; score -= (need - got) * 5; }
      }
    }
    if(allMet) score += 2000;
    // ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ¶Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙŠ Ø§Ù„ØµØ¨Ø§Ø­ (Ù†Ø³Ø¨Ø©)
    if(mathTotal>0) score += (mathMorningCount / mathTotal) * 50;
    return {score, emptyCount, allMet};
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÙˆÙ„
  function makeSchedule(){
    const S = {};
    for(const sec of sections){
      S[sec] = {};
      for(const d of DAYS){ S[sec][d] = {}; for(const s of SLOTS) S[sec][d][s] = null; }
    }
    return S;
  }
  // Ø­Ø§Ù„Ø© Ø§Ù†Ø´ØºØ§Ù„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
  function makeBusy(){
    const busy = {};
    teachers.forEach(t=>{ busy[t.name] = {}; for(const d of DAYS){ busy[t.name][d] = {}; for(const s of SLOTS) busy[t.name][d][s]=false; } });
    return busy;
  }

  // index teachers by subject
  const teachersBySubject = {};
  for(const t of teachers) { if(!teachersBySubject[t.subject]) teachersBySubject[t.subject]=[]; teachersBySubject[t.subject].push({...t}); }

  // candidate teachers function
  function candidatesFor(subj, section, tstate){
    let list = tstate.filter(x=> x.subject === subj);
    // sort: Ø£ÙˆÙ„Ù‹Ø§ Ù…Ù† ÙŠÙ…Ù„Ùƒ Ø§Ù„Ù‚Ø³Ù… (Ù„Ùˆ Ù…Ø³Ù†Ø¯) Ø«Ù… Ø§Ù„Ø£Ù‚Ù„ Ù…Ø´ØºÙˆÙ„ÙŠØ©
    list.sort((a,b)=>{
      const aHas = a.sections && a.sections.includes(section);
      const bHas = b.sections && b.sections.includes(section);
      if(aHas && !bHas) return -1;
      if(!aHas && bHas) return 1;
      return (a.totalAssigned||0) - (b.totalAssigned||0);
    });
    return list;
  }

  // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© + backtracking
  const MAX_TRIALS = 200;
  let bestSolution = null;
  let bestScore = -Infinity;
  let bestDiagnostics = '';

  trialLoop:
  for(let trial=0; trial<MAX_TRIALS; trial++){
    // ØªØ­Ø¶ÙŠØ±
    const schedule = makeSchedule();
    const busy = makeBusy();
    const tstate = teachers.map(t => ({...t, totalAssigned:0}));
    // Ù†ÙˆØ²Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ù„ÙˆÙ„
    const classOrder = shuffle(sections.slice());

    let failed = false;

    // Ù„ÙƒÙ„ Ù‚Ø³Ù… Ù†Ø­Ø§ÙˆÙ„ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬ÙŠØ§Øª
    for(const sec of classOrder){
      const lvl = sec.charAt(0);
      // Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡Ø§ ÙˆØªØµÙ†ÙŠÙÙ‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø£ÙƒØ«Ø± Ø­Ø§Ø¬Ø© Ø£ÙˆÙ„Ø§Ù‹)
      const subjList = Object.keys(req[sec]).sort((a,b)=> (req[sec][b] - req[sec][a]));

      // recursive place for subject index
      function placeSubjects(index){
        if(index >= subjList.length) return true;
        const subj = subjList[index];
        const need = req[sec][subj];
        // build candidate slots list with preference: Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØµØ¨Ø§Ø­Ù‹Ø§
        const slotCandidates = [];
        for(const d of DAYS){
          if(pedagogicalDays[subj] && pedagogicalDays[subj] === d) continue;
          // order of slots: if subj math => morning preferred
          const orderSlots = (subj === 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª') ? ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00'] : SLOTS.slice();
          for(const s of orderSlots){
            if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s) >= 4) continue; // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ Ù†ØµÙ ÙŠÙˆÙ… (Ø¨Ø¹Ø¯ 12:00 Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù„Ø§ Ø¯ÙˆØ§Ù…)
            if(s === BREAK) continue;
            slotCandidates.push({d,s});
          }
        }
        shuffle(slotCandidates);

        // need to choose 'need' slots
        const chosen = [];
        function placeK(k){
          if(k >= need) return true;
          for(const ds of slotCandidates){
            const {d,s} = ds;
            // if class already has something at day/slot skip
            if(schedule[sec][d][s]) continue;
            // don't put more than 2 Ù†ÙØ³ Ø§Ù„Ù…Ø§Ø¯Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù…
            const sameDayCount = SLOTS.reduce((acc,sl)=> acc + (schedule[sec][d][sl] && schedule[sec][d][sl].subj===subj ? 1:0), 0);
            if(sameDayCount >= 2) continue;
            // candidate teachers
            const candList = candidatesFor(subj, sec, tstate);
            shuffle(candList);
            for(const cand of candList){
              if(!cand) continue;
              if(cand.totalAssigned >= cand.hours) continue; // Ù„Ø§ Ù†Ø¹Ø·ÙŠÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹Ø§Øª Ù…Ø¹ÙŠÙ†Ù‡ Ø·Ù„Ø¨Ù‡Ø§
              if(cand.totalAssigned >= MAX_TEACHER) continue; // Ù„Ø§ Ù†ØªØ¬Ø§ÙˆØ² 20
              if(busy[cand.name][d][s]) continue;
              // also avoid teacher teaching same class in another place same slot (handled by busy)
              // assign
              schedule[sec][d][s] = { subj, teacher: cand.name, type: 'official' };
              cand.totalAssigned++;
              busy[cand.name][d][s] = true;
              chosen.push({d,s,candName:cand.name});
              if(placeK(k+1)) return true;
              // backtrack
              const r = chosen.pop();
              schedule[sec][r.d][r.s] = null;
              const tt = tstate.find(x=> x.name===r.candName); if(tt) tt.totalAssigned--;
              busy[r.candName][r.d][r.s] = false;
            }
          }
          return false;
        }

        const ok = placeK(0);
        if(!ok) return false;
        return placeSubjects(index+1);
      }

      const okSec = placeSubjects(0);
      if(!okSec){ failed = true; break; }
    } // end for each section

    // if not failed, evaluate
    if(!failed){
      const res = scoreSolution(schedule);
      if(res.score > bestScore){
        bestScore = res.score;
        bestSolution = deepClone(schedule);
        bestDiagnostics = `ØªØ¬Ø±Ø¨Ø© ${trial+1}: Ù†Ù‚Ø§Ø· ${res.score.toFixed(2)} â€” ÙØ±Ø§ØºØ§Øª ${res.emptyCount} â€” ÙƒØ§Ù…Ù„:${res.allMet}`;
      }
      if(res.allMet){ // Ø­Ù„ ÙƒØ§Ù…Ù„ ÙˆØ¬ÙŠØ¯ -> Ù†ÙˆÙ‚Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
        bestDiagnostics = `Ù†Ø¬Ø­ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„ØªØ¬Ø±Ø¨Ø© ${trial+1} â€” Ù†Ù‚Ø§Ø· ${res.score.toFixed(2)}.`;
        break trialLoop;
      }
    } else {
      // failed trial: Ù†Ø³ØªÙ…Ø±
    }
  } // end trials

  if(!bestSolution){
    $('#diagnostic').innerText = 'ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„ÙˆÙ„ Ù…Ù…ÙƒÙ†Ø©. Ø­Ø§ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©/Ø§Ù„Ø³Ø§Ø¹Ø§Øª).';
    $('#outputArea').innerHTML = `<p class="small text-amber-200">ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„ÙˆÙ„ Ù…Ù…ÙƒÙ†Ø©.</p>`;
    return;
  }

  // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø­Ù„ Ø£ÙØ¶Ù„ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¬Ø²Ø¦ÙŠ) Ù†Ø¹Ø±Ø¶Ù‡
  lastSchedule = bestSolution;
  // Ø­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© (ÙƒØ§Ù…Ù„/Ø¬Ø²Ø¦ÙŠ)
  const finalScore = scoreSolution(bestSolution);
  const statusText = finalScore.allMet ? 'âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ ÙƒØ§Ù…Ù„ Ù…ØªÙˆØ§ÙÙ‚' : 'âš ï¸ ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ø¬Ø²Ø¦ÙŠ â€” Ù„Ù… ØªÙÙ„Ø¨Ù‘Ù ÙƒÙ„ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§ØªØŒ Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø­Ù„ Ù…Ù…ÙƒÙ†';
  $('#diagnostic').innerText = `${statusText} â€” ${bestDiagnostics || ''}`;
  // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù†Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  showInstitutionTable();
}

/* =========== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ =========== */
function showInstitutionTable(){
  currentView = 'institution';
  if(!lastSchedule){ $('#outputArea').innerHTML = `<p class="small text-slate-300">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯.</p>`; return; }
  const sections = lastSections.slice();
  const out = $('#outputArea'); out.innerHTML = '';
  // Ø¹Ù†ÙˆØ§Ù†
  const h = document.createElement('div'); h.innerHTML = `<h2 class="text-xl text-indigo-300 font-semibold">${$('#institutionName').value || 'Ø§Ù„Ù…Ø¤Ø³Ø³Ø©'}</h2><div class="small mt-1">Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø´Ø§Ù…Ù„ â€” Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${sections.join(', ')}</div>`; out.appendChild(h);

  // Ù„ÙƒÙ„ ÙŠÙˆÙ… Ù†Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„
  for(const d of DAYS){
    const title = document.createElement('h3'); title.className='text-lg text-indigo-200 mt-4'; title.textContent = d; out.appendChild(title);
    const wrap = document.createElement('div'); wrap.className='overflow-auto';
    let html = `<table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
    sections.forEach(sec => html += `<th class="slot">${sec}</th>`);
    html += `</tr></thead><tbody>`;
    for(const s of SLOTS){
      html += `<tr><td>${s}</td>`;
      for(const sec of sections){
        const cell = lastSchedule[sec] && lastSchedule[sec][d] ? lastSchedule[sec][d][s] : null;
        if(cell) html += `<td contenteditable="true" class="editable official">${cell.subj}<br/><small>${cell.teacher}</small></td>`;
        else {
          if(s==='13:00-14:00') html += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
          else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4) html += `<td contenteditable="true" class="free">â€”</td>`;
          else html += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</tbody></table>`;
    wrap.innerHTML = html; out.appendChild(wrap);
  }
  // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ØªØµØ¯ÙŠØ±
  const footer = document.createElement('div'); footer.className='mt-3 small'; footer.innerHTML = `<div class="mt-2 small">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø®Ù„ÙŠØ© Ø«Ù… Ø§Ù„ØªØµØ¯ÙŠØ±.</div>`; out.appendChild(footer);
}

function showTeacherTable(teacherName){
  currentView = 'teacher';
  if(!teacherName){ alert('Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'); return; }
  const sections = lastSections.slice();
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø° ${teacherName}</h2>`;
  // Ù†Ø¬Ù‡Ø² Ø¬Ø¯ÙˆÙ„: ØµÙÙˆÙ Ø§Ù„Ø³Ø§Ø¹Ø§ØªØŒ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£ÙŠØ§Ù…
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const s of SLOTS){
    html += `<tr><td>${s}</td>`;
    for(const d of DAYS){
      // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ÙŠØ¯Ø±Ù‘Ø³ Ø§Ù„Ø£Ø³ØªØ§Ø° ÙÙŠÙ‡ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø³Ø§Ø¹Ø©
      let found = null;
      for(const sec of sections){
        const cell = lastSchedule[sec][d][s];
        if(cell && cell.teacher === teacherName){ found = {sec, subj:cell.subj}; break; }
      }
      if(found) html += `<td contenteditable="true" class="editable official">${found.sec}<br/><small>${found.subj}</small></td>`;
      else {
        if(s==='13:00-14:00') html += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
        else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4) html += `<td contenteditable="true" class="free">â€”</td>`;
        else html += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend',html);
}

function showClassTable(section){
  currentView = 'class';
  if(!section){ alert('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
  if(!lastSchedule){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„. Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'); return; }
  const out = $('#outputArea'); out.innerHTML = `<h2 class="text-xl text-indigo-300">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø³Ù… ${section}</h2>`;
  let html = `<div class="overflow-auto"><table class="w-full bg-white text-black schedule-table"><thead><tr><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>`;
  DAYS.forEach(d=> html += `<th>${d}</th>`); html += `</tr></thead><tbody>`;
  for(const s of SLOTS){
    html += `<tr><td>${s}</td>`;
    for(const d of DAYS){
      const cell = lastSchedule[section][d][s];
      if(cell) html += `<td contenteditable="true" class="editable official">${cell.subj}<br/><small>${cell.teacher}</small></td>`;
      else {
        if(s==='13:00-14:00') html += `<td contenteditable="true" class="break">Ø±Ø§Ø­Ø©</td>`;
        else if(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4) html += `<td contenteditable="true" class="free">â€”</td>`;
        else html += `<td contenteditable="true" class="free">ÙØ±Ø§Øº</td>`;
      }
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  out.insertAdjacentHTML('beforeend',html);
}

/* =========== ØªØµØ¯ÙŠØ± / Ù†Ø³Ø® =========== */
function copyHTML(){ const html = $('#outputArea').innerHTML; navigator.clipboard.writeText(html).then(()=> alert('Ù†ÙØ³Ø® HTML')); }

function exportCSV(){
  const out = $('#outputArea');
  if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  // Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ ØµÙØ­Ø© ÙˆÙ†Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ CSV Ø¨Ø®Ø· Ø¨Ø³ÙŠØ·
  const tables = out.querySelectorAll('table');
  let csv = '';
  tables.forEach((table, idx) => {
    const caption = table.previousElementSibling ? table.previousElementSibling.innerText.replace(/\n/g,' ') : `Table ${idx+1}`;
    csv += `"${caption}"\n`;
    for(const row of table.rows){
      const cells = Array.from(row.cells).map(c => '"' + c.innerText.replace(/"/g,'""').replace(/\n/g,' / ') + '"');
      csv += cells.join(',') + '\n';
    }
    csv += '\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='schedules.csv'; a.click();
  URL.revokeObjectURL(a.href);
}

function exportWord(){
  const out = $('#outputArea');
  if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  const html = '<html><head><meta charset="utf-8"></head><body dir="rtl">' + out.innerHTML + '</body></html>';
  const blob = new Blob(['\ufeff', html], {type:'application/msword'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='schedules.doc'; a.click();
  URL.revokeObjectURL(a.href);
}

async function exportPDF(){
  const out = $('#outputArea');
  if(!out.innerHTML.trim()){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  if(typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
  if(typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  const canvas = await html2canvas(out, {scale:1.2, useCORS:true, backgroundColor:'#04102a'});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf || window.jspdf;
  const pdf = new jsPDF('l','mm','a4');
  const w = pdf.internal.pageSize.getWidth();
  const h = (canvas.height * w) / canvas.width;
  pdf.addImage(imgData,'PNG',0,0,w,h);
  pdf.save('schedules.pdf');
}

function loadScript(src){ return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }

/* =========== Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: ÙˆØ¸ÙŠÙØ© scoreSolution (Ù„Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø£ÙŠØ¶Ø§ Ø®Ø§Ø±Ø¬) =========== */
function scoreSolution(schedule){
  // Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (Ù„ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù„)
  let score = 0; let emptyCount = 0; let mathMorning=0; let mathTotal=0;
  const teacherAssigned = {};
  for(const sec of lastSections){
    for(const d of DAYS){
      for(const s of SLOTS){
        const c = schedule[sec][d][s];
        if(!c){
          if(!(d==='Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' && SLOTS.indexOf(s)>=4)) emptyCount++;
        } else {
          if(c.subj==='Ø±ÙŠØ§Ø¶ÙŠØ§Øª'){ mathTotal++; const hour=parseInt(s.split(':')[0]); if(hour<12) mathMorning++; if(sec.startsWith('4') && hour<12) score+=2; }
          teacherAssigned[c.teacher] = (teacherAssigned[c.teacher]||0)+1;
        }
      }
    }
  }
  let teacherGaps=0;
  for(const t of teachers){ const assigned = teacherAssigned[t.name]||0; const gap=Math.max(0, (t.hours - assigned)); teacherGaps += gap; if(assigned>MAX_TEACHER) score -= 1000*(assigned-MAX_TEACHER); }
  score += -emptyCount*1 + mathMorning*2 - teacherGaps*0.5;
  let allMet=true;
  for(const sec of lastSections){
    for(const subj in subjectHours){
      const lvl = sec.charAt(0);
      const need = subjectHours[subj] && subjectHours[subj][lvl] ? subjectHours[subj][lvl] : 0;
      if(lvl==='4' && subj==='Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ') continue;
      if(need>0){
        let got=0;
        for(const d of DAYS) for(const s of SLOTS) if(schedule[sec][d][s] && schedule[sec][d][s].subj===subj) got++;
        if(got < need){ allMet=false; score -= (need-got)*5; }
      }
    }
  }
  if(allMet) score+=2000;
  if(mathTotal>0) score += (mathMorning/mathTotal)*50;
  return {score, emptyCount, allMet};
}

/* =========== Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© =========== */
updateTotal();
renderTeachersUI();

/* ====== ØªØ¹Ø±ÙŠØ¶ ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø¤Ø³Ø³ØªÙŠØŒ Ø³ÙŠØ­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙƒ (Ù†Ù…ÙˆØ°Ø¬ÙŠØ©)Ø› ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§ ====== */

/* Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª Ø¥Ø¶Ø§ÙØ© ÙˆØ¸Ø§Ø¦Ù Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„Ø£Ø³Ø§ØªØ°Ø© Ø£Ùˆ Ø±ÙØ¹ ÙˆØ§Ø¬Ù‡Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ø£Ø®Ø¨Ø±Ù†ÙŠ ÙˆØ³Ø£Ø¶ÙŠÙÙ‡Ø§. */
</script>
</body>
</html>
